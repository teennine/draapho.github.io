<!doctype html>




<html class="theme-next mist">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="Embedded System, IoT, M2M">
<meta property="og:type" content="website">
<meta property="og:title" content="DRA&amp;PHO">
<meta property="og:url" content="https://draapho.github.io/page/3/index.html">
<meta property="og:site_name" content="DRA&amp;PHO">
<meta property="og:description" content="Embedded System, IoT, M2M">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DRA&amp;PHO">
<meta name="twitter:description" content="Embedded System, IoT, M2M">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="https://draapho.github.io/page/3/"/>


  <title> DRA&PHO </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">DRA&PHO</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">thinking & logging</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/07/1816-interview-c/" itemprop="url">
                  面试之嵌入式C语言
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2018-05-07T00:00:00+10:00" content="2018-05-07">
              2018-05-07
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><ul>
<li><a href="https://draapho.github.io/2017/05/04/1714-expression/">逻辑|这样表达，事半功倍</a></li>
<li><a href="https://draapho.github.io/2018/01/10/1805-interview-general/">面试之常规问题</a></li>
<li><a href="https://draapho.github.io/2018/05/07/1816-interview-c/">面试之嵌入式C语言</a></li>
<li><a href="https://draapho.github.io/2017/05/17/1715-c/">C语言知识巩固</a></li>
<li><a href="https://draapho.github.io/2018/05/08/1817-interview-linux/">面试之嵌入式Linux</a></li>
</ul>
<p>我个人面试经验极少, 但这种能力都是需要培养的.<br>此系列总结一下面试中常见的技能要点. 侧重于技术面的准备.</p>
<h1 id="Q1-define"><a href="#Q1-define" class="headerlink" title="Q1: #define"></a>Q1: #define</h1><p>Using the #define statement, how would you declare a manifest constant that returns the number of seconds in a year? Disregard leap years in your answer.</p>
<p>A1:<br><code>#define SECONDS_PER_YEAR (60UL * 60UL * 24UL * 365UL)</code></p>
<p>I’m looking for several things here:</p>
<ul>
<li>Basic knowledge of the #define syntax (i.e. no semi-colon at the end, the need to parenthesize etc.).</li>
<li>A good choice of name, with capitalization and underscores.</li>
<li>An understanding that the pre-processor will evaluate constant expressions for you. Thus, it is clearer, and penalty free to spell out how you are calculating the number of seconds in a year, rather than actually doing the calculation yourself.</li>
<li>A realization that the expression will oveflow an integer argument on a 16 bit machine hence the need for the L, telling the compiler to treat the expression as a Long.</li>
<li>As a bonus, if you modified the expression with a UL (indicating unsigned long), then you are off to a great start because you are showing that you are mindful of the perils of signed and unsigned types and remember, first impressions count!</li>
</ul>
<h1 id="Q2-define"><a href="#Q2-define" class="headerlink" title="Q2: #define"></a>Q2: #define</h1><p>Write the “standard” MIN macro. That is, a macro that takes two arguments and returns the smaller of the two arguments.</p>
<p>A2:<br><code>#define MIN(A,B) ( (A) &lt;= (B) ? (A) : (B) )</code></p>
<p>The purpose of this question is to test the following:</p>
<ul>
<li>Basic knowledge of the #define directive as used in macros. This is important, because until the inline operator becomes part of standard C, macros are the only portable way of generating inline code. Inline code is often necessary in embedded systems in order to achieve the required performance level.</li>
<li>Knowledge of the ternary conditional operator. This exists in C because it allows the compiler to potentially produce more optimal code than an ifthen-else sequence. Given that performance is normally an issue in embedded systems, knowledge and use of this construct is important.</li>
<li>Understanding of the need to very carefully parenthesize arguments to macros.</li>
<li>I also use this question to start a discussion on the side effects of macros, e.g. what happens when you write code such as : <code>least = MIN(*p++, b);</code></li>
</ul>
<h1 id="Q3-error"><a href="#Q3-error" class="headerlink" title="Q3: #error"></a>Q3: #error</h1><p>What is the purpose of the preprocessor directive #error?</p>
<p>A3:<br>Either you know the answer to this, or you don’t. If you don’t, then see reference.<br>This question is very useful for dierentiating between normal folks and the nerds. It’s only the nerds that actually read the appendices of C textbooks that find out about such things. Of course, if you aren’t looking for a nerd, the candidate better hope she doesn’t know the answer.</p>
<h1 id="Q4-Infinite-loops"><a href="#Q4-Infinite-loops" class="headerlink" title="Q4: Infinite loops"></a>Q4: Infinite loops</h1><p>Infinite loops often arise in embedded systems. How does one code an infinite loop in C?</p>
<p>A4:<br>There are several solutions to this question. My preferred solution is:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> ) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Another common construct is:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( ; ; ) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Personally, I dislike this construct because the syntax doesn’t exactly spell out what is going on. Thus, if a candidate gives this as a solution, I’ll use it as an opportunity to explore their rationale for doing so. If their answer is basically “I was taught to do it this way and I have never thought about it since” then it tells me something (bad) about them. Conversely, if they state that it’s the K&amp;R preferred method and the only way to get an infinite loop passed Lint, then they score bonus points.</p>
<p>A third solution is to use a goto:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Loop :</span><br><span class="line">. . .</span><br><span class="line"><span class="keyword">goto</span> Loop ;</span><br></pre></td></tr></table></figure></p>
<p>Candidates that propose this are either assembly language programmers (which is probably good), or else they are closet BASIC / FORTRAN programmers looking to get into a new field.</p>
<h1 id="Q5-Data-declarations"><a href="#Q5-Data-declarations" class="headerlink" title="Q5: Data declarations"></a>Q5: Data declarations</h1><p>Using the variable a, write down definitions for the following:<br>a) An integer<br>b) A pointer to an integer<br>c) A pointer to a pointer to an integer<br>d) An array of ten integers<br>e) An array of ten pointers to integers<br>f) A pointer to an array of ten integers<br>g) A pointer to a function that takes an integer as an argument and returns an integer<br>h) An array of ten pointers to functions that take an integer argument and return an integer</p>
<p>A5:<br>The answers are:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a;          <span class="comment">// An integer</span></span><br><span class="line"><span class="keyword">int</span> *a;         <span class="comment">// A pointer to an integer</span></span><br><span class="line"><span class="keyword">int</span> **a;        <span class="comment">// A pointer to a pointer to an integer</span></span><br><span class="line"><span class="keyword">int</span> a[<span class="number">10</span>];      <span class="comment">// An array of ten integers</span></span><br><span class="line"><span class="keyword">int</span> *a[<span class="number">10</span>];     <span class="comment">// An array of ten pointers to integers</span></span><br><span class="line"><span class="keyword">int</span> (*a)[<span class="number">10</span>];   <span class="comment">// A pointer to an array of ten integers</span></span><br><span class="line"><span class="keyword">int</span> (*a)(<span class="keyword">int</span>);  <span class="comment">// A pointer to a function that takes an integer as an argument and returns an integer</span></span><br><span class="line"><span class="keyword">int</span> (*a[<span class="number">10</span>])(<span class="keyword">int</span>); <span class="comment">// An array of ten pointers to functions that take an integer argument and return an integer</span></span><br></pre></td></tr></table></figure></p>
<p>People often claim that a couple of these are the sorts of thing that one looks up in textbooks and I agree. While writing this article, I consulted textbooks to ensure the syntax was correct. However, I expect to be asked this question (or something close to it) when in an interview situation. Consequently, I make sure I know the answers at least for the few hours of the interview. Candidates that don’t know the answers (or at least most of them) are simply unprepared for the interview. If they can’t be prepared for the interview, what will they be prepared for?</p>
<h1 id="Q6-Static"><a href="#Q6-Static" class="headerlink" title="Q6: Static"></a>Q6: Static</h1><p>What are the uses of the keyword static?</p>
<p>A6:<br>This simple question is rarely answered completely. Static has three distinct uses in C:</p>
<ul>
<li>A variable declared static within the body of a function maintains its value between function invocations.</li>
<li>A variable declared static within a module1, (but outside the body of a function) is accessible by all functions within that module. It is not accessible by functions within any other module. That is, it is a localized global.</li>
<li>Functions declared static within a module may only be called by otherfunctions within that module. That is, the scope of the function is localized to the module within which it is declared.</li>
</ul>
<p>Most candidates get the first part correct. A reasonable number get the second part correct, while a pitiful number understand the third answer. This is a serious weakness in a candidate, since they obviously do not understand the importance and benefits of localizing the scope of both data and code.</p>
<h1 id="Q7-Const"><a href="#Q7-Const" class="headerlink" title="Q7: Const"></a>Q7: Const</h1><p>What does the keyword const mean?</p>
<p>A7:<br>As soon as the interviewee says “const means constant”, I know I’m dealing with an amateur. Dan Saks has exhaustively covered const in the last year, such that every reader of ESP should be extremely familiar with what const can and cannot do for you. If you haven’t been reading that column, suffice it to say that const means “read-only”. Although this answer doesn’t really do the subject justice, I’d accept it as a correct answer. (If you want the detailed answer, then read Saks’ columns carefully!).</p>
<p>If the candidate gets the answer correct, then I’ll ask him these supplemental questions:</p>
<h1 id="Q7-1-Const"><a href="#Q7-1-Const" class="headerlink" title="Q7.1: Const"></a>Q7.1: Const</h1><p>What do the following incomplete declarations mean?<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const int a ;</span><br><span class="line">int const a ;</span><br><span class="line">const int *a ;</span><br><span class="line">int * const a ;</span><br><span class="line">int const *a const ;</span><br></pre></td></tr></table></figure></p>
<p>A7.1:<br>The first two mean the same thing, namely a is a const (read-only) integer.<br>The third means a is a pointer to a const integer (i.e., the integer isn’t modifiable, but the pointer is).<br>The fourth declares a to be a const pointer to an integer (i.e., the integer pointed to by a is modifiable, but the pointer is not).<br>The final declaration declares a to be a const pointer to a const integer (i.e., neither the integer pointed to by a, nor the pointer itself may be modified).</p>
<p>If the candidate correctly answers these questions, I’ll be impressed. Incidentally, one might wonder why I put so much emphasis on const, since it is very easy to write a correctly functioning program without ever using it. There are several reasons:</p>
<ul>
<li>The use of const conveys some very useful information to someone reading your code. In effect, declaring a parameter const tells the user about its intended usage. If you spend a lot of time cleaning up the mess left by other people, then you’ll quickly learn to appreciate this extra piece of information. (Of course, programmers that use const, rarely leave a mess for others to clean up…)</li>
<li>const has the potential for generating tighter code by giving the optimizer some additional information.</li>
<li>Code that uses const liberally is inherently protected by the compiler against inadvertent coding constructs that result in parameters being changed that should not be. In short, they tend to have fewer bugs.</li>
</ul>
<h1 id="Q8-Volatile"><a href="#Q8-Volatile" class="headerlink" title="Q8: Volatile"></a>Q8: Volatile</h1><p>What does the keyword volatile mean? Give three different examples of its use.</p>
<p>A8:<br>A volatile variable is one that can change unexpectedly. Consequently, the compiler can make no assumptions about the value of the variable. In particular, the optimizer must be careful to reload the variable every time it is used instead of holding a copy in a register. Examples of volatile variables are:</p>
<ul>
<li>Hardware registers in peripherals (e.g., status registers)</li>
<li>Non-stack variables referenced within an interrupt service routine.</li>
<li>Variables shared by multiple tasks in a multi-threaded application.</li>
</ul>
<p>If a candidate does not know the answer to this question, they aren’t hired. I consider this the most fundamental question that distinguishes between a ‘C programmer’ and an ‘embedded systems programmer’. Embedded folks deal with hardware, interrupts, RTOSes, and the like. All of these require volatile variables. Failure to understand the concept of volatile will lead to disaster. On the (dubious) assumption that the interviewee gets this question correct, I like to probe a little deeper, to see if they really understand the full significance of volatile. In particular, I’ll ask them the following:</p>
<h1 id="Q8-1-Volatile"><a href="#Q8-1-Volatile" class="headerlink" title="Q8.1: Volatile"></a>Q8.1: Volatile</h1><ul>
<li>Can a parameter be both const and volatile? Explain your answer.</li>
<li>Can a pointer be volatile? Explain your answer.</li>
<li>What is wrong with the following function?:</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">square</span> <span class="params">(<span class="keyword">volatile</span> <span class="keyword">int</span> *ptr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *ptr * *ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>A8.1:<br>The answers are as follows:</p>
<ul>
<li>Yes. An example is a read only status register. It is volatile because it can change unexpectedly. It is const because the program should not attempt to modify it.</li>
<li>Yes. Although this is not very common. An example is when an interrupt service routine modifses a pointer to a buffer.</li>
<li>This one is wicked. The intent of the code is to return the square of the value pointed to by <code>*ptr</code>. However, since <code>*ptr</code>points to a volatile parameter, the compiler will generate code that looks something like this:</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">square</span> <span class="params">( <span class="keyword">volatile</span> <span class="keyword">int</span> *ptr )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a, b;</span><br><span class="line">    a = *ptr ;</span><br><span class="line">    b = *ptr ;</span><br><span class="line">    <span class="keyword">return</span> a * b ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Since it is possible for the value of <code>*ptr</code> to change unexpectedly, it is possible for a and b to be different. Consequently, this code could return a number that is not a square! The correct way to code this is:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">square</span> <span class="params">( <span class="keyword">volatile</span> <span class="keyword">int</span> *ptr )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a;</span><br><span class="line">    a = *ptr;</span><br><span class="line">    <span class="keyword">return</span> a * a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Q9-Bit-Manipulation"><a href="#Q9-Bit-Manipulation" class="headerlink" title="Q9: Bit Manipulation"></a>Q9: Bit Manipulation</h1><p>Embedded systems always require the user to manipulate bits in registers or variables. Given an integer variable a, write two code fragments. The first should set bit 3 of a. The second should clear bit 3 of a. In both cases, the remaining<br>bits should be unmodified.</p>
<p>A9:<br>These are the three basic responses to this question:</p>
<ul>
<li>No idea. The interviewee cannot have done any embedded systems work.</li>
<li>Use bit fields. Bit fields are right up there with trigraphs as the most braindead portion of C. Bit fields are inherently non-portable across compilers, and as such guarantee that your code is not reusable. I recently had the misfortune to look at a driver written by Infineon for one of their more complex communications chip. It used bit fields, and was completely useless because my compiler implemented the bit fields the other way around. The moral never let a non-embedded person anywhere near a real piece of hardware!</li>
<li>Use #defines and bit masks. This is a highly portable method, and is the one that should be used. My optimal solution to this problem would be:</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BIT3 (0x1&lt;&lt;3)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> a;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_bit3</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    a |= BIT3 ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clear_bit3</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    a &amp;= ~BIT3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Some people prefer to define a mask, together with manifest constants for the set and clear values. This is also acceptable. The important elements that I’m looking for are the use of manifest constants, together with the <code>|=</code> and <code>&amp;=</code> constructs.</p>
<h1 id="Q10-Accessing-fixed-memory-locations"><a href="#Q10-Accessing-fixed-memory-locations" class="headerlink" title="Q10: Accessing fixed memory locations"></a>Q10: Accessing fixed memory locations</h1><p>Embedded systems are often characterized by requiring the programmer to access a specific memory location. On a certain project it is required to set an integer variable at the absolute address 0x67a9 to the value 0xaa55. The compiler is a pure ANSI compiler. Write code to accomplish this task.</p>
<p>A10:<br>This problem tests whether you know that it is legal to typecast an integer to a pointer in order to access an absolute location. The exact syntax varies depending upon one’s style. However, I would typically be looking<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// for something like this:</span></span><br><span class="line"><span class="keyword">int</span> *ptr;</span><br><span class="line">ptr = (<span class="keyword">int</span> *)<span class="number">0x67a9</span> ;</span><br><span class="line">*ptr = <span class="number">0xaa55</span> ;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A more obfuscated approach is:</span></span><br><span class="line">*(<span class="keyword">int</span> * <span class="keyword">const</span>)(<span class="number">0x67a9</span>) = <span class="number">0xaa55</span>;</span><br></pre></td></tr></table></figure></p>
<p>Even if your taste runs more to the second solution, I suggest the first solution when you are in an interview situation.</p>
<h1 id="Q11-Interrupts"><a href="#Q11-Interrupts" class="headerlink" title="Q11: Interrupts"></a>Q11: Interrupts</h1><p>Interrupts are an important part of embedded systems. Consequently, many compiler vendors offer an extension to standard C to support interrupts. Typically, this new key word is <code>__interrupt</code>. The following code uses <code>__interrupt</code> to define an interrupt service routine. Comment on the code.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">interrupt <span class="keyword">double</span> <span class="title">compute_area</span><span class="params">(<span class="keyword">double</span> radius)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> ar ea = PI * radius * radius;</span><br><span class="line">    print (<span class="string">"\nArea = %f"</span>, area ) ;</span><br><span class="line">    <span class="keyword">return</span> area ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>A11:<br>This function has so much wrong with it, it’s almost tough to know where to start.</p>
<ul>
<li>Interrupt service routines cannot return a value. If you don’t understand this, then you aren’t hired.</li>
<li>ISR’s cannot be passed parameters. See first item for your employment prospects if you missed this.</li>
<li>On many processors/compilers, floating point operations are not necessarily re-entrant. In some cases one needs to stack additional registers, in other cases, one simply cannot do floating point in an ISR. Furthermore, given that a general rule of thumb is that ISRs should be short and sweet, one wonders about the wisdom of doing floating point math here.</li>
<li>In a similar vein to third point, printf() often has problems with reentrancy and performance.<br>If you missed last two points then I wouldn’t be too hard on you. Needless to say, if you got these two points, then your employment prospects are looking better and better.</li>
</ul>
<h1 id="Q12-Code-Examples"><a href="#Q12-Code-Examples" class="headerlink" title="Q12: Code Examples"></a>Q12: Code Examples</h1><p>What does the following code output and why?<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void foo (void) &#123;</span><br><span class="line">    unsigned int a = 6;</span><br><span class="line">    int b = -20;</span><br><span class="line">    (a+b &gt; 6) ? puts (&quot;&gt;6&quot;) : puts(&quot;&lt;=6&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>A12:<br>This question tests whether you understand the integer promotion rules in C an area that I find is very poorly understood by many developers. Anyway, the answer is that this outputs <code>&gt;6</code>. The reason for this is that expressions involving signed and unsigned types have all operands promoted to unsigned types. Thus <code>-20</code> becomes a very large positive integer and the expression evaluates to greater than 6. This is a very important point in embedded systems where unsigned data types should be used frequently. If you get this one wrong, then you are perilously close to not being hired.</p>
<h1 id="Q13-Code-Examples"><a href="#Q13-Code-Examples" class="headerlink" title="Q13: Code Examples"></a>Q13: Code Examples</h1><p>Comment on the following code fragment?<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsigned int zero = 0;</span><br><span class="line">unsigned int compzero = 0xFFFF; /* 1&apos;s complement of zero */</span><br></pre></td></tr></table></figure></p>
<p>A13:<br>On machines where an int is not 16 bits, this will be incorrect. It should be coded:<br><code>unsigned int compzero = ~0;</code></p>
<p>This question really gets to whether the candidate understands the importance of word length on a computer. In my experience, good embedded programmers are critically aware of the underlying hardware and its limitations, whereas computer programmers tend to dismiss the hardware as a necessary annoyance.</p>
<p>By this stage, candidates are either completely demoralized or they are on a roll and having a good time. If it is obvious that the candidate isn’t very good, then the test is terminated at this point. However, if the candidate is doing well, then I throw in these supplemental questions. These questions are hard, and I expect that only the very best candidates will do well on them. In posing these questions, I’m looking more at the way the candidate tackles the problems, rather than the answers. Anyway, have fun…</p>
<h1 id="Q14-Dynamic-memory-allocation"><a href="#Q14-Dynamic-memory-allocation" class="headerlink" title="Q14: Dynamic memory allocation"></a>Q14: Dynamic memory allocation</h1><p>Although not as common as in non-embedded computers, embedded systems still do dynamically allocate memory from the heap. What are the problems with dynamic memory allocation in embedded systems?</p>
<p>A14:<br>Here, I expect the user to mention memory fragmentation, problems with garbage collection, variable execution time, etc. This topic has been covered extensively in ESP, mainly by Plauger. His explanations are far more insightful than anything I could offer here, so go and read those back issues! Having lulled the candidate into a sense of false security, I then offer up this tidbit: What does the following code fragment output and why?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *ptr;</span><br><span class="line"><span class="keyword">if</span> (( ptr=(<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0</span>)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Got a null pointer"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Got a valid pointer"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This is a fun question. I stumbled across this only recently, when a colleague of mine inadvertently passed a value of 0 to malloc, and got back a valid pointer! After doing some digging, I discovered that the result of malloc(0) is implementation defined, so that the correct answer is “it depends”. I use this to start a discussion on what the interviewee thinks is the correct thing for malloc to do. Getting the right answer here is nowhere near as important as the way you approach the problem and the rationale for your decision.</p>
<h1 id="Q15-Typedef"><a href="#Q15-Typedef" class="headerlink" title="Q15: Typedef"></a>Q15: Typedef</h1><p>Typedef is frequently used in C to declare synonyms for pre-existing data types.<br>It is also possible to use the preprocessor to do something similar. For instance,<br>consider the following code fragment:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> dPS struct s *</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">s</span> * <span class="title">tPS</span>;</span></span><br></pre></td></tr></table></figure>
<p>The intent in both cases is to define dPS and tPS to be pointers to structure s. Which method (if any) is preferred and why?</p>
<p>A15:<br>This is a very subtle question, and anyone that gets it right (for the right reason) is to be congratulated or condemned (“get a life” springs to mind). The answer is the typedef is preferred. Consider the declarations:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dPS p1, p2;</span><br><span class="line">tPS p3, p4;</span><br></pre></td></tr></table></figure>
<p>The first expands to <code>struct s *p1 , p2</code> which defines p1 to be a pointer to the structure and p2 to be an actual structure, which is probably not what you wanted. The second example correctly defines p3 and p4 to be pointers.</p>
<h1 id="Q16-Obfuscated-syntax"><a href="#Q16-Obfuscated-syntax" class="headerlink" title="Q16: Obfuscated syntax"></a>Q16: Obfuscated syntax</h1><p>C allows some appalling constructs. Is this construct legal, and if so what does this code do?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a=<span class="number">5</span>, b=<span class="number">7</span>, c;</span><br><span class="line">c = a+++b ;</span><br></pre></td></tr></table></figure>
<p>A16:<br>This question is intended to be a lighthearted end to the quiz, as, believe it or not, this is perfectly legal syntax. The question is how does the compiler treat it? Those poor compiler writers actually debated this issue, and came up with the “maximum munch” rule, which stipulates that the compiler should bite off as big a (legal) chunk as it can. Hence, this code is treated as:<br>    <code>c = a++ + b;</code></p>
<p>Thus, after this code is executed, a = 6, b = 7 and c = 12; If you knew the answer, or guessed correctly then well done. If you didn’t know the answer then I would not consider this to be a problem. I find the biggest benefit of this question is that it is very good for stimulating questions on coding styles, the value of code reviews and the benefits of using lint.</p>
<p>Well folks, there you have it. That was my version of the C test. I hope you had as much fun doing it as I had writing it. If you think the test is a good test, then by all means use it in your recruitment. Who knows, I may get lucky in a year or two and end up being on the receiving end of my own work.</p>
<h1 id="Q-What-is-NULL-pointer-and-what-is-its-use"><a href="#Q-What-is-NULL-pointer-and-what-is-its-use" class="headerlink" title="Q: What is NULL pointer and what is its use?"></a>Q: What is NULL pointer and what is its use?</h1><p>The NULL is a macro de¡ned in C. Null pointer actually means a pointer that does not point to any valid location. We de¡ne a pointer to be null when we want to make sure that the pointer does not point to any valid location and not to use that pointer to change anything. If we don’t use null pointer, then we can’t verify whether this pointer points to any valid location or not.</p>
<h1 id="Q-What-is-void-pointer-and-what-is-its-use"><a href="#Q-What-is-void-pointer-and-what-is-its-use" class="headerlink" title="Q: What is void pointer and what is its use?"></a>Q: What is void pointer and what is its use?</h1><p>The void pointer means that it points to a variable that can be of any type. Other pointers points to a speci¡c type of variable while void pointer is a somewhat generic pointer and can be pointed to any data type, be it standard data type(int, char etc) or user de¡ne data type (structure, union etc.). We can pass any kind of pointer and reference it as a void pointer. But to dereference it, we have to type the void pointer to correct data type.</p>
<h1 id="Q-What-is-ISR"><a href="#Q-What-is-ISR" class="headerlink" title="Q: What is ISR?"></a>Q: What is ISR?</h1><p>An ISR(Interrupt Service Routine) is an interrupt handler, a callback subroutine which is called when a interrupt is encountered Interrupt latency is the time required for an ISR responds to an interrupt.</p>
<h1 id="Q-What-is-interrupt-latency-How-to-reduce-interrupt-latency"><a href="#Q-What-is-interrupt-latency-How-to-reduce-interrupt-latency" class="headerlink" title="Q: What is interrupt latency? How to reduce interrupt latency?"></a>Q: What is interrupt latency? How to reduce interrupt latency?</h1><p>Interrupt latency is the time required for an ISR responds to an interrupt.<br>Interrupt latency can be minimized by writing short ISR routine and by not delaying interrupts for more time.</p>
<p>20) What is Top half &amp; bottom half of a kernel?</p>
<p>Sometimes to handle an interrupt, a substantial amount of work has to be done. But it conflicts with the speed need for an interrupt handler. To handle this situation, Linux splits the handler into two parts – Top half and Bottom half. The top half is the routine that actually responds to the interrupt. The bottom half on the other hand is a routine that is scheduled by the upper half to be executed later at a safer time.</p>
<p>All interrupts are enabled during execution of the bottom half. The top half saves the device data into the specific buffer, schedules bottom half and exits. The bottom half does the rest. This way the top half can service a new interrupt while the bottom half is working on the previous.</p>
<h1 id="Q-Can-static-variables-be-declared-in-a-header-file"><a href="#Q-Can-static-variables-be-declared-in-a-header-file" class="headerlink" title="Q: Can static variables be declared in a header file?"></a>Q: Can static variables be declared in a header file?</h1><p>A static variable cannot be declared without defining it. A static variable can be defined in the header file. But doing so, the result will be having a private copy of that variable in each source file which includes the header file. So it will be wise not to declare a static variable in header file, unless you are dealing with a different scenario.</p>
<h1 id="Q-Is-Count-Down-to-Zero-Loop-better-than-Count-Up-Loops"><a href="#Q-Is-Count-Down-to-Zero-Loop-better-than-Count-Up-Loops" class="headerlink" title="Q: Is Count Down_to_Zero Loop better than Count_Up_Loops?"></a>Q: Is Count Down_to_Zero Loop better than Count_Up_Loops?</h1><p>Count down to zero loops are better. Reason behind this is that at loop termination, comparison to zero can be optimized by the compiler. Most processors have instruction for comparing to zero. So they don’t need to load the loop variable and the maximum value, subtract them and then compare to zero. That is why count down to zero loop is better.</p>
<h1 id="Q-What-are-inline-functions-Advantages-and-disadvantages-of-using-macro-and-inline-functions"><a href="#Q-What-are-inline-functions-Advantages-and-disadvantages-of-using-macro-and-inline-functions" class="headerlink" title="Q: What are inline functions? Advantages and disadvantages of using macro and inline functions?"></a>Q: What are inline functions? Advantages and disadvantages of using macro and inline functions?</h1><p>The ARM compilers support inline functions with the keyword __inline. These functions have a small definition and the function body is substituted in each call to the inline function. The argument passing and stack maintenance is skipped and it results in faster code execution, but it increases code size, particularly if the inline function is large or one inline function is used often.</p>
<p>The advantage of the macro and inline function is that the overhead for argument passing and stuff is reduced as the function are in-lined. The advantage of macro function is that we can write type insensitive functions. It is also the disadvantage of macro function as macro functions can’t do validation check. The macro and inline function also increases the size of the executable.</p>
<h1 id="Q-What-happens-when-recursive-functions-are-declared-inline"><a href="#Q-What-happens-when-recursive-functions-are-declared-inline" class="headerlink" title="Q: What happens when recursive functions are declared inline?"></a>Q: What happens when recursive functions are declared inline?</h1><p>Inlining an recursive function reduces the overhead of saving context on stack. But, inline is merely a suggestion to the compiler and it does not guarantee that a function will be inlined. Obviously, the compiler won’t be able to inline a recursive function infinitely. It may not inline it at all or it may inline it, just a few levels deep.</p>
<h1 id="Q-Can-structures-be-passed-to-the-functions-by-value"><a href="#Q-Can-structures-be-passed-to-the-functions-by-value" class="headerlink" title="Q: Can structures be passed to the functions by value?"></a>Q: Can structures be passed to the functions by value?</h1><p>Passing structure by its value to a function is possible, but not a good programming practice. First of all, if we pass the structure by value and the function changes some of those values, then the value change is not reflected in caller function. Also, if the structure is big, then passing the structure by value means copying the whole structure to the function argument stack which can slow the program by a significant amount.</p>
<h1 id="Q-Why-cannot-arrays-be-passed-by-values-to-functions"><a href="#Q-Why-cannot-arrays-be-passed-by-values-to-functions" class="headerlink" title="Q: Why cannot arrays be passed by values to functions?"></a>Q: Why cannot arrays be passed by values to functions?</h1><p>In C, the array name itself represents the address of the first element. So, even if we pass the array name as argument, it will be passed as reference and not its address.</p>
<h1 id="Q-What-is-the-concatenation-operator"><a href="#Q-What-is-the-concatenation-operator" class="headerlink" title="Q: What is the concatenation operator?"></a>Q: What is the concatenation operator?</h1><p>The Concatenation operator (##) in macro is used to concatenate two arguments. Literally, we can say that the arguments are concatenated, but actually their value are not concatenated. Think it this way, if we pass A and B to a macro which uses ## to concatenate those two, then the result will be AB. Consider the example to clear the confusion-<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOME_MACRO(a, b) a##b</span></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> var = <span class="number">15</span>;</span><br><span class="line">  <span class="built_in">printf</span>(“%d”, SOME_MACRO(v, ar));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Output of the above program will be 15.</p>
<h1 id="Q-define-cat-x-y-x-y-concatenates-x-to-y-But-cat-cat-1-2-3-does-not-expand-but-gives-preprocessor-warning-Why"><a href="#Q-define-cat-x-y-x-y-concatenates-x-to-y-But-cat-cat-1-2-3-does-not-expand-but-gives-preprocessor-warning-Why" class="headerlink" title="Q: #define cat(x,y) x##y concatenates x to y. But cat(cat(1,2),3) does not expand but gives preprocessor warning. Why?"></a>Q: <code>#define cat(x,y) x##y</code> concatenates x to y. But <code>cat(cat(1,2),3)</code> does not expand but gives preprocessor warning. Why?</h1><p>The cat(x, y) expands to x##y. It just pastes x and y. But in case of cat(cat(1,2),3), it expands to cat(1,2)##3 instead of 1##2##3. That is why it is giving preprocessor warning.</p>
<h1 id="Q-How-to-decide-whether-given-processor-is-using-little-endian-format-or-big-endian-format"><a href="#Q-How-to-decide-whether-given-processor-is-using-little-endian-format-or-big-endian-format" class="headerlink" title="Q: How to decide whether given processor is using little endian format or big endian format ?"></a>Q: How to decide whether given processor is using little endian format or big endian format ?</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">check_for_endianness</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> x = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">char</span> *c = (<span class="keyword">char</span>*) &amp;x;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">int</span>)*c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Q-What-is-forward-reference-w-r-t-pointers-in-c"><a href="#Q-What-is-forward-reference-w-r-t-pointers-in-c" class="headerlink" title="Q: What is forward reference w.r.t. pointers in c?"></a>Q: What is forward reference w.r.t. pointers in c?</h1><p>Forward Referencing with respect to pointers is used when a pointer is declared and compiler reserves the memory for the pointer, but the variable or data type is not defined to which the pointer points to. For example<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span> *<span class="title">p</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"> <span class="comment">// members</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h1 id="Q-How-can-you-define-a-structure-with-bit-field-members"><a href="#Q-How-can-you-define-a-structure-with-bit-field-members" class="headerlink" title="Q: How can you define a structure with bit field members?"></a>Q: How can you define a structure with bit field members?</h1><p>Not command use bit field in embedded system! because bit fields are inherently non-portable across compilers, and as such guarantee that your code is not reusable.<br>Bit field members can be declared as shown below<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct A</span><br><span class="line">&#123;</span><br><span class="line"> char c1 : 3;</span><br><span class="line"> char c2 : 4;</span><br><span class="line"> char c3 : 1;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>Here c1, c2 and c3 are members of a structure with width 3, 4, and 1 bit respectively. The ‘:’ indicates that they are bit fields and the following numbers indicates the width in bits.</p>
<h1 id="Q-How-do-you-write-a-function-which-takes-2-arguments-a-byte-and-a-field-in-the-byte-and-returns-the-value-of-the-field-in-that-byte"><a href="#Q-How-do-you-write-a-function-which-takes-2-arguments-a-byte-and-a-field-in-the-byte-and-returns-the-value-of-the-field-in-that-byte" class="headerlink" title="Q: How do you write a function which takes 2 arguments - a byte and a field in the byte and returns the value of the field in that byte?"></a>Q: How do you write a function which takes 2 arguments - a byte and a field in the byte and returns the value of the field in that byte?</h1><p>The function will look like this -<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">GetFieldValue</span><span class="params">(<span class="keyword">int</span> byte, <span class="keyword">int</span> field )</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (byte &gt;&gt; field) &amp; <span class="number">0x01</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The byte is right shifted exactly n times where n is same as the field value. That way, our intended value ends up in the 0th bit position. “Bitwise And” with 1 can get the intended value. The function then returns the intended value.</p>
<h1 id="Q-What-is-job-of-preprocessor-compiler-assembler-and-linker"><a href="#Q-What-is-job-of-preprocessor-compiler-assembler-and-linker" class="headerlink" title="Q: What is job of preprocessor, compiler, assembler and linker ?"></a>Q: What is job of preprocessor, compiler, assembler and linker ?</h1><p>The preprocessor commands are processed and expanded by the preprocessor before actual compilation. After preprocessing, the compiler takes the output of the preprocessor and the source code, and generates assembly code. Once compiler completes its work, the assembler takes the assembly code and produces an assembly listing with offsets and generate object files.</p>
<p>The linker combines object files or libraries and produces a single executable file. It also resolves references to external symbols, assigns final addresses to functions and variables, and revises code and data to reflect new addresses.</p>
<h1 id="Q-Significance-of-watchdog-timer-in-Embedded-Systems"><a href="#Q-Significance-of-watchdog-timer-in-Embedded-Systems" class="headerlink" title="Q: Significance of watchdog timer in Embedded Systems."></a>Q: Significance of watchdog timer in Embedded Systems.</h1><p>The watchdog timer is a timing device with a predefined time interval. During that interval, some event may occur or else the device generates a time out signal. It is used to reset to the original state whenever some inappropriate events take place which can result in system malfunction. It is usually operated by counter devices.</p>
<h1 id="Q-Why-n-executes-faster-than-n-1"><a href="#Q-Why-n-executes-faster-than-n-1" class="headerlink" title="Q: Why ++n executes faster than n+1?"></a>Q: Why ++n executes faster than n+1?</h1><p>The expression ++n requires a single machine instruction such as INR to carry out the increment operation. In case of n+1, apart from INR, other instructions are required to load the value of n. That is why ++n is faster.</p>
<h1 id="Q-What-is-wild-pointer"><a href="#Q-What-is-wild-pointer" class="headerlink" title="Q: What is wild pointer?"></a>Q: What is wild pointer?</h1><p>A pointer that is not initialized to any valid address or NULL is considered as wild pointer. Consider the following code fragment -</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> *p;</span><br><span class="line">*p = <span class="number">20</span>;</span><br></pre></td></tr></table></figure>
<p>Here p is not initialized to any valid address and still we are trying to access the address. The p will get any garbage location and the next statement will corrupt that memory location.</p>
<h1 id="Q-What-is-dangling-pointer"><a href="#Q-What-is-dangling-pointer" class="headerlink" title="Q: What is dangling pointer?"></a>Q: What is dangling pointer?</h1><p>迷途指针, 指向的buffer已经被释放了, 但是指向它的指针依旧<br>If the memory of a pointer is de-allocated or freed and the pointer is not assigned to NULL, then it may still contain that address and accessing the pointer means that we are trying to access that location and it will give an error. This type of pointer is called dangling pointer.</p>
<h1 id="Q-Write-down-the-equivalent-pointer-expression-for-referring-the-same-element-a-i-j-k-l"><a href="#Q-Write-down-the-equivalent-pointer-expression-for-referring-the-same-element-a-i-j-k-l" class="headerlink" title="Q: Write down the equivalent pointer expression for referring the same element a[i][j][k][l] ?"></a>Q: Write down the equivalent pointer expression for referring the same element <code>a[i][j][k][l]</code> ?</h1><p>We know that <code>a[i]</code> can be written as <code>*(a+i)</code>. Same way, the array elements can be written like pointer expression as follows -<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a[i][j] == *(*(a+i)+j)</span><br><span class="line">a[i][j][k] == *(*(*(a+i)+j)+k)</span><br><span class="line">a[i][j][k][l] == *(*(*(*(a+i)+j)+k)+l)</span><br></pre></td></tr></table></figure></p>
<h1 id="Q-When-should-we-use-register-modifier"><a href="#Q-When-should-we-use-register-modifier" class="headerlink" title="Q: When should we use register modifier?"></a>Q: When should we use register modifier?</h1><p>The register modifier is used when a variable is expected to be heavily used and keeping it in the CPU’s registers will make the access faster.</p>
<h1 id="Q-Explain-what-are-the-different-storage-classes-in-C"><a href="#Q-Explain-what-are-the-different-storage-classes-in-C" class="headerlink" title="Q: Explain what are the different storage classes in C"></a>Q: Explain what are the different storage classes in C</h1><ul>
<li><code>auto</code> for local variables in RAM</li>
<li><code>register</code> for local variables in register</li>
<li><code>static</code> for local variable, keeping the value during the life-time of the program</li>
<li><code>static</code> for global variable only shared on its own file scope</li>
<li><code>extern</code> to give a reference of a global variable that is visible to ALL the program files</li>
</ul>
<hr>
<p><strong><em>转载自 <a href="http://www.emb-linux.narod.ru/interview/0x10_questions.pdf" target="_blank" rel="noopener">The 0x10 Best Questions for Would-be Embedded Programmers</a></em></strong><br><strong><em>转载自 <a href="http://a4academics.com/interview-questions/57-c-plus-plus/722-embedded-c-interview-questions?showall=&amp;limitstart=" target="_blank" rel="noopener">Embedded C Interview Questions and Answers</a></em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/04/12/1815-suspend/" itemprop="url">
                  博客暂停更新
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2018-04-12T00:00:00+10:00" content="2018-04-12">
              2018-04-12
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><ul>
<li><a href="https://draapho.github.io/2017/10/09/1728-ultimatethink/">我的终极思考</a></li>
<li><a href="https://draapho.github.io/2018/04/12/1815-suspend/">博客暂停更新</a></li>
<li><a href="https://draapho.github.io/2018/07/08/1818-buddhism/">佛教学习资料及一些感想</a></li>
<li><a href="https://draapho.github.io/2018/11/29/1819-start-meditation/">实修开始</a></li>
<li><a href="https://draapho.github.io/2018/12/27/1820-meditation-LCP/">闻思修</a></li>
<li><a href="https://draapho.github.io/2019/03/19/1901-tittle-tattle/">杂谈</a></li>
<li><a href="https://draapho.github.io/2019/07/26/1910-satori/">开悟是怎样一种体验？</a></li>
</ul>
<h1 id="本博客暂停更新"><a href="#本博客暂停更新" class="headerlink" title="本博客暂停更新"></a>本博客暂停更新</h1><p>原因的话, 最大的兴趣点始终是在人文和生命本源这一块. 参考 <a href="https://draapho.github.io/2017/10/09/1728-ultimatethink/">我的终极思考</a><br>当下可能找到了一种方法, 让生活和兴趣可以两全. 我需要全力去试一试.</p>
<p>第一阶段, 独善其身:</p>
<ul>
<li>于资本汇聚之地得自由</li>
<li>于人性汇聚之地得自在</li>
<li>万物皆空, 上善若水<ul>
<li>贪嗔痴疑慢, 万物皆烦恼. 舍万物?求信仰? 终是不究竟.</li>
<li>水无所依, 可依万物. 心无所执, 可着万境.</li>
</ul>
</li>
</ul>
<p>第二阶段, 兼济天下:</p>
<ul>
<li>人文学科和生命本源数学化, 理论化.</li>
<li>已有大致思路: <ul>
<li>心为本, 物为载体, 心可改变物.</li>
<li>一切出发点是基本生命体的相互关系, 这种相互关系就是本源, 不随级别改变.</li>
<li>环境的影响首先作用于心, 心影响生命体的相互关系, 从而影响整个群体的行为和特性.</li>
</ul>
</li>
<li>主观上, 我认为佛教的世界观是正确的; 但受限于”客观”的观察要求, 要证明比较困难.<ul>
<li>所谓大千世界, 是指不同级别包含生命体的世界. 每个人, 每朵花, 每个细胞都是一世界. (分子,原子不敢确定)</li>
<li>世界就是玻璃缸, 人是没有什么”客观”的方法去观察玻璃缸外的情况的.</li>
<li>人之所以稍微特殊一点, 是因为以人为基础单位, 明显已经发展出多样的更高层次的生命体(企业, 国家等各种形态的组织)</li>
<li>更重要的, 人有潜能进行星际殖民, 从而把星球发展成为更高级的”基础细胞”.</li>
</ul>
</li>
</ul>
<p>最后, 无论成败, 先在此感谢 <a href="http://blog.sina.com.cn/u/1215172700" target="_blank" rel="noopener">缠中说禅</a> 不但指明了实用的生存方法, 更是给予了我无穷的灵感!<br>读君博文, 方觉虚度光阴30载. 愿君彼岸安好.</p>
<hr>
<p><strong><em>原创于 <a href="https://draapho.github.io/">DRA&amp;PHO</a></em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/02/09/1815-drv-i2c/" itemprop="url">
                  驱动之I2C驱动
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2018-02-09T00:00:00+11:00" content="2018-02-09">
              2018-02-09
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><ul>
<li><a href="https://draapho.github.io/2017/11/23/1734-linux-content/">嵌入式linux学习目录</a></li>
<li><a href="https://draapho.github.io/2018/02/09/1815-drv-i2c/">驱动之I2C驱动</a></li>
</ul>
<p>本文使用 linux-2.6.22.6 内核, 由于jz2440开发板没有板载I2C设备, 因此源码部分无法实际测试.</p>
<h1 id="I2C驱动框架分析"><a href="#I2C驱动框架分析" class="headerlink" title="I2C驱动框架分析"></a>I2C驱动框架分析</h1><p>I2C协议本身不是太复杂, 但Linux内核为了通用化, 搞了一套复杂的总线系统.</p>
<p><img src="https://draapho.github.io/images/1815/layer.png" alt="layer.png"></p>
<p><strong>最要理解i2c框架, 尝试理解 <code>i2c_add_adapter</code> 和 <code>i2c_add_driver</code> 就行了.</strong></p>
<ul>
<li><code>i2c_adapter</code> 对i2c主机的抽象概念, 与 <code>i2c_add_adapter</code> 相关<ul>
<li>这部分的架构都是已经搭好的, 由CPU厂商完成.</li>
<li>针对特定的开发板, 一般情况只会有一个 <code>i2c_adapter</code>. 会在<code>/drivers/i2c/busses</code>下选取一个</li>
<li>但特殊情况, 如果需要用不同的数据预处理方式, 如 <code>i2c-algo-bit</code>, 那么也可以抽象出多个 <code>i2c_adapter</code></li>
</ul>
</li>
<li><code>i2c_driver</code>  对i2c从机的抽象概念, 与 <code>i2c_add_driver</code> 相关<ul>
<li>Linux内核给了很多i2c芯片的驱动范例. 我们所说的开发i2c驱动, 是位于这一端的.</li>
<li>一个真实的i2c从机设备并非对应唯一的 <code>i2c_driver</code>.</li>
<li>譬如i2c芯片24cXX. 可以对APP端抽象出多种概念:<ul>
<li>linux内核为了让APP端能直接操作i2c, 通过 <code>i2c-dev.c</code> 实现了一个 <code>i2c_driver</code></li>
<li>系统里的<code>eeprom.c</code>, 帮我们实现了通用eeprom的操作. 就是另一个 <code>i2c_driver</code></li>
<li>我们自己也可以写一个驱动, 将24cXX认为是一块加密芯片. 就是第三个 <code>i2c_driver</code></li>
<li>这样, i2c从机端的底层都是一样的, 但上层的抽象概念是不同的. 或许, 这也是将主机端取名为 <code>i2c_adapter</code> 的原因, 它只是一个通讯适配器. 将APP层的不同抽象概念适配到一个个具体的i2c芯片上.</li>
</ul>
</li>
</ul>
</li>
<li><code>i2c_adapter</code> 和 <code>i2c_driver</code> 的关联方式<ul>
<li>就是 platform 总线架构, 两个链表有新加内容后, 循环查找匹配.</li>
<li>是否匹配有两个要点:<ul>
<li>一是 <code>i2c_adapter.nr</code> 和 <code>i2c_client_address_data</code> 里的设置是否一样</li>
<li>这里基本都不用这个值去匹配的. 总线驱动也没去设置 <code>i2c_adapter.nr</code>. 设备端驱动直接设置为 <code>ANY_I2C_BUS</code> 即可.</li>
<li>二是 i2c 的物理地址, 根据物理地址实际通讯一下, 来进行匹配.</li>
<li>如果用了 <code>i2c_client_address_data.force</code>, 那么物理地址的检测过程也将被忽略.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="相关文件"><a href="#相关文件" class="headerlink" title="相关文件"></a>相关文件</h2><ul>
<li><code>./drivers/i2c/i2c-core.c</code> 这个文件实现了I2C核心的功能以及/proc/bus/i2c*接口。<ul>
<li>此文件就是 <code>i2c核心层</code> 作用是承上启下:</li>
<li>对上, 提供统一的调用接口, 屏蔽硬件差异. 如提供 <code>read</code> <code>write</code> 函数.</li>
<li>对下, 抽象出i2c操作通用的部分, 简化i2c的硬件驱动开发.<br>-　<code>./drivers/i2c/busses</code> 包含了各个芯片厂商的I2C总线的驱动</li>
<li>如 <code>i2c-s3c2410.c</code> 针对S3C系列处理器的I2C控制器驱动.</li>
</ul>
</li>
<li><code>./drivers/i2c/i2c-dev.c</code> 实现了I2C适配器设备文件的功能，每一个I2C适配器都被分配一个设备.<ul>
<li>把这个文件理解为系统提供的一个i2c设备驱动程序即可. 需要手动加载.</li>
<li>此文件会调用 <code>i2c_add_driver</code>, 系统默认注册的一个i2c设备, 可供app端直接调用.</li>
<li>i2c芯片另外需要自己的驱动程序, 去调用 <code>i2c_add_driver</code>, 并注册设备.</li>
</ul>
</li>
<li><del><code>./drivers/i2c/algos</code>　文件夹实现了一些I2C总线适配器的algorithm.</del><ul>
<li>algorithm 这个词让人容易误解. 我的理解是数据预处理方式的不同.</li>
<li><code>i2c-algo-pca.c</code>. 可参考 <a href="https://www.nxp.com/docs/en/data-sheet/PCF8584.pdf" target="_blank" rel="noopener">PCF8584 I2C-bus controller</a></li>
<li><code>i2c-algo-pcf.c</code>. 可参考 <a href="https://www.nxp.com/docs/en/data-sheet/PCA9564.pdf" target="_blank" rel="noopener">PCA9564 Parallel bus to I2C-bus controller</a></li>
<li><code>i2c-algo-sgi.c</code>. 应该针对给2款早已过时的PC机用的.</li>
<li><code>I2C_ALGO_XXX</code> 的宏定义可以在 <code>./include/linux/i2c-id.h</code> 下找到</li>
</ul>
</li>
</ul>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><ul>
<li><code>struct i2c_driver</code> 提供 <code>probe</code> <code>remove</code> 等函数接口. i2c从机设备驱动使用<ul>
<li><code>i2c_add_driver</code> 函数使用. 与 <code>i2c_adapter</code> 对应, 两者需要匹配.</li>
</ul>
</li>
<li><code>struct i2c_adapter</code> 适配器. 就是将多种多样的底层I2C硬件需求(不同地址, 不同通讯方法)给一个统一的方法接入到I2C核心层.<ul>
<li>指定通讯方式(i2c_algorithm)</li>
<li>指定i2c设备(i2c_client)</li>
<li><code>i2c_add_adapter</code> 函数使用. 与 <code>i2c_driver</code> 对应, 两者需要匹配.</li>
</ul>
</li>
<li><code>struct i2c_client</code> 描述了真实设备的所有必要信息, 如 i2c addr, 设备名称, 中断号等等.<ul>
<li>除了提供给 <code>i2c_adapter</code> 外, 还直接和 <code>i2c_driver</code> 想关联.</li>
<li>原因应该是内核层和应用层都需要方便的读取真实i2c设备的必要信息</li>
</ul>
</li>
<li><code>struct i2c_algorithm</code> 通讯方法. 其中两个函数指针是由底层硬件实现的. 相当于 i2c核心层和底层的接口<ul>
<li>algorithm 这个词让人容易误解. 我的理解是数据预处理方式的不同.</li>
<li>只和 <code>i2c_adapter</code> 相关, 给i2c主机提供收发功能</li>
<li><code>.master_xfer</code> 发送函数, 需要底层实现.</li>
<li><code>struct i2c_msg</code> 用于存放通讯时的地址, 数据buf, 长度等信息</li>
<li><code>.functionality</code> 驱动支持的功能, 需要底层明确.</li>
<li>底层没有接收函数. 因为i2c通讯必须由主机发起并提供时钟, 发送的同时就会接收数据.</li>
</ul>
</li>
</ul>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p><img src="https://draapho.github.io/images/1815/function.png" alt="function.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// =========== 从 i2c_add_driver 看 ==========</span></span><br><span class="line">i2c_add_driver                                              <span class="comment">// I2C 设备驱动会调用, 如自己写的驱动</span></span><br><span class="line">    i2c_register_driver</span><br><span class="line">        driver-&gt;driver.bus = &amp;i2c_bus_type;</span><br><span class="line">        driver_register(&amp;driver-&gt;driver);</span><br><span class="line">        list_add_tail(&amp;driver-&gt;<span class="built_in">list</span>,&amp;drivers);              <span class="comment">// 将 i2c_driver 放到链表尾部</span></span><br><span class="line"></span><br><span class="line">        list_for_each_entry(adapter, &amp;adapters, <span class="built_in">list</span>) &#123;</span><br><span class="line">            driver-&gt;attach_adapter(adapter);                <span class="comment">// 尝试匹配 i2c_adapter</span></span><br><span class="line">            <span class="comment">// driver-&gt;attach_adapter 就会去调用驱动里指定的 attach_adapter 函数.</span></span><br><span class="line">            <span class="comment">// 一般的, 就是直接调用 i2c_probe. "i2c-dev.c" 除外, 它关联所有的 "i2c_adapter".</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">i2c_probe(adapter, &amp;addr_data, eeprom_detect);              <span class="comment">// adapter 是系统传过来的</span></span><br><span class="line">    adap_id = i2c_adapter_id(adapter)                       <span class="comment">// i2c_adapter.nr 作为判断.</span></span><br><span class="line">    <span class="comment">// 判断 address_data 里是否有 forces.类型匹配即可. 强制类型不会检查I2C从设备是否存在</span></span><br><span class="line">    <span class="keyword">if</span> (address_data-&gt;forces) &#123;</span><br><span class="line">        <span class="comment">// force里的类型与 i2c_adapter.nr 一致, 或者是 ANY_I2C_BUS</span></span><br><span class="line">        <span class="keyword">if</span> (forces[kind][i] == adap_id || forces[kind][i] == ANY_I2C_BUS) &#123;</span><br><span class="line">            i2c_probe_address();                            <span class="comment">// 调用 i2c_probe_address</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// address_data.probe 里的地址和类型不受ignore影响.</span></span><br><span class="line">    <span class="comment">// probe 的数据格式也必须是 &#123;I2C_BUS_ID, ADDR, I2C_BUS_ID, ADDR, I2C_CLIENT_END&#125;</span></span><br><span class="line">    <span class="keyword">if</span> (address_data-&gt;probe[i] == adap_id || address_data-&gt;probe[i] == ANY_I2C_BUS) &#123;</span><br><span class="line">            i2c_probe_address();                            <span class="comment">// 调用 i2c_probe_address</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// address_data.normal_i2c, 就是排除 .ignore 后, 进行 i2c_probe_address</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">i2c_probe_address                                           <span class="comment">// 发出S信号,发出设备地址(来自addr_data)</span></span><br><span class="line">    i2c_smbus_xfer</span><br><span class="line">        i2c_smbus_xfer_emulated</span><br><span class="line">            i2c_transfer</span><br><span class="line">                adap-&gt;algo-&gt;master_xfer                     <span class="comment">// 就是调用 s3c24xx_i2c_xfer</span></span><br><span class="line">    found_proc(adapter, addr, kind);</span><br><span class="line">    <span class="comment">// 回调用户设置的的 detection 函数, 告知匹配成功. 可以做一些收发数据的初始化准备.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// =========== 从 i2c_add_adapter 看 ==========</span></span><br><span class="line">i2c_add_adapter                                             <span class="comment">// I2C 总线驱动会调用, 如 "i2c-s3c2410.c"</span></span><br><span class="line">    i2c_register_adapter</span><br><span class="line">        device_register(&amp;adap-&gt;dev);                        <span class="comment">// 在 i2c-adapter 下注册 i2c-X</span></span><br><span class="line">        list_for_each(item,&amp;drivers) &#123;</span><br><span class="line">            driver = list_entry(item, struct i2c_driver, <span class="built_in">list</span>);</span><br><span class="line">            driver-&gt;attach_adapter(adap);                   <span class="comment">// 尝试匹配 i2c_adapter</span></span><br><span class="line">            <span class="comment">// driver-&gt;attach_adapter 就会去调用i2c设备驱动里指定的 attach_adapter 函数.</span></span><br><span class="line">            <span class="comment">// 后续过程和后面的 i2c_add_driver 一样, 略过不表</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关于 i2c_adapter.nr 应该是由这里的驱动在设定, 作为对接的依据之一.</span></span><br><span class="line"><span class="comment">// 但实际上, 大多数CPU厂商都没有用这个 i2c_adapter.nr 去作为 I2C_BUS 的ID. 默认值应该是0</span></span><br><span class="line"><span class="comment">// 所以最终是否能匹配就变成了根据 I2C 的地址, 实际检测一下设备是否存在...</span></span><br></pre></td></tr></table></figure>
<h1 id="编写I2C设备驱动"><a href="#编写I2C设备驱动" class="headerlink" title="编写I2C设备驱动"></a>编写I2C设备驱动</h1><p>一般的, I2C总线驱动也由芯片公司完成了.<br>因此, 当外接了某个i2c设备时, 只需要编写一下设备驱动就可以了.<br>linux内核还包含了常用的 i2c 设备如eeprom. 可以在 <code>./drivers/i2c/chips</code> 下看看.</p>
<p>核心步骤如下:</p>
<ul>
<li>分配一个i2c_driver结构体</li>
<li>设置:<pre><code>- `attach_adapter`, 它直接调用 i2c_probe (adap, 设备地址, 发现这个设备后要调用的函数)
- `detach_client`,  卸载这个驱动后,如果之前发现能够支持的设备,则调用它来清理
</code></pre></li>
<li>注册： <code>i2c_add_driver</code></li>
<li>注册为<code>字符设备</code>或其它. 如 <code>input系统</code> <code>块设备</code>, 并实现对应的操作函数.</li>
</ul>
<h2 id="at24cxx-c"><a href="#at24cxx-c" class="headerlink" title="at24cxx.c"></a>at24cxx.c</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/jiffies.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/i2c.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mutex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"DRAAPHO"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> ignore[]      = &#123; I2C_CLIENT_END &#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> normal_addr[] = &#123; <span class="number">0x50</span>, I2C_CLIENT_END &#125;;     <span class="comment">// 地址值是7位</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ignore 数组范例</span></span><br><span class="line"><span class="comment">// static unsigned short ignore[]      = &#123; ANY_I2C_BUS, 0x60, I2C_CLIENT_END &#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// probe 数组范例</span></span><br><span class="line"><span class="comment">// static unsigned short probe[]       = &#123; ANY_I2C_BUS, 0x60, I2C_CLIENT_END &#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// force 数组范例</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> force_addr[] = &#123;ANY_I2C_BUS, <span class="number">0x60</span>, I2C_CLIENT_END&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> *forces[] = &#123;force_addr, <span class="literal">NULL</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_client_address_data</span> <span class="title">addr_data</span> = &#123;</span></span><br><span class="line">    .normal_i2c = normal_addr,              <span class="comment">// 要发出S信号和设备地址并得到ACK信号, 才确认设备存在</span></span><br><span class="line">    .probe      = ignore,</span><br><span class="line">    .ignore     = ignore,</span><br><span class="line">    <span class="comment">// 一般不用 .forces 的. 由于jz2440没有i2c从设备, 因此这里用一下.</span></span><br><span class="line">    .forces     = forces,                   <span class="comment">// 强制认为存在这个设备</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> major;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">class</span> *<span class="title">cls</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> <span class="title">at24cxx_driver</span>;</span>    <span class="comment">// i2c_driver 结构体, 初始化在后面</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">at24cxx_client</span>;</span>          <span class="comment">// i2c_client 结构体</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">at24cxx_read</span><span class="params">(struct file *file, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> * offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> address;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msg</span>[2];</span>                  <span class="comment">// i2c_msg 结构体</span></span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size != <span class="number">1</span>)                          <span class="comment">// 只接受1个参数, 表地址.</span></span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    copy_from_user(&amp;address, buf, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读AT24CXX时,要先把要读的存储空间的地址发给它</span></span><br><span class="line">    msg[<span class="number">0</span>].addr  = at24cxx_client-&gt;addr;    <span class="comment">// 目的</span></span><br><span class="line">    msg[<span class="number">0</span>].buf   = &amp;address;                <span class="comment">// 源</span></span><br><span class="line">    msg[<span class="number">0</span>].len   = <span class="number">1</span>;                       <span class="comment">// 地址=1 byte</span></span><br><span class="line">    msg[<span class="number">0</span>].flags = <span class="number">0</span>;                       <span class="comment">// 表示写</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 然后启动读操作</span></span><br><span class="line">    msg[<span class="number">1</span>].addr  = at24cxx_client-&gt;addr;    <span class="comment">// 源</span></span><br><span class="line">    msg[<span class="number">1</span>].buf   = &amp;data;                   <span class="comment">// 目的</span></span><br><span class="line">    msg[<span class="number">1</span>].len   = <span class="number">1</span>;                       <span class="comment">// 数据=1 byte</span></span><br><span class="line">    msg[<span class="number">1</span>].flags = I2C_M_RD;                <span class="comment">// 表示读</span></span><br><span class="line"></span><br><span class="line">    ret = i2c_transfer(at24cxx_client-&gt;adapter, msg, <span class="number">2</span>);    <span class="comment">// 发送+接受</span></span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">2</span>) &#123;</span><br><span class="line">        copy_to_user(buf, &amp;data, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -EIO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">at24cxx_write</span><span class="params">(struct file *file, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> val[<span class="number">2</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msg</span>[1];</span></span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size != <span class="number">2</span>)                          <span class="comment">// 只接受2个参数, 表地址和数据.</span></span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    copy_from_user(val, buf, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    msg[<span class="number">0</span>].addr  = at24cxx_client-&gt;addr;    <span class="comment">// 目的</span></span><br><span class="line">    msg[<span class="number">0</span>].buf   = val;                     <span class="comment">// 源</span></span><br><span class="line">    msg[<span class="number">0</span>].len   = <span class="number">2</span>;                       <span class="comment">// 地址+数据=2 byte</span></span><br><span class="line">    msg[<span class="number">0</span>].flags = <span class="number">0</span>;                       <span class="comment">// 表示写</span></span><br><span class="line"></span><br><span class="line">    ret = i2c_transfer(at24cxx_client-&gt;adapter, msg, <span class="number">1</span>);    <span class="comment">// 发送</span></span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> -EIO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">at24cxx_fops</span> = &#123;</span></span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .read  = at24cxx_read,</span><br><span class="line">    .write = at24cxx_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">at24cxx_detect</span><span class="params">(struct i2c_adapter *adapter, <span class="keyword">int</span> address, <span class="keyword">int</span> kind)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">"at24cxx_detect\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一个i2c_client结构体: 收发数据时会用到它</span></span><br><span class="line">    at24cxx_client = kzalloc(<span class="keyword">sizeof</span>(struct i2c_client), GFP_KERNEL);</span><br><span class="line">    at24cxx_client-&gt;addr    = address;</span><br><span class="line">    at24cxx_client-&gt;adapter = adapter;</span><br><span class="line">    at24cxx_client-&gt;driver  = &amp;at24cxx_driver;</span><br><span class="line">    <span class="built_in">strcpy</span>(at24cxx_client-&gt;name, <span class="string">"at24cxx"</span>);</span><br><span class="line">    i2c_attach_client(at24cxx_client);      <span class="comment">// 关联到 i2c_driver 和 i2c_adapter</span></span><br><span class="line"></span><br><span class="line">    major = register_chrdev(<span class="number">0</span>, <span class="string">"at24cxx"</span>, &amp;at24cxx_fops);</span><br><span class="line"></span><br><span class="line">    cls = class_create(THIS_MODULE, <span class="string">"at24cxx"</span>);</span><br><span class="line">    class_device_create(cls, <span class="literal">NULL</span>, MKDEV(major, <span class="number">0</span>), <span class="literal">NULL</span>, <span class="string">"at24cxx"</span>);           <span class="comment">// /dev/at24cxx</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">at24cxx_attach</span><span class="params">(struct i2c_adapter *adapter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 主动调用 probe 函数, 符合要求后, 会调用 at24cxx_detect</span></span><br><span class="line">    <span class="keyword">return</span> i2c_probe(adapter, &amp;addr_data, at24cxx_detect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">at24cxx_detach</span><span class="params">(struct i2c_client *client)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">"at24cxx_detach\n"</span>);</span><br><span class="line">    class_device_destroy(cls, MKDEV(major, <span class="number">0</span>));</span><br><span class="line">    class_destroy(cls);</span><br><span class="line">    unregister_chrdev(major, <span class="string">"at24cxx"</span>);</span><br><span class="line"></span><br><span class="line">    i2c_detach_client(client);</span><br><span class="line">    kfree(i2c_get_clientdata(client));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> <span class="title">at24cxx_driver</span> = &#123;</span> <span class="comment">// i2c_driver 结构体</span></span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name   = <span class="string">"at24cxx"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .attach_adapter = at24cxx_attach,</span><br><span class="line">    .detach_client  = at24cxx_detach,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">at24cxx_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    i2c_add_driver(&amp;at24cxx_driver);        <span class="comment">// i2c_add_driver, 会自动去匹配 i2c_add_adapter</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">at24cxx_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    i2c_del_driver(&amp;at24cxx_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(at24cxx_init);</span><br><span class="line">module_exit(at24cxx_exit);</span><br></pre></td></tr></table></figure>
<h2 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">TEST_FILE   := i2c_test</span><br><span class="line"></span><br><span class="line">obj-m       := at24cxx.o</span><br><span class="line">KERN_SRC    := /home/draapho/share/jz2440/kernel/linux-2.6.22.6/</span><br><span class="line">PWD         := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line"></span><br><span class="line"><span class="section">modules:</span></span><br><span class="line">    make -C <span class="variable">$(KERN_SRC)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    make -C <span class="variable">$(KERN_SRC)</span> M=<span class="variable">$(PWD)</span> clean</span><br><span class="line">    rm -f <span class="variable">$(TEST_FILE)</span></span><br><span class="line"></span><br><span class="line"><span class="section">test:</span></span><br><span class="line">    arm-linux-gcc <span class="variable">$(TEST_FILE)</span>.c -o <span class="variable">$(TEST_FILE)</span></span><br></pre></td></tr></table></figure>
<h2 id="i2c-test-c"><a href="#i2c-test-c" class="headerlink" title="i2c_test.c"></a>i2c_test.c</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* i2c_test r addr</span></span><br><span class="line"><span class="comment"> * i2c_test w addr val</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_usage</span><span class="params">(<span class="keyword">char</span> *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s r addr\n"</span>, file);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s w addr val\n"</span>, file);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((argc != <span class="number">3</span>) &amp;&amp; (argc != <span class="number">4</span>)) &#123;</span><br><span class="line">        print_usage(argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">"/dev/at24cxx"</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"can't open /dev/at24cxx\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"r"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        buf[<span class="number">0</span>] = strtoul(argv[<span class="number">2</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        read(fd, buf, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"data: %c, %d, 0x%2x\n"</span>, buf[<span class="number">0</span>], buf[<span class="number">0</span>], buf[<span class="number">0</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"w"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        buf[<span class="number">0</span>] = strtoul(argv[<span class="number">2</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        buf[<span class="number">1</span>] = strtoul(argv[<span class="number">3</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        write(fd, buf, <span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        print_usage(argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu 主机端</span></span><br><span class="line"><span class="comment"># pwd = ~/share/jz2440/drivers/i2c/             # i2c驱动目录</span></span><br><span class="line">$ make modules</span><br><span class="line">$ make <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发板端, 开始测试</span></span><br><span class="line">$ cat /proc/devices                             <span class="comment"># 注册的驱动, 如调用 "register_chrdev"</span></span><br><span class="line">$ ls /sys/class/                                <span class="comment"># 注册的类, 如调用 "class_create"</span></span><br><span class="line">i2c-adapter                                     <span class="comment"># 由 i2c-core.c 生成</span></span><br><span class="line"><span class="comment"># 里面有个 i2c-0 设备, 是i2c主机端概念,</span></span><br><span class="line"><span class="comment"># 由 i2c_add_adapter 生成. 就是 s3c2440-i2c.</span></span><br><span class="line"></span><br><span class="line">$ ls /sys/class/class_name                      <span class="comment"># 注册的设备, 如调用 "device_create"</span></span><br><span class="line">$ ls /dev/                                      <span class="comment"># mdev根据注册的设备, 使用mknod生成的设备节点</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># pwd = ~/share/jz2440//kernel/linux-2.6.22.6/drivers/i2c   # i2c驱动目录, nfs</span></span><br><span class="line">$ insmod i2c-dev.ko                             <span class="comment"># 加载系统自带的i2c</span></span><br><span class="line"><span class="comment"># 源码里会调用 i2c_add_driver 表示一个从机设备, 供APP端直接操作此i2c设备</span></span><br><span class="line"></span><br><span class="line">$ cat /proc/devices</span><br><span class="line"> 89 i2c                                         <span class="comment"># 固定的主设备号89, i2c 从设备</span></span><br><span class="line">$ ls /sys/class/</span><br><span class="line">i2c-dev                                         <span class="comment"># 找到了 i2c-dev 类</span></span><br><span class="line">$ ls /sys/class/i2c-dev</span><br><span class="line">i2c-0                                           <span class="comment"># 这个i2c0是从机端概念, 由 i2c_add_driver 生成</span></span><br><span class="line"><span class="comment"># ls /dev/i2c*</span></span><br><span class="line">/dev/i2c-0                                      <span class="comment"># 是 i2c-dev 的 i2c-0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 继续做实验</span></span><br><span class="line"><span class="comment"># pwd = ~/share/jz2440/drivers/i2c/             # i2c驱动目录, nfs</span></span><br><span class="line">$ insmod at24cxx.ko                             <span class="comment"># 加载驱动</span></span><br><span class="line">at24cxx_detect                                  <span class="comment"># 使用的强制加载, 因此没有外设也说检测到了</span></span><br><span class="line"></span><br><span class="line">$ cat /proc/devices</span><br><span class="line"> 89 i2c                                         <span class="comment"># APP可以通过这里操作i2c底层</span></span><br><span class="line">252 at24cxx                                     <span class="comment"># APP可以通过这里认为只是在读写eeprom, 虽然底层实现是i2c通讯</span></span><br><span class="line">$ ls /sys/class/</span><br><span class="line">at24cxx                                         <span class="comment"># 由自己的i2c驱动代码生成, 与 i2c_add_driver 相关</span></span><br><span class="line">i2c-adapter                                     <span class="comment"># 由 i2c-core 生成, 与 i2c_add_adapter 相关</span></span><br><span class="line">i2c-dev                                         <span class="comment"># 由 i2c-dev 生成, 与 i2c_add_driver 相关</span></span><br><span class="line">$ ls /dev/at* /dev/i2c*</span><br><span class="line">/dev/at24cxx  /dev/i2c-0                        <span class="comment"># 两个设备节点.</span></span><br><span class="line"><span class="comment"># i2c-adapter 是不会出现在这里的. 因为只会对i2c从机进行读写操作, 是不会对i2c主机做什么操作的.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># at24c芯片操作.</span></span><br><span class="line"><span class="comment"># pwd = ~/share/jz2440/drivers/i2c/             # i2c驱动目录, nfs</span></span><br><span class="line">$ ./i2c_test r 0</span><br><span class="line">$ ./i2c_test w 0 0x59</span><br><span class="line">$ ./i2c_test r 0                                <span class="comment"># 回读应该也是 0x59 才对.</span></span><br><span class="line"><span class="comment"># 断电后再读也应该是0x59. eeprom是非易失性存储器</span></span><br><span class="line"><span class="comment"># 对jz2440肯定是失败的, 因为没有这个外设.</span></span><br></pre></td></tr></table></figure>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://www.cnblogs.com/lcw/p/3297889.html" target="_blank" rel="noopener">【驱动】linux下I2C驱动架构全面分析</a></li>
<li><a href="http://blog.csdn.net/hanmengaidudu/article/details/10159787" target="_blank" rel="noopener">用户空间使用i2c-dev.c</a></li>
</ul>
<hr>
<p><strong><em>原创于 <a href="https://draapho.github.io/">DRA&amp;PHO</a></em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/02/08/1814-drv-rtc/" itemprop="url">
                  驱动之RTC分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2018-02-08T00:00:00+11:00" content="2018-02-08">
              2018-02-08
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><ul>
<li><a href="https://draapho.github.io/2017/11/23/1734-linux-content/">嵌入式linux学习目录</a></li>
<li><a href="https://draapho.github.io/2018/01/05/1802-drv-input/">驱动之input子系统</a></li>
<li><a href="https://draapho.github.io/2018/01/08/1803-drv-platform/">驱动之platform概念</a></li>
<li><a href="https://draapho.github.io/2018/02/08/1814-drv-rtc/">驱动之RTC分析</a></li>
<li><a href="https://draapho.github.io/2018/01/09/1804-drv-lcd/">驱动之LCD驱动框架和实现</a></li>
<li><a href="https://draapho.github.io/2018/01/11/1806-drv-ts/">驱动之触摸屏驱动框架和实现</a></li>
<li><a href="https://draapho.github.io/2018/01/18/1807-drv-usb1/">驱动之USB基础概念和框架</a></li>
<li><a href="https://draapho.github.io/2018/01/19/1808-drv-usb2/">驱动之USB设备驱动程序</a></li>
</ul>
<p>本文使用 linux-2.6.22.6 内核, 使用jz2440开发板.</p>
<h1 id="字符设备驱动另一种写法"><a href="#字符设备驱动另一种写法" class="headerlink" title="字符设备驱动另一种写法"></a>字符设备驱动另一种写法</h1><p>在 <a href="https://draapho.github.io/2017/11/22/1733-drv-chr1/">驱动之字符设备-框架</a> 里, 使用的是函数 <code>register_chrdev</code> 进行注册的.<br>其缺点是, 默认调用了 <code>__register_chrdev_region(major, 0, 256, name);</code>, 也就是会把256个次设备号全部注册掉.<br>为了合理使用次设备号, 就需要另外一种写法.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> major;                               <span class="comment">// 确定主设备号</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">hello_fops</span> = &#123;</span>    <span class="comment">// fop数据结构</span></span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .open = hello_open,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __init hello_init(<span class="keyword">void</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主设备号已知, 用 register_chrdev_region 即可</span></span><br><span class="line">    <span class="comment">// devid = MKDEV(major, 0);</span></span><br><span class="line">    <span class="comment">// register_chrdev_region(devid, HELLO_CNT, "hello");</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主设备号需要系统分配, 用 alloc_chrdev_region 函数</span></span><br><span class="line">    alloc_chrdev_region(&amp;devid, <span class="number">0</span>, HELLO_CNT, <span class="string">"hello"</span>);</span><br><span class="line">    major = MAJOR(devid);                       <span class="comment">// 提取主设备号</span></span><br><span class="line"></span><br><span class="line">    cls = class_create(THIS_MODULE, <span class="string">"hello"</span>);   <span class="comment">// 创建类</span></span><br><span class="line">    cdev_init(&amp;hello_cdev, &amp;hello_fops);        <span class="comment">// 初始化</span></span><br><span class="line">    cdev_add(&amp;hello_cdev, devid, HELLO_CNT);    <span class="comment">// 添加指定个数的字符设备</span></span><br><span class="line">    device_create(cls , <span class="literal">NULL</span> , MKDEV(major, <span class="number">0</span>), <span class="string">"hello0"</span>);  <span class="comment">// 和 class_device_create 没有本质区别.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本质上, 就是自己实现一遍 <code>register_chrdev</code> 函数里的内容, 来控制子设备号个数.<br>博客里 <a href="https://draapho.github.io/2017/11/30/1740-drv-chr2/">驱动之基于LinK+设计按键驱动</a> 这些内容都是由 <code>LinK+</code> 自动实现的.</p>
<h1 id="RTC源码分析"><a href="#RTC源码分析" class="headerlink" title="RTC源码分析"></a>RTC源码分析</h1><p>这里以RTC源码为例进行分析, 用于熟悉字符设备的写法和分离分层即platform的概念</p>
<p><code>/drivers/rtc/rtc-dev.c</code> 提供了所有的RTC驱动层读写函数.<br>里面进一步调用了 <code>/drivers/rtc/class.c</code> 的一些函数.<br>这两个文件是linux内核RTC驱动设备的软件抽象核心.</p>
<p>显然的, 后面的很多文件是芯片厂商提供的硬件相关的RTC部分. 譬如 <code>rtc-s3c.c</code>.<br>也可以通过分析 <code>rtc-dev.c</code> 里的 <code>rtc_dev_add_device</code> 倒过来找到这些文件.</p>
<p>下面, 我们从底层硬件(<code>rtc-s3c.c</code>)往上层进行分析, 看看rtc字符设备的整个注册过程.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// subsys_initcall(rtc_init), 系统初始化时调用</span></span><br><span class="line">rtc_init();                                         <span class="comment">// 此函数位于 "class.c"</span></span><br><span class="line">    class_create(THIS_MODULE, <span class="string">"rtc"</span>);               <span class="comment">// =====&gt; class_create</span></span><br><span class="line">    rtc_dev_init();</span><br><span class="line">        alloc_chrdev_region();                      <span class="comment">// =====&gt; alloc_chrdev_region, 分配 RTC_DEV_MAX 个子设备号</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// module_init(s3c_rtc_init), 驱动入口函数. insmod 时被调用</span></span><br><span class="line">s3c_rtc_init();                                     <span class="comment">// 此函数位于 "rtc-s3c.c"</span></span><br><span class="line">    platform_driver_register(&amp;s3c2410_rtcdrv);</span><br><span class="line">    <span class="comment">// 明显用了platform框架, 根据 .name = "s3c2410-rtc" 去找 platform_device_register</span></span><br><span class="line">    <span class="comment">// 在 "/arch/arm/plat-s3c24xx/devs.c" 下找到了 s3c_device_rtc. 但没有被内核调用. 后面再说.</span></span><br><span class="line">s3c_rtc_probe();                                    <span class="comment">// platform 的 driver 和 device 匹配后, 自动调用 probe</span></span><br><span class="line">    <span class="comment">// 一系列的RTC硬件相关操作, 忽略</span></span><br><span class="line">    rtc_device_register();                          <span class="comment">// 此函数位于 "class.c"</span></span><br><span class="line">        rtc_dev_prepare();                          <span class="comment">// 此函数位于 "rtc-dev.c"</span></span><br><span class="line">            rtc-&gt;dev.devt = MKDEV(MAJOR(rtc_devt), rtc-&gt;id);</span><br><span class="line">            cdev_init();                            <span class="comment">// =====&gt; cdev_init</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// device_create 里最终调用的就是 device_register.</span></span><br><span class="line">        <span class="comment">// rtc-&gt;dev.devt 的值已经在 rtc_dev_prepare 设置好了.</span></span><br><span class="line">        device_register();                          <span class="comment">// =====&gt; 等效于 device_create.</span></span><br><span class="line">        rtc_dev_add_device();</span><br><span class="line">            cdev_add();                             <span class="comment">// =====&gt; cdev_add</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这两个函数似乎也和设备注册相关. 详请不明</span></span><br><span class="line">        rtc_sysfs_add_device();</span><br><span class="line">        rtc_proc_add_device();</span><br></pre></td></tr></table></figure>
<h1 id="RTC-测试"><a href="#RTC-测试" class="headerlink" title="RTC 测试"></a>RTC 测试</h1><p>前面的分析源码说过, <code>s3c_device_rtc</code> 没有被调用, 因此当前的系统也无法使用rtc.<br>这里就加入rtc功能, 并测试.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu 主机端</span></span><br><span class="line"><span class="comment"># pwd = ./linux-2.6.22.6</span></span><br><span class="line"><span class="comment"># 打开 ./arch/arm/plat-s3c24xx/common-smdk.c</span></span><br><span class="line">    <span class="comment"># 找到数组 static struct platform_device __initdata *smdk_devs[]</span></span><br><span class="line">    <span class="comment"># 加入一行   &amp;s3c_device_rtc,</span></span><br><span class="line">    <span class="comment"># 此数组会被 "smdk_machine_init" 调用, 里面有 "platform_add_devices",</span></span><br><span class="line">    <span class="comment"># 此函数会对数组里的内容依次进行 "platform_device_register"</span></span><br><span class="line"></span><br><span class="line">$ make clean                                    <span class="comment"># 没把握的话, clean一下</span></span><br><span class="line">$ make uImage</span><br><span class="line"><span class="comment"># 烧录新的uImage</span></span><br><span class="line"><span class="comment"># 重启开发板进入uboot烧录界面, 按k准备烧录内核. 略过不表</span></span><br><span class="line">$ sudo dnw ./arch/arm/boot/uImage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发板端, 开始测试</span></span><br><span class="line">$ ls /dev/rtc* -l                               <span class="comment"># 查看设备, 有 rtc0</span></span><br><span class="line">$ date                                          <span class="comment"># 显示系统时间</span></span><br><span class="line">Mon Apr  3 06:53:50 UTC 2006</span><br><span class="line"></span><br><span class="line">$ date 020811002018.30                          <span class="comment"># 设置系统时间 date [MMDDhhmm[[CC]YY][.ss]]</span></span><br><span class="line">Thu Feb  8 11:00:30 UTC 2018</span><br><span class="line">$ hwclock -w                                    <span class="comment"># 把系统时间写入RTC. HardWare CLOCK</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 断电, 重启.</span></span><br><span class="line">$ date</span><br><span class="line">Thu Feb  8 11:02:01 UTC 2018                    <span class="comment"># 设置的时间还在.</span></span><br></pre></td></tr></table></figure>
<hr>
<p><strong><em>原创于 <a href="https://draapho.github.io/">DRA&amp;PHO</a></em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/02/06/1813-drv-net/" itemprop="url">
                  驱动之网卡驱动
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2018-02-06T00:00:00+11:00" content="2018-02-06">
              2018-02-06
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><ul>
<li><a href="https://draapho.github.io/2017/11/23/1734-linux-content/">嵌入式linux学习目录</a></li>
<li><a href="https://draapho.github.io/2018/01/22/1809-drv-blk/">驱动之块设备-框架</a></li>
<li><a href="https://draapho.github.io/2018/01/24/1810-drv-nand1/">驱动之NAND Flash框架</a></li>
<li><a href="https://draapho.github.io/2018/01/25/1811-drv-nand2/">驱动之NAND Flash源码</a></li>
<li><a href="https://draapho.github.io/2018/01/26/1812-drv-nor/">驱动之NOR Flash</a></li>
<li><a href="https://draapho.github.io/2018/02/06/1813-drv-net/">驱动之网卡驱动</a></li>
</ul>
<p>本文使用 linux-2.6.22.6 内核, 使用jz2440开发板.</p>
<h1 id="虚拟网卡源码"><a href="#虚拟网卡源码" class="headerlink" title="虚拟网卡源码"></a>虚拟网卡源码</h1><p>网络驱动的实现很复杂, Linux内核都帮我们做掉了, 对用户端直接进行socket编程即可.<br>而具体到硬件, 网卡驱动十分简单. 与网络驱动通过二个函数和一个变量.</p>
<ul>
<li>网卡发送函数: <code>hard_start_xmit</code></li>
<li>网卡接收函数: <code>netif_rx</code></li>
<li>数据: <code>sk_buff</code></li>
</ul>
<p>网卡驱动的基本步骤:</p>
<ol>
<li>分配一个 <code>net_device</code> 结构体: <code>alloc_netdev</code></li>
<li>设置: 实现发送 <code>hard_start_xmit</code>, 接收 <code>netif_rx</code>, 以及其它设置</li>
<li>发送函数注意使用 <code>netif_stop_queue</code> <code>dev_kfree_skb_irq</code> <code>netif_wake_queue</code></li>
<li>注册: <code>register_netdev</code>.</li>
</ol>
<h2 id="vnet-c"><a href="#vnet-c" class="headerlink" title="vnet.c"></a>vnet.c</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参考 drivers\net\cs89x0.c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netdevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/etherdevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/interrupt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ioport.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/skbuff.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/spinlock.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bitops.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/system.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/irq.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"DRAAPHO"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">vnet_dev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 参考LDD3, 虚构一个ping应答包</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">emulator_rx_packet</span><span class="params">(struct sk_buff *skb, struct net_device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *type;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">ih</span>;</span></span><br><span class="line">    __be32 *saddr, *daddr, tmp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>   tmp_dev_addr[ETH_ALEN];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ethhdr</span> *<span class="title">ethhdr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">rx_skb</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从硬件读出/保存数据</span></span><br><span class="line">    ethhdr = (struct ethhdr *)skb-&gt;data;                        <span class="comment">// 对调源/目的的mac地址</span></span><br><span class="line">    <span class="built_in">memcpy</span>(tmp_dev_addr, ethhdr-&gt;h_dest, ETH_ALEN);</span><br><span class="line">    <span class="built_in">memcpy</span>(ethhdr-&gt;h_dest, ethhdr-&gt;h_source, ETH_ALEN);</span><br><span class="line">    <span class="built_in">memcpy</span>(ethhdr-&gt;h_source, tmp_dev_addr, ETH_ALEN);</span><br><span class="line"></span><br><span class="line">    ih = (struct iphdr *)(skb-&gt;data + <span class="keyword">sizeof</span>(struct ethhdr));   <span class="comment">// 对调源/目的的ip地址</span></span><br><span class="line">    saddr = &amp;ih-&gt;saddr;</span><br><span class="line">    daddr = &amp;ih-&gt;daddr;</span><br><span class="line">    tmp = *saddr;</span><br><span class="line">    *saddr = *daddr;</span><br><span class="line">    *daddr = tmp;</span><br><span class="line">    <span class="comment">//((u8 *)saddr)[2] ^= 1; /* change the third octet (class C) */</span></span><br><span class="line">    <span class="comment">//((u8 *)daddr)[2] ^= 1;</span></span><br><span class="line"></span><br><span class="line">    type = skb-&gt;data + <span class="keyword">sizeof</span>(struct ethhdr) + <span class="keyword">sizeof</span>(struct iphdr);</span><br><span class="line">    <span class="comment">// printk("tx package type = %02x\n", *type);</span></span><br><span class="line">    *type = <span class="number">0</span>;                                  <span class="comment">// 修改类型, 原来0x8表示ping, 0表示reply</span></span><br><span class="line">    ih-&gt;check = <span class="number">0</span>;                              <span class="comment">// rebuild the checksum (ip needs it)</span></span><br><span class="line">    ih-&gt;check = ip_fast_csum((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)ih,ih-&gt;ihl);</span><br><span class="line"></span><br><span class="line">    rx_skb = dev_alloc_skb(skb-&gt;len + <span class="number">2</span>);       <span class="comment">// 构造一个sk_buff</span></span><br><span class="line">    skb_reserve(rx_skb, <span class="number">2</span>);                     <span class="comment">// align IP on 16B boundary</span></span><br><span class="line">    <span class="built_in">memcpy</span>(skb_put(rx_skb, skb-&gt;len), skb-&gt;data, skb-&gt;len);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Write metadata, and then pass to the receive level */</span></span><br><span class="line">    rx_skb-&gt;dev = dev;</span><br><span class="line">    rx_skb-&gt;protocol = eth_type_trans(rx_skb, dev);</span><br><span class="line">    rx_skb-&gt;ip_summed = CHECKSUM_UNNECESSARY; <span class="comment">/* don't check it */</span></span><br><span class="line">    dev-&gt;stats.rx_packets++;</span><br><span class="line">    dev-&gt;stats.rx_bytes += skb-&gt;len;</span><br><span class="line"></span><br><span class="line">    netif_rx(rx_skb);                           <span class="comment">// 提交sk_buff</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">vnet_send_packet</span><span class="params">(struct sk_buff *skb, struct net_device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    printk(<span class="string">"virt_net_send_packet cnt = %d\n"</span>, ++cnt);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 对于真实的网卡, 把skb里的数据通过网卡发送出去 */</span></span><br><span class="line">    netif_stop_queue(dev);                      <span class="comment">// 停止该网卡的队列</span></span><br><span class="line">    <span class="comment">/* 实际网卡的话, 把skb的数据写入网卡 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 用发送的数据虚构应答数据, 所以放这里了</span></span><br><span class="line"><span class="comment">     * 实际网卡应该是用中断实现数据接收和 netif_rx 上报的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    emulator_rx_packet(skb, dev);</span><br><span class="line">    dev-&gt;stats.tx_packets++;                    <span class="comment">// 更新统计信息</span></span><br><span class="line">    dev-&gt;stats.tx_bytes += skb-&gt;len;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 中断里的话, 需要使用 dev_kfree_skb_irq</span></span><br><span class="line">    dev_kfree_skb (skb);                        <span class="comment">// 释放skb.</span></span><br><span class="line">    netif_wake_queue(dev);                      <span class="comment">// 数据全部发送出去后,唤醒网卡的队列</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">vnet_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 1. 分配一个net_device结构体 */</span></span><br><span class="line">    vnet_dev = alloc_netdev(<span class="number">0</span>, <span class="string">"vnet%d"</span>, ether_setup);</span><br><span class="line">    <span class="comment">// 也可用 alloc_etherdev 指定了网卡名称为 eth%d</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2. 设置 */</span></span><br><span class="line">    vnet_dev-&gt;hard_start_xmit = vnet_send_packet;   <span class="comment">// 指定发送函数</span></span><br><span class="line">    vnet_dev-&gt;dev_addr[<span class="number">0</span>] = <span class="number">0x08</span>;                   <span class="comment">// 设置MAC地址</span></span><br><span class="line">    vnet_dev-&gt;dev_addr[<span class="number">1</span>] = <span class="number">0x89</span>;</span><br><span class="line">    vnet_dev-&gt;dev_addr[<span class="number">2</span>] = <span class="number">0x89</span>;</span><br><span class="line">    vnet_dev-&gt;dev_addr[<span class="number">3</span>] = <span class="number">0x89</span>;</span><br><span class="line">    vnet_dev-&gt;dev_addr[<span class="number">4</span>] = <span class="number">0x89</span>;</span><br><span class="line">    vnet_dev-&gt;dev_addr[<span class="number">5</span>] = <span class="number">0x11</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置下面两项才能ping通</span></span><br><span class="line">    vnet_dev-&gt;flags    |= IFF_NOARP;</span><br><span class="line">    vnet_dev-&gt;features |= NETIF_F_NO_CSUM;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3. 注册 */</span></span><br><span class="line">    register_netdev(vnet_dev);</span><br><span class="line">    <span class="comment">// 不建议直接使用 register_netdevice.</span></span><br><span class="line">    <span class="comment">// register_netdev 是 register_netdevice 的加锁版.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">vnet_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    unregister_netdev(vnet_dev);</span><br><span class="line">    free_netdev(vnet_dev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(vnet_init);</span><br><span class="line">module_exit(vnet_exit);</span><br></pre></td></tr></table></figure>
<h2 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">obj-m       := vnet.o</span><br><span class="line">KERN_SRC    := /home/draapho/share/jz2440/kernel/linux-2.6.22.6/</span><br><span class="line">PWD         := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line"></span><br><span class="line"><span class="section">modules:</span></span><br><span class="line">    make -C <span class="variable">$(KERN_SRC)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    make -C <span class="variable">$(KERN_SRC)</span> M=<span class="variable">$(PWD)</span> clean</span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu 主机端</span></span><br><span class="line"><span class="comment"># pwd = ~/share/jz2440/drivers/net/             # net驱动目录</span></span><br><span class="line">$ make modules                                  <span class="comment"># 生成vnet.ko</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发板端, 开始测试</span></span><br><span class="line"><span class="comment"># pwd = ~/share/jz2440/drivers/net/             # net驱动目录, nfs</span></span><br><span class="line">$ insmod vnet.ko                                <span class="comment"># 加载驱动</span></span><br><span class="line"></span><br><span class="line">$ ifconfig vnet0 3.3.3.3                        <span class="comment"># 设置ip</span></span><br><span class="line">$ ifconfig                                      <span class="comment"># 查看网卡信息</span></span><br><span class="line">eth0      ......</span><br><span class="line">vnet0     Link encap:Ethernet  HWaddr 08:89:89:89:89:11             <span class="comment"># mac地址</span></span><br><span class="line">          inet addr:3.3.3.3  Bcast:3.255.255.255  Mask:255.0.0.0    <span class="comment"># ip地址相关</span></span><br><span class="line">          UP BROADCAST RUNNING NOARP MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">$ ping 3.3.3.3                                  <span class="comment"># ping自己</span></span><br><span class="line">PING 3.3.3.3 (3.3.3.3): 56 data bytes</span><br><span class="line"><span class="comment"># 这里没有应答, 应该是没有设置lo回环的关系.</span></span><br><span class="line"><span class="comment"># 可以知道 ping 自己不会调用到底层的网卡驱动</span></span><br><span class="line">$ ping 3.3.3.4                                  <span class="comment"># ping其它网段</span></span><br><span class="line">PING 3.3.3.4 (3.3.3.4): 56 data bytes</span><br><span class="line">virt_net_send_packet cnt = 1                    <span class="comment"># 代码里的发送计数</span></span><br><span class="line">64 bytes from 3.3.3.4: seq=0 ttl=64 time=0.856 ms</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">$ ifconfig                                      <span class="comment"># 查看网卡信息</span></span><br><span class="line"><span class="comment"># 可以查看 RX packets, TX packets, RX bytes, TX bytes</span></span><br></pre></td></tr></table></figure>
<h1 id="移植网卡驱动"><a href="#移植网卡驱动" class="headerlink" title="移植网卡驱动"></a>移植网卡驱动</h1><p>在实际选用网卡时, 网卡厂商都会提供linux驱动.<br>只需要在此基础上, 针对自己的板子, 部分修改即可.<br>网卡对于s3c2440而言, 其物理接口用的是 <code>MEMORY CONTROLLER</code><br>主要的注意点如下:</p>
<ul>
<li>网卡位宽: 8/16, 实际用的16位宽</li>
<li>片选使用了 <code>nGCS4</code>, 对应基地址为 <code>0x20000000</code></li>
<li>DM9000C 的<code>CMD</code>接的是<code>LADDR2</code>, 因此读指令时, LADDR2要置位.</li>
<li>收发数据时, 中断引脚的设置.</li>
<li>初始化时, S3C2440端相关的寄存器设置.</li>
<li>复位应交 <code>nRESET</code>, 如果需要软件对网卡进行硬件复位, 则需要自己实现.</li>
<li>其它引脚如 <code>LANACK</code> <code>LANLINK</code>, 可知接到led上的, 无需关心.</li>
</ul>
<h2 id="dm9dev9000c-c"><a href="#dm9dev9000c-c" class="headerlink" title="dm9dev9000c.c"></a>dm9dev9000c.c</h2><p>下面, 基于 DM9000C 的厂家驱动, 针对 jz2440 开发板进行修改.<br>修改的地方全部会打上标记 <code>===== for jz2440 =====</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br><span class="line">1458</span><br><span class="line">1459</span><br><span class="line">1460</span><br><span class="line">1461</span><br><span class="line">1462</span><br><span class="line">1463</span><br><span class="line">1464</span><br><span class="line">1465</span><br><span class="line">1466</span><br><span class="line">1467</span><br><span class="line">1468</span><br><span class="line">1469</span><br><span class="line">1470</span><br><span class="line">1471</span><br><span class="line">1472</span><br><span class="line">1473</span><br><span class="line">1474</span><br><span class="line">1475</span><br><span class="line">1476</span><br><span class="line">1477</span><br><span class="line">1478</span><br><span class="line">1479</span><br><span class="line">1480</span><br><span class="line">1481</span><br><span class="line">1482</span><br><span class="line">1483</span><br><span class="line">1484</span><br><span class="line">1485</span><br><span class="line">1486</span><br><span class="line">1487</span><br><span class="line">1488</span><br><span class="line">1489</span><br><span class="line">1490</span><br><span class="line">1491</span><br><span class="line">1492</span><br><span class="line">1493</span><br><span class="line">1494</span><br><span class="line">1495</span><br><span class="line">1496</span><br><span class="line">1497</span><br><span class="line">1498</span><br><span class="line">1499</span><br><span class="line">1500</span><br><span class="line">1501</span><br><span class="line">1502</span><br><span class="line">1503</span><br><span class="line">1504</span><br><span class="line">1505</span><br><span class="line">1506</span><br><span class="line">1507</span><br><span class="line">1508</span><br><span class="line">1509</span><br><span class="line">1510</span><br><span class="line">1511</span><br><span class="line">1512</span><br><span class="line">1513</span><br><span class="line">1514</span><br><span class="line">1515</span><br><span class="line">1516</span><br><span class="line">1517</span><br><span class="line">1518</span><br><span class="line">1519</span><br><span class="line">1520</span><br><span class="line">1521</span><br><span class="line">1522</span><br><span class="line">1523</span><br><span class="line">1524</span><br><span class="line">1525</span><br><span class="line">1526</span><br><span class="line">1527</span><br><span class="line">1528</span><br><span class="line">1529</span><br><span class="line">1530</span><br><span class="line">1531</span><br><span class="line">1532</span><br><span class="line">1533</span><br><span class="line">1534</span><br><span class="line">1535</span><br><span class="line">1536</span><br><span class="line">1537</span><br><span class="line">1538</span><br><span class="line">1539</span><br><span class="line">1540</span><br><span class="line">1541</span><br><span class="line">1542</span><br><span class="line">1543</span><br><span class="line">1544</span><br><span class="line">1545</span><br><span class="line">1546</span><br><span class="line">1547</span><br><span class="line">1548</span><br><span class="line">1549</span><br><span class="line">1550</span><br><span class="line">1551</span><br><span class="line">1552</span><br><span class="line">1553</span><br><span class="line">1554</span><br><span class="line">1555</span><br><span class="line">1556</span><br><span class="line">1557</span><br><span class="line">1558</span><br><span class="line">1559</span><br><span class="line">1560</span><br><span class="line">1561</span><br><span class="line">1562</span><br><span class="line">1563</span><br><span class="line">1564</span><br><span class="line">1565</span><br><span class="line">1566</span><br><span class="line">1567</span><br><span class="line">1568</span><br><span class="line">1569</span><br><span class="line">1570</span><br><span class="line">1571</span><br><span class="line">1572</span><br><span class="line">1573</span><br><span class="line">1574</span><br><span class="line">1575</span><br><span class="line">1576</span><br><span class="line">1577</span><br><span class="line">1578</span><br><span class="line">1579</span><br><span class="line">1580</span><br><span class="line">1581</span><br><span class="line">1582</span><br><span class="line">1583</span><br><span class="line">1584</span><br><span class="line">1585</span><br><span class="line">1586</span><br><span class="line">1587</span><br><span class="line">1588</span><br><span class="line">1589</span><br><span class="line">1590</span><br><span class="line">1591</span><br><span class="line">1592</span><br><span class="line">1593</span><br><span class="line">1594</span><br><span class="line">1595</span><br><span class="line">1596</span><br><span class="line">1597</span><br><span class="line">1598</span><br><span class="line">1599</span><br><span class="line">1600</span><br><span class="line">1601</span><br><span class="line">1602</span><br><span class="line">1603</span><br><span class="line">1604</span><br><span class="line">1605</span><br><span class="line">1606</span><br><span class="line">1607</span><br><span class="line">1608</span><br><span class="line">1609</span><br><span class="line">1610</span><br><span class="line">1611</span><br><span class="line">1612</span><br><span class="line">1613</span><br><span class="line">1614</span><br><span class="line">1615</span><br><span class="line">1616</span><br><span class="line">1617</span><br><span class="line">1618</span><br><span class="line">1619</span><br><span class="line">1620</span><br><span class="line">1621</span><br><span class="line">1622</span><br><span class="line">1623</span><br><span class="line">1624</span><br><span class="line">1625</span><br><span class="line">1626</span><br><span class="line">1627</span><br><span class="line">1628</span><br><span class="line">1629</span><br><span class="line">1630</span><br><span class="line">1631</span><br><span class="line">1632</span><br><span class="line">1633</span><br><span class="line">1634</span><br><span class="line">1635</span><br><span class="line">1636</span><br><span class="line">1637</span><br><span class="line">1638</span><br><span class="line">1639</span><br><span class="line">1640</span><br><span class="line">1641</span><br><span class="line">1642</span><br><span class="line">1643</span><br><span class="line">1644</span><br><span class="line">1645</span><br><span class="line">1646</span><br><span class="line">1647</span><br><span class="line">1648</span><br><span class="line">1649</span><br><span class="line">1650</span><br><span class="line">1651</span><br><span class="line">1652</span><br><span class="line">1653</span><br><span class="line">1654</span><br><span class="line">1655</span><br><span class="line">1656</span><br><span class="line">1657</span><br><span class="line">1658</span><br><span class="line">1659</span><br><span class="line">1660</span><br><span class="line">1661</span><br><span class="line">1662</span><br><span class="line">1663</span><br><span class="line">1664</span><br><span class="line">1665</span><br><span class="line">1666</span><br><span class="line">1667</span><br><span class="line">1668</span><br><span class="line">1669</span><br><span class="line">1670</span><br><span class="line">1671</span><br><span class="line">1672</span><br><span class="line">1673</span><br><span class="line">1674</span><br><span class="line">1675</span><br><span class="line">1676</span><br><span class="line">1677</span><br><span class="line">1678</span><br><span class="line">1679</span><br><span class="line">1680</span><br><span class="line">1681</span><br><span class="line">1682</span><br><span class="line">1683</span><br><span class="line">1684</span><br><span class="line">1685</span><br><span class="line">1686</span><br><span class="line">1687</span><br><span class="line">1688</span><br><span class="line">1689</span><br><span class="line">1690</span><br><span class="line">1691</span><br><span class="line">1692</span><br><span class="line">1693</span><br><span class="line">1694</span><br><span class="line">1695</span><br><span class="line">1696</span><br><span class="line">1697</span><br><span class="line">1698</span><br><span class="line">1699</span><br><span class="line">1700</span><br><span class="line">1701</span><br><span class="line">1702</span><br><span class="line">1703</span><br><span class="line">1704</span><br><span class="line">1705</span><br><span class="line">1706</span><br><span class="line">1707</span><br><span class="line">1708</span><br><span class="line">1709</span><br><span class="line">1710</span><br><span class="line">1711</span><br><span class="line">1712</span><br><span class="line">1713</span><br><span class="line">1714</span><br><span class="line">1715</span><br><span class="line">1716</span><br><span class="line">1717</span><br><span class="line">1718</span><br><span class="line">1719</span><br><span class="line">1720</span><br><span class="line">1721</span><br><span class="line">1722</span><br><span class="line">1723</span><br><span class="line">1724</span><br><span class="line">1725</span><br><span class="line">1726</span><br><span class="line">1727</span><br><span class="line">1728</span><br><span class="line">1729</span><br><span class="line">1730</span><br><span class="line">1731</span><br><span class="line">1732</span><br><span class="line">1733</span><br><span class="line">1734</span><br><span class="line">1735</span><br><span class="line">1736</span><br><span class="line">1737</span><br><span class="line">1738</span><br><span class="line">1739</span><br><span class="line">1740</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  dm9ks.c: Version 2.08 2007/02/12</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        A Davicom DM9000/DM9010 ISA NIC fast Ethernet driver for Linux.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    This program is free software; you can redistribute it and/or</span></span><br><span class="line"><span class="comment">    modify it under the terms of the GNU General Public License</span></span><br><span class="line"><span class="comment">    as published by the Free Software Foundation; either version 2</span></span><br><span class="line"><span class="comment">    of the License, or (at your option) any later version.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">    GNU General Public License for more details.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  (C)Copyright 1997-2007 DAVICOM Semiconductor,Inc. All Rights Reserved.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">V2.00 Spenser - 01/10/2005</span></span><br><span class="line"><span class="comment">            - Modification for PXA270 MAINSTONE.</span></span><br><span class="line"><span class="comment">            - Modified dmfe_tx_done().</span></span><br><span class="line"><span class="comment">            - Add dmfe_timeout().</span></span><br><span class="line"><span class="comment">V2.01   10/07/2005  -Modified dmfe_timer()</span></span><br><span class="line"><span class="comment">            -Dected network speed 10/100M</span></span><br><span class="line"><span class="comment">V2.02   10/12/2005  -Use link change to chage db-&gt;Speed</span></span><br><span class="line"><span class="comment">            -dmfe_open() wait for Link OK</span></span><br><span class="line"><span class="comment">V2.03   11/22/2005  -Power-off and Power-on PHY in dmfe_init_dm9000()</span></span><br><span class="line"><span class="comment">            -support IOL</span></span><br><span class="line"><span class="comment">V2.04   12/13/2005  -delay 1.6s between power-on and power-off in</span></span><br><span class="line"><span class="comment">             dmfe_init_dm9000()</span></span><br><span class="line"><span class="comment">            -set LED mode 1 in dmfe_init_dm9000()</span></span><br><span class="line"><span class="comment">            -add data bus driving capability in dmfe_init_dm9000()</span></span><br><span class="line"><span class="comment">             (optional)</span></span><br><span class="line"><span class="comment">10/3/2006   -Add DM8606 read/write function by MDC and MDIO</span></span><br><span class="line"><span class="comment">V2.06   01/03/2007  -CONT_RX_PKT_CNT=0xFFFF</span></span><br><span class="line"><span class="comment">            -modify dmfe_tx_done function</span></span><br><span class="line"><span class="comment">            -check RX FIFO pointer</span></span><br><span class="line"><span class="comment">            -if using physical address, re-define I/O function</span></span><br><span class="line"><span class="comment">            -add db-&gt;cont_rx_pkt_cnt=0 at the front of dmfe_packet_receive()</span></span><br><span class="line"><span class="comment">V2.08   02/12/2007  -module parameter macro</span></span><br><span class="line"><span class="comment">            2.4  MODULE_PARM</span></span><br><span class="line"><span class="comment">            2.6  module_param</span></span><br><span class="line"><span class="comment">            -remove #include &lt;linux/config&gt;</span></span><br><span class="line"><span class="comment">            -fix dmfe_interrupt for kernel 2.6.20</span></span><br><span class="line"><span class="comment">V2.09 05/24/2007    -support ethtool and mii-tool</span></span><br><span class="line"><span class="comment">05/30/2007  -fix the driver bug when ifconfig eth0 (-)promisc and (-)allmulti.</span></span><br><span class="line"><span class="comment">06/05/2007  -fix dm9000b issue(ex. 10M TX idle=65mA, 10M harmonic)</span></span><br><span class="line"><span class="comment">            -add flow control function (option)</span></span><br><span class="line"><span class="comment">10/01/2007  -Add #include &lt;asm/uaccess.h&gt;</span></span><br><span class="line"><span class="comment">            -Modyfy dmfe_do_ioctl for kernel 2.6.7</span></span><br><span class="line"><span class="comment">11/23/2007  -Add TDBUG to check TX FIFO pointer shift</span></span><br><span class="line"><span class="comment">            - Remove check_rx_ready()</span></span><br><span class="line"><span class="comment">        - Add #define CHECKSUM to modify CHECKSUM function</span></span><br><span class="line"><span class="comment">12/20/2007  -Modify TX timeout routine(+)check TCR&amp;0x01</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#define CHECKSUM</span></span><br><span class="line"><span class="comment">//#define TDBUG     /* check TX FIFO pointer */</span></span><br><span class="line"><span class="comment">//#define RDBUG   /* check RX FIFO pointer */</span></span><br><span class="line"><span class="comment">//#define DM8606</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DRV_NAME    <span class="meta-string">"dm9KS"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DRV_VERSION <span class="meta-string">"2.09"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DRV_RELDATE <span class="meta-string">"2007-11-22"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MODVERSIONS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/modversions.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#include &lt;linux/config.h&gt;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ioport.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netdevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/etherdevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/skbuff.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/dma.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/spinlock.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/crc32.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mii.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ethtool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ARCH_MAINSTONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/hardware.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/irq.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== for jz2440 =====</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/irq.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/arch-s3c2410/regs-mem.h&gt;</span></span></span><br><span class="line"><span class="comment">// ===== end =====</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Board/System/Debug information/definition ---------------- */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_ID        0x90000A46</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9010_ID       0x90100A46</span></span><br><span class="line"><span class="comment">/*-------register name-----------------------*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_NCR       0x00    <span class="comment">/* Network control Reg.*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_NSR       0x01    <span class="comment">/* Network Status Reg.*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_TCR       0x02    <span class="comment">/* TX control Reg.*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_RXCR      0x05    <span class="comment">/* RX control Reg.*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_BPTR      0x08</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_FCTR      0x09</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_FCR           0x0a</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_EPCR      0x0b</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_EPAR      0x0c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_EPDRL     0x0d</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_EPDRH     0x0e</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_GPR           0x1f    <span class="comment">/* General purpose register */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_CHIPR     0x2c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_TCR2      0x2d</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_SMCR      0x2f    <span class="comment">/* Special Mode Control Reg.*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_ETXCSR    0x30    <span class="comment">/* Early Transmit control/status Reg.*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_TCCR      0x31    <span class="comment">/* Checksum cntrol Reg. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_RCSR      0x32    <span class="comment">/* Receive Checksum status Reg.*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_BUSCR     0x38</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_MRCMDX    0xf0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_MRCMD     0xf2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_MDRAL     0xf4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_MDRAH     0xf5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_MWCMD     0xf8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_MDWAL     0xfa</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_MDWAH     0xfb</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_TXPLL     0xfc</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_TXPLH     0xfd</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_ISR           0xfe</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_IMR           0xff</span></span><br><span class="line"><span class="comment">/*---------------------------------------------*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_REG05     0x30    <span class="comment">/* SKIP_CRC/SKIP_LONG */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_REGFF     0xA3    <span class="comment">/* IMR */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_DISINTR   0x80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_PHY           0x40    <span class="comment">/* PHY address 0x01 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_PKT_RDY       0x01    <span class="comment">/* Packet ready to receive */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Added for PXA of MAINSTONE */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ARCH_MAINSTONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/arch/mainstone.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_MIN_IO        (MST_ETH_PHYS + 0x300)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_MAX_IO            (MST_ETH_PHYS + 0x370)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9K_IRQ        MAINSTONE_IRQ(3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_MIN_IO        0x300</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_MAX_IO        0x370</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_IRQ       3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_VID_L     0x28</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_VID_H     0x29</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_PID_L     0x2A</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_PID_H     0x2B</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_RX_INTR       0x01</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_TX_INTR       0x02</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_LINK_INTR     0x20</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_DWORD_MODE    1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_BYTE_MODE     2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DM9KS_WORD_MODE     0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TRUE            1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FALSE           0</span></span><br><span class="line"><span class="comment">/* Number of continuous Rx packets */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONT_RX_PKT_CNT     0xFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DMFE_TIMER_WUT  jiffies+(HZ*5)  <span class="comment">/* timer wakeup time : 5 second */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DM9KS_DEBUG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DMFE_DBUG(dbug_now, msg, vaule)\</span></span><br><span class="line"><span class="keyword">if</span> (dmfe_debug||dbug_now) printk(KERN_ERR <span class="string">"dmfe: %s %x\n"</span>, msg, vaule)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DMFE_DBUG(dbug_now, msg, vaule)\</span></span><br><span class="line"><span class="keyword">if</span> (dbug_now) printk(KERN_ERR <span class="string">"dmfe: %s %x\n"</span>, msg, vaule)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_ARCH_MAINSTONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack(push, 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RX_DESC</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    u8 rxbyte;</span><br><span class="line">    u8 status;</span><br><span class="line">    u16 length;</span><br><span class="line">&#125;RX_DESC;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span>&#123;</span><br><span class="line">    u8 buf[<span class="number">4</span>];</span><br><span class="line">    RX_DESC desc;</span><br><span class="line">&#125; <span class="keyword">rx_t</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_ARCH_MAINSTONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack(pop)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> DM9KS_PHY_mode &#123;</span><br><span class="line">    DM9KS_10MHD   = <span class="number">0</span>,</span><br><span class="line">    DM9KS_100MHD  = <span class="number">1</span>,</span><br><span class="line">    DM9KS_10MFD   = <span class="number">4</span>,</span><br><span class="line">    DM9KS_100MFD  = <span class="number">5</span>,</span><br><span class="line">    DM9KS_AUTO    = <span class="number">8</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Structure/enum declaration ------------------------------- */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">board_info</span> &#123;</span></span><br><span class="line">    u32 io_addr;<span class="comment">/* Register I/O base address */</span></span><br><span class="line">    u32 io_data;<span class="comment">/* Data I/O address */</span></span><br><span class="line">    u8 op_mode;<span class="comment">/* PHY operation mode */</span></span><br><span class="line">    u8 io_mode;<span class="comment">/* 0:word, 2:byte */</span></span><br><span class="line">    u8 Speed;   <span class="comment">/* current speed */</span></span><br><span class="line">    u8 chip_revision;</span><br><span class="line">    <span class="keyword">int</span> rx_csum;<span class="comment">/* 0:disable, 1:enable */</span></span><br><span class="line"></span><br><span class="line">    u32 reset_counter;<span class="comment">/* counter: RESET */</span></span><br><span class="line">    u32 reset_tx_timeout;<span class="comment">/* RESET caused by TX Timeout */</span></span><br><span class="line">    <span class="keyword">int</span> tx_pkt_cnt;</span><br><span class="line">    <span class="keyword">int</span> cont_rx_pkt_cnt;<span class="comment">/* current number of continuos rx packets  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">net_device_stats</span> <span class="title">stats</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> <span class="title">timer</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> srom[<span class="number">128</span>];</span><br><span class="line">    <span class="keyword">spinlock_t</span> lock;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mii_if_info</span> <span class="title">mii</span>;</span></span><br><span class="line">&#125; <span class="keyword">board_info_t</span>;</span><br><span class="line"><span class="comment">/* Global variable declaration ----------------------------- */</span></span><br><span class="line"><span class="comment">/*static int dmfe_debug = 0;*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> * <span class="title">dmfe_dev</span> = <span class="title">NULL</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">ethtool_ops</span> <span class="title">dmfe_ethtool_ops</span>;</span></span><br><span class="line"><span class="comment">/* For module input parameter */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> mode       = DM9KS_AUTO;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> media_mode = DM9KS_AUTO;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span>  irq        = DM9KS_IRQ;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> iobase     = DM9KS_MIN_IO;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0  <span class="comment">// use physical address; Not virtual address</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> outb</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">undef</span> outb</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> outw</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">undef</span> outw</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> outl</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">undef</span> outl</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> inb</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">undef</span> inb</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> inw</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">undef</span> inw</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> inl</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">undef</span> inl</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">outb</span><span class="params">(u8 reg, u32 ioaddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    (*(<span class="keyword">volatile</span> u8 *)(ioaddr)) = reg;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">outw</span><span class="params">(u16 reg, u32 ioaddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    (*(<span class="keyword">volatile</span> u16 *)(ioaddr)) = reg;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">outl</span><span class="params">(u32 reg, u32 ioaddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    (*(<span class="keyword">volatile</span> u32 *)(ioaddr)) = reg;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">u8 <span class="title">inb</span><span class="params">(u32 ioaddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (*(<span class="keyword">volatile</span> u8 *)(ioaddr));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">u16 <span class="title">inw</span><span class="params">(u32 ioaddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (*(<span class="keyword">volatile</span> u16 *)(ioaddr));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">u32 <span class="title">inl</span><span class="params">(u32 ioaddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (*(<span class="keyword">volatile</span> u32 *)(ioaddr));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* function declaration ------------------------------------- */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dmfe_probe1</span><span class="params">(struct net_device *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_open</span><span class="params">(struct net_device *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_start_xmit</span><span class="params">(struct sk_buff *, struct net_device *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dmfe_tx_done</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dmfe_packet_receive</span><span class="params">(struct net_device *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_stop</span><span class="params">(struct net_device *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> struct net_device_stats * <span class="title">dmfe_get_stats</span><span class="params">(struct net_device *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_do_ioctl</span><span class="params">(struct net_device *, struct ifreq *, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,5,0)</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dmfe_interrupt</span><span class="params">(<span class="keyword">int</span> , <span class="keyword">void</span> *, struct pt_regs *)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,6,19)</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> irqreturn_t <span class="title">dmfe_interrupt</span><span class="params">(<span class="keyword">int</span> , <span class="keyword">void</span> *, struct pt_regs *)</span></span>;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> irqreturn_t <span class="title">dmfe_interrupt</span><span class="params">(<span class="keyword">int</span> , <span class="keyword">void</span> *)</span></span>;<span class="comment">/* for kernel 2.6.20 */</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dmfe_timer</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dmfe_init_dm9000</span><span class="params">(struct net_device *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">cal_CRC</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">unsigned</span> <span class="keyword">int</span>, u8)</span></span>;</span><br><span class="line"><span class="function">u8 <span class="title">ior</span><span class="params">(<span class="keyword">board_info_t</span> *, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">iow</span><span class="params">(<span class="keyword">board_info_t</span> *, <span class="keyword">int</span>, u8)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> u16 <span class="title">phy_read</span><span class="params">(<span class="keyword">board_info_t</span> *, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">phy_write</span><span class="params">(<span class="keyword">board_info_t</span> *, <span class="keyword">int</span>, u16)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> u16 <span class="title">read_srom_word</span><span class="params">(<span class="keyword">board_info_t</span> *, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dm9000_hash_table</span><span class="params">(struct net_device *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dmfe_timeout</span><span class="params">(struct net_device *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dmfe_reset</span><span class="params">(struct net_device *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdio_read</span><span class="params">(struct net_device *, <span class="keyword">int</span>, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mdio_write</span><span class="params">(struct net_device *, <span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dmfe_get_drvinfo</span><span class="params">(struct net_device *, struct ethtool_drvinfo *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_get_settings</span><span class="params">(struct net_device *, struct ethtool_cmd *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_set_settings</span><span class="params">(struct net_device *, struct ethtool_cmd *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> u32 <span class="title">dmfe_get_link</span><span class="params">(struct net_device *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_nway_reset</span><span class="params">(struct net_device *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> uint32_t <span class="title">dmfe_get_rx_csum</span><span class="params">(struct net_device *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> uint32_t <span class="title">dmfe_get_tx_csum</span><span class="params">(struct net_device *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_set_rx_csum</span><span class="params">(struct net_device *, <span class="keyword">uint32_t</span> )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_set_tx_csum</span><span class="params">(struct net_device *, <span class="keyword">uint32_t</span> )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DM8606</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"dm8606.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//DECLARE_TASKLET(dmfe_tx_tasklet,dmfe_tx_done,0);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* DM9000 network baord routine ---------------------------- */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Search DM9000 board, allocate space and register it</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> * __<span class="title">init</span> <span class="title">dmfe_probe</span>(<span class="title">void</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">    DMFE_DBUG(<span class="number">0</span>, <span class="string">"dmfe_probe()"</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,5,0)</span></span><br><span class="line">    dev = init_etherdev(<span class="literal">NULL</span>, <span class="keyword">sizeof</span>(struct board_info));</span><br><span class="line">    <span class="comment">//ether_setup(dev);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    dev= alloc_etherdev(<span class="keyword">sizeof</span>(struct board_info));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!dev)</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">        SET_MODULE_OWNER(dev);</span><br><span class="line">    err = dmfe_probe1(dev);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,5,0)</span></span><br><span class="line">    err = register_netdev(dev);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        <span class="keyword">goto</span> out1;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> dev;</span><br><span class="line">out1:</span><br><span class="line">    release_region(dev-&gt;base_addr,<span class="number">2</span>);</span><br><span class="line">out:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,5,0)</span></span><br><span class="line">    kfree(dev);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    free_netdev(dev);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> __<span class="function">init <span class="title">dmfe_probe1</span><span class="params">(struct net_device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">board_info</span> *<span class="title">db</span>;</span>    <span class="comment">/* Point a board information structure */</span></span><br><span class="line">    u32 id_val;</span><br><span class="line">    u16 i, dm9000_found = FALSE;</span><br><span class="line">    u8 MAC_addr[<span class="number">6</span>]=&#123;<span class="number">0x00</span>,<span class="number">0x60</span>,<span class="number">0x6E</span>,<span class="number">0x33</span>,<span class="number">0x44</span>,<span class="number">0x55</span>&#125;;</span><br><span class="line">    u8 HasEEPROM=<span class="number">0</span>,chip_info;</span><br><span class="line">    DMFE_DBUG(<span class="number">0</span>, <span class="string">"dmfe_probe1()"</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Search All DM9000 serial NIC */</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ===== for jz2440 =====</span></span><br><span class="line"><span class="comment">         * 这里详细说明一下 iobase</span></span><br><span class="line"><span class="comment">         * 片选为 nGCS4, 所以 iobase=0x20000000</span></span><br><span class="line"><span class="comment">         * outb 的时候, LADDR2=0</span></span><br><span class="line"><span class="comment">         * inb(iobase + 4), 相当于 inb(0x20000004),</span></span><br><span class="line"><span class="comment">         * 本质就是让 LADDR2=1, 读指令.</span></span><br><span class="line"><span class="comment">         * ===== end =====</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        outb(DM9KS_VID_L, iobase);</span><br><span class="line">        id_val = inb(iobase + <span class="number">4</span>);</span><br><span class="line">        outb(DM9KS_VID_H, iobase);</span><br><span class="line">        id_val |= inb(iobase + <span class="number">4</span>) &lt;&lt; <span class="number">8</span>;</span><br><span class="line">        outb(DM9KS_PID_L, iobase);</span><br><span class="line">        id_val |= inb(iobase + <span class="number">4</span>) &lt;&lt; <span class="number">16</span>;</span><br><span class="line">        outb(DM9KS_PID_H, iobase);</span><br><span class="line">        id_val |= inb(iobase + <span class="number">4</span>) &lt;&lt; <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id_val == DM9KS_ID || id_val == DM9010_ID) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Request IO from system */</span></span><br><span class="line">            <span class="keyword">if</span>(!request_region(iobase, <span class="number">2</span>, dev-&gt;name))</span><br><span class="line">                <span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line">            printk(KERN_ER<span class="string">R"&lt;DM9KS&gt; I/O: %x, VID: %x \n"</span>,iobase, id_val);</span><br><span class="line">            dm9000_found = TRUE;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Allocated board information structure */</span></span><br><span class="line">            <span class="built_in">memset</span>(dev-&gt;priv, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct board_info));</span><br><span class="line">            db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">            dmfe_dev    = dev;</span><br><span class="line">            db-&gt;io_addr  = iobase;</span><br><span class="line">            db-&gt;io_data = iobase + <span class="number">4</span>;</span><br><span class="line">            db-&gt;chip_revision = ior(db, DM9KS_CHIPR);</span><br><span class="line"></span><br><span class="line">            chip_info = ior(db,<span class="number">0x43</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 取消型号检测, 硬件和给的驱动不匹配, 但能用. ===== for jz2440 =====</span></span><br><span class="line">            <span class="comment">// if((db-&gt;chip_revision!=0x1A) || ((chip_info&amp;(1&lt;&lt;5))!=0) || ((chip_info&amp;(1&lt;&lt;2))!=1)) return -ENODEV;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/* driver system function */</span></span><br><span class="line">            dev-&gt;base_addr      = iobase;</span><br><span class="line">            dev-&gt;irq        = irq;</span><br><span class="line">            dev-&gt;open       = &amp;dmfe_open;</span><br><span class="line">            dev-&gt;hard_start_xmit    = &amp;dmfe_start_xmit;</span><br><span class="line">            dev-&gt;watchdog_timeo = <span class="number">5</span>*HZ;</span><br><span class="line">            dev-&gt;tx_timeout     = dmfe_timeout;</span><br><span class="line">            dev-&gt;stop       = &amp;dmfe_stop;</span><br><span class="line">            dev-&gt;get_stats      = &amp;dmfe_get_stats;</span><br><span class="line">            dev-&gt;set_multicast_list = &amp;dm9000_hash_table;</span><br><span class="line">            dev-&gt;do_ioctl       = &amp;dmfe_do_ioctl;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,28)</span></span><br><span class="line">            dev-&gt;ethtool_ops = &amp;dmfe_ethtool_ops;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CHECKSUM</span></span><br><span class="line">            <span class="comment">//dev-&gt;features |=  NETIF_F_IP_CSUM;</span></span><br><span class="line">            dev-&gt;features |=  NETIF_F_IP_CSUM|NETIF_F_SG;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            db-&gt;mii.dev = dev;</span><br><span class="line">            db-&gt;mii.mdio_read = mdio_read;</span><br><span class="line">            db-&gt;mii.mdio_write = mdio_write;</span><br><span class="line">            db-&gt;mii.phy_id = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,20)</span></span><br><span class="line">            db-&gt;mii.phy_id_mask = <span class="number">0x1F</span>;</span><br><span class="line">            db-&gt;mii.reg_num_mask = <span class="number">0x1F</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="comment">//db-&gt;msg_enable =(debug == 0 ? DMFE_DEF_MSG_ENABLE : ((1 &lt;&lt; debug) - 1));</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Read SROM content */</span></span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">64</span>; i++)</span><br><span class="line">                ((u16 *)db-&gt;srom)[i] = read_srom_word(db, i);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Get the PID and VID from EEPROM to check */</span></span><br><span class="line">            id_val = (((u16 *)db-&gt;srom)[<span class="number">4</span>])|(((u16 *)db-&gt;srom)[<span class="number">5</span>]&lt;&lt;<span class="number">16</span>);</span><br><span class="line">            printk(<span class="string">"id_val=%x\n"</span>, id_val);</span><br><span class="line">            <span class="keyword">if</span> (id_val == DM9KS_ID || id_val == DM9010_ID)</span><br><span class="line">                HasEEPROM =<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Set Node Address */</span></span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">6</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (HasEEPROM) <span class="comment">/* use EEPROM */</span></span><br><span class="line">                    dev-&gt;dev_addr[i] = db-&gt;srom[i];</span><br><span class="line">                <span class="keyword">else</span>    <span class="comment">/* No EEPROM */</span></span><br><span class="line">                    dev-&gt;dev_addr[i] = MAC_addr[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="comment">//end of if()</span></span><br><span class="line">        iobase += <span class="number">0x10</span>;</span><br><span class="line">    &#125;<span class="keyword">while</span>(!dm9000_found &amp;&amp; iobase &lt;= DM9KS_MAX_IO);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dm9000_found ? <span class="number">0</span>:-ENODEV;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Open the interface.</span></span><br><span class="line"><span class="comment">  The interface is opened whenever "ifconfig" actives it.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_open</span><span class="params">(struct net_device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    u8 reg_nsr;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    DMFE_DBUG(<span class="number">0</span>, <span class="string">"dmfe_open"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0表示不触发, 重新设置为上升沿触发中断.  ===== for jz2440 =====</span></span><br><span class="line">    <span class="keyword">if</span> (request_irq(dev-&gt;irq,&amp;dmfe_interrupt,IRQF_TRIGGER_RISING,dev-&gt;name,dev))</span><br><span class="line">    <span class="comment">// if (request_irq(dev-&gt;irq,&amp;dmfe_interrupt,0,dev-&gt;name,dev))</span></span><br><span class="line">        <span class="keyword">return</span> -EAGAIN;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initilize DM910X board */</span></span><br><span class="line">    dmfe_init_dm9000(dev);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DM8606</span></span><br><span class="line">    <span class="comment">// control DM8606</span></span><br><span class="line">    printk(<span class="string">"[8606]reg0=0x%04x\n"</span>,dm8606_read(db,<span class="number">0</span>));</span><br><span class="line">    printk(<span class="string">"[8606]reg1=0x%04x\n"</span>,dm8606_read(db,<span class="number">0x1</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* Init driver variable */</span></span><br><span class="line">    db-&gt;reset_counter   = <span class="number">0</span>;</span><br><span class="line">    db-&gt;reset_tx_timeout    = <span class="number">0</span>;</span><br><span class="line">    db-&gt;cont_rx_pkt_cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* check link state and media speed */</span></span><br><span class="line">    db-&gt;Speed =<span class="number">10</span>;</span><br><span class="line">    i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        reg_nsr = ior(db,DM9KS_NSR);</span><br><span class="line">        <span class="keyword">if</span>(reg_nsr &amp; <span class="number">0x40</span>) <span class="comment">/* link OK!! */</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* wait for detected Speed */</span></span><br><span class="line">            mdelay(<span class="number">200</span>);</span><br><span class="line">            reg_nsr = ior(db,DM9KS_NSR);</span><br><span class="line">            <span class="keyword">if</span>(reg_nsr &amp; <span class="number">0x80</span>)</span><br><span class="line">                db-&gt;Speed =<span class="number">10</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                db-&gt;Speed =<span class="number">100</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">        mdelay(<span class="number">1</span>);</span><br><span class="line">    &#125;<span class="keyword">while</span>(i&lt;<span class="number">3000</span>); <span class="comment">/* wait 3 second  */</span></span><br><span class="line">    <span class="comment">//printk("i=%d  Speed=%d\n",i,db-&gt;Speed);</span></span><br><span class="line">    <span class="comment">/* set and active a timer process */</span></span><br><span class="line">    init_timer(&amp;db-&gt;timer);</span><br><span class="line">    db-&gt;timer.expires   = DMFE_TIMER_WUT;</span><br><span class="line">    db-&gt;timer.data      = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)dev;</span><br><span class="line">    db-&gt;timer.function  = &amp;dmfe_timer;</span><br><span class="line">    add_timer(&amp;db-&gt;timer);  <span class="comment">//Move to DM9000 initiallization was finished.</span></span><br><span class="line"></span><br><span class="line">    netif_start_queue(dev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set PHY operationg mode</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">set_PHY_mode</span><span class="params">(<span class="keyword">board_info_t</span> *db)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> DM8606</span></span><br><span class="line">    u16 phy_reg0 = <span class="number">0x1000</span>;<span class="comment">/* Auto-negotiation*/</span></span><br><span class="line">    u16 phy_reg4 = <span class="number">0x01e1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( !(db-&gt;op_mode &amp; DM9KS_AUTO) ) <span class="comment">// op_mode didn't auto sense */</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span>(db-&gt;op_mode) &#123;</span><br><span class="line">            <span class="keyword">case</span> DM9KS_10MHD:  phy_reg4 = <span class="number">0x21</span>;</span><br><span class="line">                                       phy_reg0 = <span class="number">0x1000</span>;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DM9KS_10MFD:  phy_reg4 = <span class="number">0x41</span>;</span><br><span class="line">                       phy_reg0 = <span class="number">0x1100</span>;</span><br><span class="line">                                       <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DM9KS_100MHD: phy_reg4 = <span class="number">0x81</span>;</span><br><span class="line">                       phy_reg0 = <span class="number">0x3000</span>;</span><br><span class="line">                           <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DM9KS_100MFD: phy_reg4 = <span class="number">0x101</span>;</span><br><span class="line">                       phy_reg0 = <span class="number">0x3100</span>;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="comment">// end of switch</span></span><br><span class="line">    &#125; <span class="comment">// end of if</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> FLOW_CONTROL</span></span><br><span class="line">    phy_write(db, <span class="number">4</span>, phy_reg4|(<span class="number">1</span>&lt;&lt;<span class="number">10</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    phy_write(db, <span class="number">4</span>, phy_reg4);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//end of FLOW_CONTROL</span></span></span><br><span class="line">    phy_write(db, <span class="number">0</span>, phy_reg0|<span class="number">0x200</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="comment">/* Fiber mode */</span></span><br><span class="line">    phy_write(db, <span class="number">16</span>, <span class="number">0x4014</span>);</span><br><span class="line">    phy_write(db, <span class="number">0</span>, <span class="number">0x2100</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//end of DM8606</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (db-&gt;chip_revision == <span class="number">0x1A</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//set 10M TX idle =65mA (TX 100% utility is 160mA)</span></span><br><span class="line">        phy_write(db,<span class="number">20</span>, phy_read(db,<span class="number">20</span>)|(<span class="number">1</span>&lt;&lt;<span class="number">11</span>)|(<span class="number">1</span>&lt;&lt;<span class="number">10</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//:fix harmonic</span></span><br><span class="line">        <span class="comment">//For short code:</span></span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- 0000h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0x0000</span>);</span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- AA00h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0xaa00</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- 0017h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0x0017</span>);</span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- AA17h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0xaa17</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- 002Fh</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0x002f</span>);</span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- AA2Fh</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0xaa2f</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- 0037h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0x0037</span>);</span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- AA37h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0xaa37</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- 0040h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0x0040</span>);</span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- AA40h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0xaa40</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//For long code:</span></span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- 0050h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0x0050</span>);</span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- AA50h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0xaa50</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- 006Bh</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0x006b</span>);</span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- AA6Bh</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0xaa6b</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- 007Dh</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0x007d</span>);</span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- AA7Dh</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0xaa7d</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- 008Dh</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0x008d</span>);</span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- AA8Dh</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0xaa8d</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- 009Ch</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0x009c</span>);</span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- AA9Ch</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0xaa9c</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- 00A3h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0x00a3</span>);</span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- AAA3h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0xaaa3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- 00B1h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0x00b1</span>);</span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- AAB1h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0xaab1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- 00C0h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0x00c0</span>);</span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- AAC0h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0xaac0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- 00D2h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0x00d2</span>);</span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- AAD2h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0xaad2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- 00E0h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0x00e0</span>);</span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- AAE0h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0xaae0</span>);</span><br><span class="line">        <span class="comment">//PHY_REG 27 (1Bh) &lt;- 0000h</span></span><br><span class="line">        phy_write(db, <span class="number">27</span>, <span class="number">0x0000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Initilize dm9000 board</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dmfe_init_dm9000</span><span class="params">(struct net_device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    DMFE_DBUG(<span class="number">0</span>, <span class="string">"dmfe_init_dm9000()"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    spin_lock_init(&amp;db-&gt;lock);</span><br><span class="line"></span><br><span class="line">    iow(db, DM9KS_GPR, <span class="number">0</span>);  <span class="comment">/* GPR (reg_1Fh)bit GPIO0=0 pre-activate PHY */</span></span><br><span class="line">    mdelay(<span class="number">20</span>);     <span class="comment">/* wait for PHY power-on ready */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* do a software reset and wait 20us */</span></span><br><span class="line">    iow(db, DM9KS_NCR, <span class="number">3</span>);</span><br><span class="line">    udelay(<span class="number">20</span>);     <span class="comment">/* wait 20us at least for software reset ok */</span></span><br><span class="line">    iow(db, DM9KS_NCR, <span class="number">3</span>);  <span class="comment">/* NCR (reg_00h) bit[0] RST=1 &amp; Loopback=1, reset on */</span></span><br><span class="line">    udelay(<span class="number">20</span>);     <span class="comment">/* wait 20us at least for software reset ok */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* I/O mode */</span></span><br><span class="line">    db-&gt;io_mode = ior(db, DM9KS_ISR) &gt;&gt; <span class="number">6</span>; <span class="comment">/* ISR bit7:6 keeps I/O mode */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set PHY */</span></span><br><span class="line">    db-&gt;op_mode = media_mode;</span><br><span class="line">    set_PHY_mode(db);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Program operating register */</span></span><br><span class="line">    iow(db, DM9KS_NCR, <span class="number">0</span>);</span><br><span class="line">    iow(db, DM9KS_TCR, <span class="number">0</span>);      <span class="comment">/* TX Polling clear */</span></span><br><span class="line">    iow(db, DM9KS_BPTR, <span class="number">0x3f</span>);  <span class="comment">/* Less 3kb, 600us */</span></span><br><span class="line">    iow(db, DM9KS_SMCR, <span class="number">0</span>);     <span class="comment">/* Special Mode */</span></span><br><span class="line">    iow(db, DM9KS_NSR, <span class="number">0x2c</span>);   <span class="comment">/* clear TX status */</span></span><br><span class="line">    iow(db, DM9KS_ISR, <span class="number">0x0f</span>);   <span class="comment">/* Clear interrupt status */</span></span><br><span class="line">    iow(db, DM9KS_TCR2, <span class="number">0x80</span>);  <span class="comment">/* Set LED mode 1 */</span></span><br><span class="line">    <span class="keyword">if</span> (db-&gt;chip_revision == <span class="number">0x1A</span>)&#123;</span><br><span class="line">        <span class="comment">/* Data bus current driving/sinking capability  */</span></span><br><span class="line">        iow(db, DM9KS_BUSCR, <span class="number">0x01</span>); <span class="comment">/* default: 2mA */</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> FLOW_CONTROL</span></span><br><span class="line">    iow(db, DM9KS_BPTR, <span class="number">0x37</span>);</span><br><span class="line">    iow(db, DM9KS_FCTR, <span class="number">0x38</span>);</span><br><span class="line">    iow(db, DM9KS_FCR, <span class="number">0x29</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DM8606</span></span><br><span class="line">    iow(db,<span class="number">0x34</span>,<span class="number">1</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dev-&gt;features &amp; NETIF_F_HW_CSUM)&#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">"DM9KS:enable TX checksum\n"</span>);</span><br><span class="line">        iow(db, DM9KS_TCCR, <span class="number">0x07</span>);  <span class="comment">/* TX UDP/TCP/IP checksum enable */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (db-&gt;rx_csum)&#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">"DM9KS:enable RX checksum\n"</span>);</span><br><span class="line">        iow(db, DM9KS_RCSR, <span class="number">0x02</span>);  <span class="comment">/* RX checksum enable */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ETRANS</span></span><br><span class="line">    <span class="comment">/*If TX loading is heavy, the driver can try to anbel "early transmit".</span></span><br><span class="line"><span class="comment">    The programmer can tune the "Early Transmit Threshold" to get</span></span><br><span class="line"><span class="comment">    the optimization. (DM9KS_ETXCSR.[1-0])</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Side Effect: It will happen "Transmit under-run". When TX under-run</span></span><br><span class="line"><span class="comment">    always happens, the programmer can increase the value of "Early</span></span><br><span class="line"><span class="comment">    Transmit Threshold". */</span></span><br><span class="line">    iow(db, DM9KS_ETXCSR, <span class="number">0x83</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set address filter table */</span></span><br><span class="line">    dm9000_hash_table(dev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Activate DM9000/DM9010 */</span></span><br><span class="line">    iow(db, DM9KS_IMR, DM9KS_REGFF); <span class="comment">/* Enable TX/RX interrupt mask */</span></span><br><span class="line">    iow(db, DM9KS_RXCR, DM9KS_REG05 | <span class="number">1</span>);   <span class="comment">/* RX enable */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Init Driver variable */</span></span><br><span class="line">    db-&gt;tx_pkt_cnt      = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    netif_carrier_on(dev);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Hardware start transmission.</span></span><br><span class="line"><span class="comment">  Send a packet to media from the upper layer.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_start_xmit</span><span class="params">(struct sk_buff *skb, struct net_device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    <span class="keyword">char</span> * data_ptr;</span><br><span class="line">    <span class="keyword">int</span> i, tmplen;</span><br><span class="line">    u16 MDWAH, MDWAL;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> TDBUG <span class="comment">/* check TX FIFO pointer */</span></span></span><br><span class="line">            u16 MDWAH1, MDWAL1;</span><br><span class="line">            u16 tx_ptr;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    DMFE_DBUG(<span class="number">0</span>, <span class="string">"dmfe_start_xmit"</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (db-&gt;chip_revision != <span class="number">0x1A</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(db-&gt;Speed == <span class="number">10</span>)</span><br><span class="line">            &#123;<span class="keyword">if</span> (db-&gt;tx_pkt_cnt &gt;= <span class="number">1</span>) <span class="keyword">return</span> <span class="number">1</span>;&#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            &#123;<span class="keyword">if</span> (db-&gt;tx_pkt_cnt &gt;= <span class="number">2</span>) <span class="keyword">return</span> <span class="number">1</span>;&#125;</span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">        <span class="keyword">if</span> (db-&gt;tx_pkt_cnt &gt;= <span class="number">2</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* packet counting */</span></span><br><span class="line">    db-&gt;tx_pkt_cnt++;</span><br><span class="line"></span><br><span class="line">    db-&gt;stats.tx_packets++;</span><br><span class="line">    db-&gt;stats.tx_bytes+=skb-&gt;len;</span><br><span class="line">    <span class="keyword">if</span> (db-&gt;chip_revision != <span class="number">0x1A</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (db-&gt;Speed == <span class="number">10</span>)</span><br><span class="line">            &#123;<span class="keyword">if</span> (db-&gt;tx_pkt_cnt &gt;= <span class="number">1</span>) netif_stop_queue(dev);&#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            &#123;<span class="keyword">if</span> (db-&gt;tx_pkt_cnt &gt;= <span class="number">2</span>) netif_stop_queue(dev);&#125;</span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">        <span class="keyword">if</span> (db-&gt;tx_pkt_cnt &gt;= <span class="number">2</span>) netif_stop_queue(dev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Disable all interrupt */</span></span><br><span class="line">    iow(db, DM9KS_IMR, DM9KS_DISINTR);</span><br><span class="line"></span><br><span class="line">    MDWAH = ior(db,DM9KS_MDWAH);</span><br><span class="line">    MDWAL = ior(db,DM9KS_MDWAL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set TX length to reg. 0xfc &amp; 0xfd */</span></span><br><span class="line">    iow(db, DM9KS_TXPLL, (skb-&gt;len &amp; <span class="number">0xff</span>));</span><br><span class="line">    iow(db, DM9KS_TXPLH, (skb-&gt;len &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Move data to TX SRAM */</span></span><br><span class="line">    data_ptr = (<span class="keyword">char</span> *)skb-&gt;data;</span><br><span class="line"></span><br><span class="line">    outb(DM9KS_MWCMD, db-&gt;io_addr); <span class="comment">// Write data into SRAM trigger</span></span><br><span class="line">    <span class="keyword">switch</span>(db-&gt;io_mode)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> DM9KS_BYTE_MODE:</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; skb-&gt;len; i++)</span><br><span class="line">                outb((data_ptr[i] &amp; <span class="number">0xff</span>), db-&gt;io_data);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DM9KS_WORD_MODE:</span><br><span class="line">            tmplen = (skb-&gt;len + <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; tmplen; i++)</span><br><span class="line">        outw(((u16 *)data_ptr)[i], db-&gt;io_data);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DM9KS_DWORD_MODE:</span><br><span class="line">      tmplen = (skb-&gt;len + <span class="number">3</span>) / <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt; tmplen; i++)</span><br><span class="line">                outl(((u32 *)data_ptr)[i], db-&gt;io_data);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ETRANS</span></span><br><span class="line">    <span class="comment">/* Issue TX polling command */</span></span><br><span class="line">    iow(db, DM9KS_TCR, <span class="number">0x1</span>); <span class="comment">/* Cleared after TX complete*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> TDBUG <span class="comment">/* check TX FIFO pointer */</span></span></span><br><span class="line">            MDWAH1 = ior(db,DM9KS_MDWAH);</span><br><span class="line">            MDWAL1 = ior(db,DM9KS_MDWAL);</span><br><span class="line">            tx_ptr = (MDWAH&lt;&lt;<span class="number">8</span>)|MDWAL;</span><br><span class="line">            <span class="keyword">switch</span> (db-&gt;io_mode)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> DM9KS_BYTE_MODE:</span><br><span class="line">                    tx_ptr += skb-&gt;len;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> DM9KS_WORD_MODE:</span><br><span class="line">                    tx_ptr += ((skb-&gt;len + <span class="number">1</span>) / <span class="number">2</span>)*<span class="number">2</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> DM9KS_DWORD_MODE:</span><br><span class="line">                    tx_ptr += ((skb-&gt;len+<span class="number">3</span>)/<span class="number">4</span>)*<span class="number">4</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (tx_ptr &gt; <span class="number">0x0bff</span>)</span><br><span class="line">                    tx_ptr -= <span class="number">0x0c00</span>;</span><br><span class="line">            <span class="keyword">if</span> (tx_ptr != ((MDWAH1&lt;&lt;<span class="number">8</span>)|MDWAL1))</span><br><span class="line">                    printk(<span class="string">"[dm9ks:TX FIFO ERROR\n"</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* Saved the time stamp */</span></span><br><span class="line">    dev-&gt;trans_start = jiffies;</span><br><span class="line">    db-&gt;cont_rx_pkt_cnt =<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Free this SKB */</span></span><br><span class="line">    dev_kfree_skb(skb);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Re-enable interrupt */</span></span><br><span class="line">    iow(db, DM9KS_IMR, DM9KS_REGFF);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Stop the interface.</span></span><br><span class="line"><span class="comment">  The interface is stopped when it is brought.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_stop</span><span class="params">(struct net_device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    DMFE_DBUG(<span class="number">0</span>, <span class="string">"dmfe_stop"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* deleted timer */</span></span><br><span class="line">    del_timer(&amp;db-&gt;timer);</span><br><span class="line"></span><br><span class="line">    netif_stop_queue(dev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* free interrupt */</span></span><br><span class="line">    free_irq(dev-&gt;irq, dev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* RESET devie */</span></span><br><span class="line">    phy_write(db, <span class="number">0x00</span>, <span class="number">0x8000</span>);    <span class="comment">/* PHY RESET */</span></span><br><span class="line">    <span class="comment">//iow(db, DM9KS_GPR, 0x01);     /* Power-Down PHY */</span></span><br><span class="line">    iow(db, DM9KS_IMR, DM9KS_DISINTR);  <span class="comment">/* Disable all interrupt */</span></span><br><span class="line">    iow(db, DM9KS_RXCR, <span class="number">0x00</span>);  <span class="comment">/* Disable RX */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Dump Statistic counter */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> FALSE</span></span><br><span class="line">    printk(<span class="string">"\nRX FIFO OVERFLOW %lx\n"</span>, db-&gt;stats.rx_fifo_errors);</span><br><span class="line">    printk(<span class="string">"RX CRC %lx\n"</span>, db-&gt;stats.rx_crc_errors);</span><br><span class="line">    printk(<span class="string">"RX LEN Err %lx\n"</span>, db-&gt;stats.rx_length_errors);</span><br><span class="line">    printk(<span class="string">"RESET %x\n"</span>, db-&gt;reset_counter);</span><br><span class="line">    printk(<span class="string">"RESET: TX Timeout %x\n"</span>, db-&gt;reset_tx_timeout);</span><br><span class="line">    printk(<span class="string">"g_TX_nsr %x\n"</span>, g_TX_nsr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dmfe_tx_done</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> unused)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">dev</span> = <span class="title">dmfe_dev</span>;</span></span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    <span class="keyword">int</span>  nsr;</span><br><span class="line"></span><br><span class="line">    DMFE_DBUG(<span class="number">0</span>, <span class="string">"dmfe_tx_done()"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    nsr = ior(db, DM9KS_NSR);</span><br><span class="line">    <span class="keyword">if</span> (nsr &amp; <span class="number">0x0c</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(nsr &amp; <span class="number">0x04</span>) db-&gt;tx_pkt_cnt--;</span><br><span class="line">        <span class="keyword">if</span>(nsr &amp; <span class="number">0x08</span>) db-&gt;tx_pkt_cnt--;</span><br><span class="line">        <span class="keyword">if</span>(db-&gt;tx_pkt_cnt &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            printk(KERN_DEBUG <span class="string">"DM9KS:tx_pkt_cnt ERROR!!\n"</span>);</span><br><span class="line">            <span class="keyword">while</span>(ior(db,DM9KS_TCR) &amp; <span class="number">0x1</span>)&#123;&#125;</span><br><span class="line">            db-&gt;tx_pkt_cnt = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(ior(db,DM9KS_TCR) &amp; <span class="number">0x1</span>)&#123;&#125;</span><br><span class="line">        db-&gt;tx_pkt_cnt = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    netif_wake_queue(dev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  DM9000 insterrupt handler</span></span><br><span class="line"><span class="comment">  receive the packet to upper layer, free the transmitted packet</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,5,0)</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dmfe_interrupt</span><span class="params">(<span class="keyword">int</span> irq, <span class="keyword">void</span> *dev_id, struct pt_regs *regs)</span></span></span><br><span class="line"><span class="function"><span class="meta">#<span class="meta-keyword">else</span></span></span></span><br><span class="line"><span class="function">    <span class="meta">#<span class="meta-keyword">if</span> LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,6,19)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">static</span> irqreturn_t <span class="title">dmfe_interrupt</span><span class="params">(<span class="keyword">int</span> irq, <span class="keyword">void</span> *dev_id, struct pt_regs *regs)</span></span></span><br><span class="line"><span class="function">    <span class="meta">#<span class="meta-keyword">else</span></span></span></span><br><span class="line"><span class="function">    <span class="keyword">static</span> irqreturn_t <span class="title">dmfe_interrupt</span><span class="params">(<span class="keyword">int</span> irq, <span class="keyword">void</span> *dev_id)</span> <span class="comment">/* for kernel 2.6.20*/</span></span></span><br><span class="line"><span class="function">    <span class="meta">#<span class="meta-keyword">endif</span></span></span></span><br><span class="line"><span class="function"><span class="meta">#<span class="meta-keyword">endif</span></span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">dev</span> = <span class="title">dev_id</span>;</span></span><br><span class="line">    <span class="keyword">board_info_t</span> *db;</span><br><span class="line">    <span class="keyword">int</span> int_status,i;</span><br><span class="line">    u8 reg_save;</span><br><span class="line"></span><br><span class="line">    DMFE_DBUG(<span class="number">0</span>, <span class="string">"dmfe_interrupt()"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* A real interrupt coming */</span></span><br><span class="line">    db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    spin_lock(&amp;db-&gt;lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Save previous register address */</span></span><br><span class="line">    reg_save = inb(db-&gt;io_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Disable all interrupt */</span></span><br><span class="line">    iow(db, DM9KS_IMR, DM9KS_DISINTR);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Got DM9000/DM9010 interrupt status */</span></span><br><span class="line">    int_status = ior(db, DM9KS_ISR);        <span class="comment">/* Got ISR */</span></span><br><span class="line">    iow(db, DM9KS_ISR, int_status);     <span class="comment">/* Clear ISR status */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Link status change */</span></span><br><span class="line">    <span class="keyword">if</span> (int_status &amp; DM9KS_LINK_INTR)</span><br><span class="line">    &#123;</span><br><span class="line">        netif_stop_queue(dev);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">500</span>; i++) <span class="comment">/*wait link OK, waiting time =0.5s */</span></span><br><span class="line">        &#123;</span><br><span class="line">            phy_read(db,<span class="number">0x1</span>);</span><br><span class="line">            <span class="keyword">if</span>(phy_read(db,<span class="number">0x1</span>) &amp; <span class="number">0x4</span>) <span class="comment">/*Link OK*/</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">/* wait for detected Speed */</span></span><br><span class="line">                <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">200</span>;i++)</span><br><span class="line">                    udelay(<span class="number">1000</span>);</span><br><span class="line">                <span class="comment">/* set media speed */</span></span><br><span class="line">                <span class="keyword">if</span>(phy_read(db,<span class="number">0</span>)&amp;<span class="number">0x2000</span>) db-&gt;Speed =<span class="number">100</span>;</span><br><span class="line">                <span class="keyword">else</span> db-&gt;Speed =<span class="number">10</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            udelay(<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        netif_wake_queue(dev);</span><br><span class="line">        <span class="comment">//printk("[INTR]i=%d speed=%d\n",i, (int)(db-&gt;Speed));</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Received the coming packet */</span></span><br><span class="line">    <span class="keyword">if</span> (int_status &amp; DM9KS_RX_INTR)</span><br><span class="line">        dmfe_packet_receive(dev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Trnasmit Interrupt check */</span></span><br><span class="line">    <span class="keyword">if</span> (int_status &amp; DM9KS_TX_INTR)</span><br><span class="line">        dmfe_tx_done(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (db-&gt;cont_rx_pkt_cnt&gt;=CONT_RX_PKT_CNT)</span><br><span class="line">    &#123;</span><br><span class="line">        iow(db, DM9KS_IMR, <span class="number">0xa2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Re-enable interrupt mask */</span></span><br><span class="line">        iow(db, DM9KS_IMR, DM9KS_REGFF);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Restore previous register address */</span></span><br><span class="line">    outb(reg_save, db-&gt;io_addr);</span><br><span class="line"></span><br><span class="line">    spin_unlock(&amp;db-&gt;lock);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,5,0)</span></span><br><span class="line">    <span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Get statistics from driver.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct net_device_stats * <span class="title">dmfe_get_stats</span><span class="params">(struct net_device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    DMFE_DBUG(<span class="number">0</span>, <span class="string">"dmfe_get_stats"</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> &amp;db-&gt;stats;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  Process the ethtool ioctl command</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_ethtool_ioctl</span><span class="params">(struct net_device *dev, <span class="keyword">void</span> *useraddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//struct dmfe_board_info *db = dev-&gt;priv;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ethtool_drvinfo</span> <span class="title">info</span> = &#123;</span> ETHTOOL_GDRVINFO &#125;;</span><br><span class="line">    u32 ethcmd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;ethcmd, useraddr, <span class="keyword">sizeof</span>(ethcmd)))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (ethcmd)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> ETHTOOL_GDRVINFO:</span><br><span class="line">            <span class="built_in">strcpy</span>(info.driver, DRV_NAME);</span><br><span class="line">            <span class="built_in">strcpy</span>(info.version, DRV_VERSION);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">sprintf</span>(info.bus_info, <span class="string">"ISA 0x%lx %d"</span>,dev-&gt;base_addr, dev-&gt;irq);</span><br><span class="line">            <span class="keyword">if</span> (copy_to_user(useraddr, &amp;info, <span class="keyword">sizeof</span>(info)))</span><br><span class="line">                <span class="keyword">return</span> -EFAULT;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Process the upper socket ioctl command</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_do_ioctl</span><span class="params">(struct net_device *dev, struct ifreq *ifr, <span class="keyword">int</span> cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,6,7) <span class="comment">/* for kernel 2.6.7 */</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mii_ioctl_data</span> *<span class="title">data</span>=(<span class="title">struct</span> <span class="title">mii_ioctl_data</span> *)&amp;<span class="title">ifr</span>-&gt;<span class="title">ifr_data</span>;</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">int</span> rc=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    DMFE_DBUG(<span class="number">0</span>, <span class="string">"dmfe_do_ioctl()"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!netif_running(dev))</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cmd == SIOCETHTOOL)</span><br><span class="line">        rc = dmfe_ethtool_ioctl(dev, (<span class="keyword">void</span> *) ifr-&gt;ifr_data);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        spin_lock_irq(&amp;db-&gt;lock);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">if</span> LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,6,7) <span class="comment">/* for kernel 2.6.7 */</span></span></span><br><span class="line">            rc = generic_mii_ioctl(&amp;db-&gt;mii, data, cmd, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">            rc = generic_mii_ioctl(&amp;db-&gt;mii, if_mii(ifr), cmd, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        spin_unlock_irq(&amp;db-&gt;lock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Our watchdog timed out. Called by the networking layer */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dmfe_timeout</span><span class="params">(struct net_device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    DMFE_DBUG(<span class="number">0</span>, <span class="string">"dmfe_TX_timeout()"</span>, <span class="number">0</span>);</span><br><span class="line">    printk(<span class="string">"TX time-out -- dmfe_timeout().\n"</span>);</span><br><span class="line">    db-&gt;reset_tx_timeout++;</span><br><span class="line">    db-&gt;stats.tx_errors++;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> FALSE</span></span><br><span class="line">    printk(<span class="string">"TX packet count = %d\n"</span>, db-&gt;tx_pkt_cnt);</span><br><span class="line">    printk(<span class="string">"TX timeout = %d\n"</span>, db-&gt;reset_tx_timeout);</span><br><span class="line">    printk(<span class="string">"22H=0x%02x  23H=0x%02x\n"</span>,ior(db,<span class="number">0x22</span>),ior(db,<span class="number">0x23</span>));</span><br><span class="line">    printk(<span class="string">"faH=0x%02x  fbH=0x%02x\n"</span>,ior(db,<span class="number">0xfa</span>),ior(db,<span class="number">0xfb</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    i=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>((i++&lt;<span class="number">100</span>)&amp;&amp;(ior(db,DM9KS_TCR) &amp; <span class="number">0x01</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        udelay(<span class="number">30</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(i&lt;<span class="number">100</span>)</span><br><span class="line">    &#123;</span><br><span class="line">            db-&gt;tx_pkt_cnt = <span class="number">0</span>;</span><br><span class="line">            netif_wake_queue(dev);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">            dmfe_reset(dev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dmfe_reset</span><span class="params">(struct net_device * dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    u8 reg_save;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">/* Save previous register address */</span></span><br><span class="line">    reg_save = inb(db-&gt;io_addr);</span><br><span class="line"></span><br><span class="line">    netif_stop_queue(dev);</span><br><span class="line">    db-&gt;reset_counter++;</span><br><span class="line">    dmfe_init_dm9000(dev);</span><br><span class="line"></span><br><span class="line">    db-&gt;Speed =<span class="number">10</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">1000</span>; i++) <span class="comment">/*wait link OK, waiting time=1 second */</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(phy_read(db,<span class="number">0x1</span>) &amp; <span class="number">0x4</span>) <span class="comment">/*Link OK*/</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(phy_read(db,<span class="number">0</span>)&amp;<span class="number">0x2000</span>) db-&gt;Speed =<span class="number">100</span>;</span><br><span class="line">            <span class="keyword">else</span> db-&gt;Speed =<span class="number">10</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        udelay(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    netif_wake_queue(dev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Restore previous register address */</span></span><br><span class="line">    outb(reg_save, db-&gt;io_addr);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  A periodic timer routine</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dmfe_timer</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> * <span class="title">dev</span> = (<span class="title">struct</span> <span class="title">net_device</span> *)<span class="title">data</span>;</span></span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    DMFE_DBUG(<span class="number">0</span>, <span class="string">"dmfe_timer()"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (db-&gt;cont_rx_pkt_cnt&gt;=CONT_RX_PKT_CNT)</span><br><span class="line">    &#123;</span><br><span class="line">        db-&gt;cont_rx_pkt_cnt=<span class="number">0</span>;</span><br><span class="line">        iow(db, DM9KS_IMR, DM9KS_REGFF);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Set timer again */</span></span><br><span class="line">    db-&gt;timer.expires = DMFE_TIMER_WUT;</span><br><span class="line">    add_timer(&amp;db-&gt;timer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Received a packet and pass to upper layer</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dmfe_packet_receive</span><span class="params">(struct net_device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">    u8 rxbyte;</span><br><span class="line">    u16 i, GoodPacket, tmplen = <span class="number">0</span>, MDRAH, MDRAL;</span><br><span class="line">    u32 tmpdata;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">rx_t</span> rx;</span><br><span class="line"></span><br><span class="line">    u16 * ptr = (u16*)&amp;rx;</span><br><span class="line">    u8* rdptr;</span><br><span class="line"></span><br><span class="line">    DMFE_DBUG(<span class="number">0</span>, <span class="string">"dmfe_packet_receive()"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    db-&gt;cont_rx_pkt_cnt=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">/*store the value of Memory Data Read address register*/</span></span><br><span class="line">        MDRAH=ior(db, DM9KS_MDRAH);</span><br><span class="line">        MDRAL=ior(db, DM9KS_MDRAL);</span><br><span class="line"></span><br><span class="line">        ior(db, DM9KS_MRCMDX);      <span class="comment">/* Dummy read */</span></span><br><span class="line">        rxbyte = inb(db-&gt;io_data);  <span class="comment">/* Got most updated data */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CHECKSUM</span></span><br><span class="line">        <span class="keyword">if</span> (rxbyte&amp;<span class="number">0x2</span>)         <span class="comment">/* check RX byte */</span></span><br><span class="line">        &#123;</span><br><span class="line">      printk(<span class="string">"dm9ks: abnormal!\n"</span>);</span><br><span class="line">            dmfe_reset(dev);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!(rxbyte&amp;<span class="number">0x1</span>))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        <span class="keyword">if</span> (rxbyte==<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rxbyte&gt;<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">      printk(<span class="string">"dm9ks: Rxbyte error!\n"</span>);</span><br><span class="line">          dmfe_reset(dev);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* A packet ready now  &amp; Get status/length */</span></span><br><span class="line">        GoodPacket = TRUE;</span><br><span class="line">        outb(DM9KS_MRCMD, db-&gt;io_addr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Read packet status &amp; length */</span></span><br><span class="line">        <span class="keyword">switch</span> (db-&gt;io_mode)</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">case</span> DM9KS_BYTE_MODE:</span><br><span class="line">                    *ptr = inb(db-&gt;io_data) +</span><br><span class="line">                               (inb(db-&gt;io_data) &lt;&lt; <span class="number">8</span>);</span><br><span class="line">                    *(ptr+<span class="number">1</span>) = inb(db-&gt;io_data) +</span><br><span class="line">                        (inb(db-&gt;io_data) &lt;&lt; <span class="number">8</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> DM9KS_WORD_MODE:</span><br><span class="line">                    *ptr = inw(db-&gt;io_data);</span><br><span class="line">                    *(ptr+<span class="number">1</span>)    = inw(db-&gt;io_data);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> DM9KS_DWORD_MODE:</span><br><span class="line">                    tmpdata  = inl(db-&gt;io_data);</span><br><span class="line">                    *ptr = tmpdata;</span><br><span class="line">                    *(ptr+<span class="number">1</span>)    = tmpdata &gt;&gt; <span class="number">16</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Packet status check */</span></span><br><span class="line">        <span class="keyword">if</span> (rx.desc.status &amp; <span class="number">0xbf</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            GoodPacket = FALSE;</span><br><span class="line">            <span class="keyword">if</span> (rx.desc.status &amp; <span class="number">0x01</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                db-&gt;stats.rx_fifo_errors++;</span><br><span class="line">                printk(KERN_INFO<span class="string">"&lt;RX FIFO error&gt;\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (rx.desc.status &amp; <span class="number">0x02</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                db-&gt;stats.rx_crc_errors++;</span><br><span class="line">                printk(KERN_INFO<span class="string">"&lt;RX CRC error&gt;\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (rx.desc.status &amp; <span class="number">0x80</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                db-&gt;stats.rx_length_errors++;</span><br><span class="line">                printk(KERN_INFO<span class="string">"&lt;RX Length error&gt;\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (rx.desc.status &amp; <span class="number">0x08</span>)</span><br><span class="line">                printk(KERN_INFO<span class="string">"&lt;Physical Layer error&gt;\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!GoodPacket)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// drop this packet!!!</span></span><br><span class="line">            <span class="keyword">switch</span> (db-&gt;io_mode)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> DM9KS_BYTE_MODE:</span><br><span class="line">                    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;rx.desc.length; i++)</span><br><span class="line">                        inb(db-&gt;io_data);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> DM9KS_WORD_MODE:</span><br><span class="line">                    tmplen = (rx.desc.length + <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line">                    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; tmplen; i++)</span><br><span class="line">                        inw(db-&gt;io_data);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> DM9KS_DWORD_MODE:</span><br><span class="line">                    tmplen = (rx.desc.length + <span class="number">3</span>) / <span class="number">4</span>;</span><br><span class="line">                    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; tmplen; i++)</span><br><span class="line">                        inl(db-&gt;io_data);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;<span class="comment">/*next the packet*/</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        skb = dev_alloc_skb(rx.desc.length+<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">if</span> (skb == <span class="literal">NULL</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            printk(KERN_INFO <span class="string">"%s: Memory squeeze.\n"</span>, dev-&gt;name);</span><br><span class="line">            <span class="comment">/*re-load the value into Memory data read address register*/</span></span><br><span class="line">            iow(db,DM9KS_MDRAH,MDRAH);</span><br><span class="line">            iow(db,DM9KS_MDRAL,MDRAL);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* Move data from DM9000 */</span></span><br><span class="line">            skb-&gt;dev = dev;</span><br><span class="line">            skb_reserve(skb, <span class="number">2</span>);</span><br><span class="line">            rdptr = (u8*)skb_put(skb, rx.desc.length - <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Read received packet from RX SARM */</span></span><br><span class="line">            <span class="keyword">switch</span> (db-&gt;io_mode)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> DM9KS_BYTE_MODE:</span><br><span class="line">                    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;rx.desc.length; i++)</span><br><span class="line">                        rdptr[i]=inb(db-&gt;io_data);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> DM9KS_WORD_MODE:</span><br><span class="line">                    tmplen = (rx.desc.length + <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line">                    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; tmplen; i++)</span><br><span class="line">                        ((u16 *)rdptr)[i] = inw(db-&gt;io_data);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> DM9KS_DWORD_MODE:</span><br><span class="line">                    tmplen = (rx.desc.length + <span class="number">3</span>) / <span class="number">4</span>;</span><br><span class="line">                    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; tmplen; i++)</span><br><span class="line">                        ((u32 *)rdptr)[i] = inl(db-&gt;io_data);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Pass to upper layer */</span></span><br><span class="line">            skb-&gt;protocol = eth_type_trans(skb,dev);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CHECKSUM</span></span><br><span class="line">        <span class="keyword">if</span>((rxbyte&amp;<span class="number">0xe0</span>)==<span class="number">0</span>)    <span class="comment">/* receive packet no checksum fail */</span></span><br><span class="line">                skb-&gt;ip_summed = CHECKSUM_UNNECESSARY;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            netif_rx(skb);</span><br><span class="line">            dev-&gt;last_rx=jiffies;</span><br><span class="line">            db-&gt;stats.rx_packets++;</span><br><span class="line">            db-&gt;stats.rx_bytes += rx.desc.length;</span><br><span class="line">            db-&gt;cont_rx_pkt_cnt++;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> RDBG <span class="comment">/* check RX FIFO pointer */</span></span></span><br><span class="line">            u16 MDRAH1, MDRAL1;</span><br><span class="line">            u16 tmp_ptr;</span><br><span class="line">            MDRAH1 = ior(db,DM9KS_MDRAH);</span><br><span class="line">            MDRAL1 = ior(db,DM9KS_MDRAL);</span><br><span class="line">            tmp_ptr = (MDRAH&lt;&lt;<span class="number">8</span>)|MDRAL;</span><br><span class="line">            <span class="keyword">switch</span> (db-&gt;io_mode)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> DM9KS_BYTE_MODE:</span><br><span class="line">                    tmp_ptr += rx.desc.length+<span class="number">4</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> DM9KS_WORD_MODE:</span><br><span class="line">                    tmp_ptr += ((rx.desc.length+<span class="number">1</span>)/<span class="number">2</span>)*<span class="number">2</span>+<span class="number">4</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> DM9KS_DWORD_MODE:</span><br><span class="line">                    tmp_ptr += ((rx.desc.length+<span class="number">3</span>)/<span class="number">4</span>)*<span class="number">4</span>+<span class="number">4</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (tmp_ptr &gt;=<span class="number">0x4000</span>)</span><br><span class="line">                tmp_ptr = (tmp_ptr - <span class="number">0x4000</span>) + <span class="number">0xc00</span>;</span><br><span class="line">            <span class="keyword">if</span> (tmp_ptr != ((MDRAH1&lt;&lt;<span class="number">8</span>)|MDRAL1))</span><br><span class="line">                printk(<span class="string">"[dm9ks:RX FIFO ERROR\n"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (db-&gt;cont_rx_pkt_cnt&gt;=CONT_RX_PKT_CNT)</span><br><span class="line">            &#123;</span><br><span class="line">                dmfe_tx_done(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">while</span>((rxbyte &amp; <span class="number">0x01</span>) == DM9KS_PKT_RDY);</span><br><span class="line">    DMFE_DBUG(<span class="number">0</span>, <span class="string">"[END]dmfe_packet_receive()"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Read a word data from SROM</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> u16 <span class="title">read_srom_word</span><span class="params">(<span class="keyword">board_info_t</span> *db, <span class="keyword">int</span> offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    iow(db, DM9KS_EPAR, offset);</span><br><span class="line">    iow(db, DM9KS_EPCR, <span class="number">0x4</span>);</span><br><span class="line">    <span class="keyword">while</span>(ior(db, DM9KS_EPCR)&amp;<span class="number">0x1</span>); <span class="comment">/* Wait read complete */</span></span><br><span class="line">    iow(db, DM9KS_EPCR, <span class="number">0x0</span>);</span><br><span class="line">    <span class="keyword">return</span> (ior(db, DM9KS_EPDRL) + (ior(db, DM9KS_EPDRH) &lt;&lt; <span class="number">8</span>) );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Set DM9000/DM9010 multicast address</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dm9000_hash_table</span><span class="params">(struct net_device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dev_mc_list</span> *<span class="title">mcptr</span> = <span class="title">dev</span>-&gt;<span class="title">mc_list</span>;</span></span><br><span class="line">    <span class="keyword">int</span> mc_cnt = dev-&gt;mc_count;</span><br><span class="line">    u32 hash_val;</span><br><span class="line">    u16 i, oft, hash_table[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">    DMFE_DBUG(<span class="number">0</span>, <span class="string">"dm9000_hash_table()"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* enable promiscuous mode */</span></span><br><span class="line">    <span class="keyword">if</span> (dev-&gt;flags &amp; IFF_PROMISC)&#123;</span><br><span class="line">        <span class="comment">//printk(KERN_INFO "DM9KS:enable promiscuous mode\n");</span></span><br><span class="line">        iow(db, DM9KS_RXCR, ior(db,DM9KS_RXCR)|(<span class="number">1</span>&lt;&lt;<span class="number">1</span>));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//printk(KERN_INFO "DM9KS:disable promiscuous mode\n");</span></span><br><span class="line">        iow(db, DM9KS_RXCR, ior(db,DM9KS_RXCR)&amp;(~(<span class="number">1</span>&lt;&lt;<span class="number">1</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Receive all multicast packets */</span></span><br><span class="line">    <span class="keyword">if</span> (dev-&gt;flags &amp; IFF_ALLMULTI)&#123;</span><br><span class="line">        <span class="comment">//printk(KERN_INFO "DM9KS:Pass all multicast\n");</span></span><br><span class="line">        iow(db, DM9KS_RXCR, ior(db,DM9KS_RXCR)|(<span class="number">1</span>&lt;&lt;<span class="number">3</span>));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//printk(KERN_INFO "DM9KS:Disable pass all multicast\n");</span></span><br><span class="line">        iow(db, DM9KS_RXCR, ior(db,DM9KS_RXCR)&amp;(~(<span class="number">1</span>&lt;&lt;<span class="number">3</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set Node address */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, oft = <span class="number">0x10</span>; i &lt; <span class="number">6</span>; i++, oft++)</span><br><span class="line">        iow(db, oft, dev-&gt;dev_addr[i]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Clear Hash Table */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        hash_table[i] = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* broadcast address */</span></span><br><span class="line">    hash_table[<span class="number">3</span>] = <span class="number">0x8000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the multicast address in Hash Table : 64 bits */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; mc_cnt; i++, mcptr = mcptr-&gt;next) &#123;</span><br><span class="line">        hash_val = cal_CRC((<span class="keyword">char</span> *)mcptr-&gt;dmi_addr, <span class="number">6</span>, <span class="number">0</span>) &amp; <span class="number">0x3f</span>;</span><br><span class="line">        hash_table[hash_val / <span class="number">16</span>] |= (u16) <span class="number">1</span> &lt;&lt; (hash_val % <span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Write the hash table to MAC MD table */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, oft = <span class="number">0x16</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        iow(db, oft++, hash_table[i] &amp; <span class="number">0xff</span>);</span><br><span class="line">        iow(db, oft++, (hash_table[i] &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Calculate the CRC valude of the Rx packet</span></span><br><span class="line"><span class="comment">  flag = 1 : return the reverse CRC (for the received packet CRC)</span></span><br><span class="line"><span class="comment">         0 : return the normal CRC (for Hash Table index)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">cal_CRC</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> * Data, <span class="keyword">unsigned</span> <span class="keyword">int</span> Len, u8 flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u32 crc = ether_crc_le(Len, Data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flag)</span><br><span class="line">        <span class="keyword">return</span> ~crc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> crc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdio_read</span><span class="params">(struct net_device *dev, <span class="keyword">int</span> phy_id, <span class="keyword">int</span> location)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    <span class="keyword">return</span> phy_read(db, location);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mdio_write</span><span class="params">(struct net_device *dev, <span class="keyword">int</span> phy_id, <span class="keyword">int</span> location, <span class="keyword">int</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    phy_write(db, location, val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Read a byte from I/O port</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">u8 <span class="title">ior</span><span class="params">(<span class="keyword">board_info_t</span> *db, <span class="keyword">int</span> reg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    outb(reg, db-&gt;io_addr);</span><br><span class="line">    <span class="keyword">return</span> inb(db-&gt;io_data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Write a byte to I/O port</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">iow</span><span class="params">(<span class="keyword">board_info_t</span> *db, <span class="keyword">int</span> reg, u8 value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    outb(reg, db-&gt;io_addr);</span><br><span class="line">    outb(value, db-&gt;io_data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Read a word from phyxcer</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> u16 <span class="title">phy_read</span><span class="params">(<span class="keyword">board_info_t</span> *db, <span class="keyword">int</span> reg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* Fill the phyxcer register into REG_0C */</span></span><br><span class="line">    iow(db, DM9KS_EPAR, DM9KS_PHY | reg);</span><br><span class="line"></span><br><span class="line">    iow(db, DM9KS_EPCR, <span class="number">0xc</span>);   <span class="comment">/* Issue phyxcer read command */</span></span><br><span class="line">    <span class="keyword">while</span>(ior(db, DM9KS_EPCR)&amp;<span class="number">0x1</span>); <span class="comment">/* Wait read complete */</span></span><br><span class="line">    iow(db, DM9KS_EPCR, <span class="number">0x0</span>);   <span class="comment">/* Clear phyxcer read command */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The read data keeps on REG_0D &amp; REG_0E */</span></span><br><span class="line">    <span class="keyword">return</span> ( ior(db, DM9KS_EPDRH) &lt;&lt; <span class="number">8</span> ) | ior(db, DM9KS_EPDRL);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Write a word to phyxcer</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">phy_write</span><span class="params">(<span class="keyword">board_info_t</span> *db, <span class="keyword">int</span> reg, u16 value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* Fill the phyxcer register into REG_0C */</span></span><br><span class="line">    iow(db, DM9KS_EPAR, DM9KS_PHY | reg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Fill the written data into REG_0D &amp; REG_0E */</span></span><br><span class="line">    iow(db, DM9KS_EPDRL, (value &amp; <span class="number">0xff</span>));</span><br><span class="line">    iow(db, DM9KS_EPDRH, ( (value &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>));</span><br><span class="line"></span><br><span class="line">    iow(db, DM9KS_EPCR, <span class="number">0xa</span>);   <span class="comment">/* Issue phyxcer write command */</span></span><br><span class="line">    <span class="keyword">while</span>(ior(db, DM9KS_EPCR)&amp;<span class="number">0x1</span>); <span class="comment">/* Wait read complete */</span></span><br><span class="line">    iow(db, DM9KS_EPCR, <span class="number">0x0</span>);   <span class="comment">/* Clear phyxcer write command */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//====dmfe_ethtool_ops member functions====</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dmfe_get_drvinfo</span><span class="params">(struct net_device *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct ethtool_drvinfo *info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//board_info_t *db = (board_info_t *)dev-&gt;priv;</span></span><br><span class="line">    <span class="built_in">strcpy</span>(info-&gt;driver, DRV_NAME);</span><br><span class="line">    <span class="built_in">strcpy</span>(info-&gt;version, DRV_VERSION);</span><br><span class="line">    <span class="built_in">sprintf</span>(info-&gt;bus_info, <span class="string">"ISA 0x%lx irq=%d"</span>,dev-&gt;base_addr, dev-&gt;irq);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_get_settings</span><span class="params">(struct net_device *dev, struct ethtool_cmd *cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    spin_lock_irq(&amp;db-&gt;lock);</span><br><span class="line">    mii_ethtool_gset(&amp;db-&gt;mii, cmd);</span><br><span class="line">    spin_unlock_irq(&amp;db-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_set_settings</span><span class="params">(struct net_device *dev, struct ethtool_cmd *cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    <span class="keyword">int</span> rc;</span><br><span class="line"></span><br><span class="line">    spin_lock_irq(&amp;db-&gt;lock);</span><br><span class="line">    rc = mii_ethtool_sset(&amp;db-&gt;mii, cmd);</span><br><span class="line">    spin_unlock_irq(&amp;db-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Check the link state</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> u32 <span class="title">dmfe_get_link</span><span class="params">(struct net_device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    <span class="keyword">return</span> mii_link_ok(&amp;db-&gt;mii);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Reset Auto-negitiation</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_nway_reset</span><span class="params">(struct net_device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    <span class="keyword">return</span> mii_nway_restart(&amp;db-&gt;mii);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Get RX checksum offload state</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> uint32_t <span class="title">dmfe_get_rx_csum</span><span class="params">(struct net_device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    <span class="keyword">return</span> db-&gt;rx_csum;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Get TX checksum offload state</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> uint32_t <span class="title">dmfe_get_tx_csum</span><span class="params">(struct net_device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (dev-&gt;features &amp; NETIF_F_HW_CSUM) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Enable/Disable RX checksum offload</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_set_rx_csum</span><span class="params">(struct net_device *dev, <span class="keyword">uint32_t</span> data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CHECKSUM</span></span><br><span class="line">    <span class="keyword">board_info_t</span> *db = (<span class="keyword">board_info_t</span> *)dev-&gt;priv;</span><br><span class="line">    db-&gt;rx_csum = data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(netif_running(dev)) &#123;</span><br><span class="line">        dmfe_stop(dev);</span><br><span class="line">        dmfe_open(dev);</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">        dmfe_init_dm9000(dev);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    printk(KERN_ERR <span class="string">"DM9:Don't support checksum\n"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Enable/Disable TX checksum offload</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dmfe_set_tx_csum</span><span class="params">(struct net_device *dev, <span class="keyword">uint32_t</span> data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CHECKSUM</span></span><br><span class="line">    <span class="keyword">if</span> (data)</span><br><span class="line">        dev-&gt;features |= NETIF_F_HW_CSUM;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        dev-&gt;features &amp;= ~NETIF_F_HW_CSUM;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    printk(KERN_ERR <span class="string">"DM9:Don't support checksum\n"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//=========================================</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,28)  <span class="comment">/* for kernel 2.4.28 */</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">ethtool_ops</span> <span class="title">dmfe_ethtool_ops</span> = &#123;</span></span><br><span class="line">    .get_drvinfo        = dmfe_get_drvinfo,</span><br><span class="line">    .get_settings       = dmfe_get_settings,</span><br><span class="line">    .set_settings       = dmfe_set_settings,</span><br><span class="line">    .get_link           = dmfe_get_link,</span><br><span class="line">    .nway_reset     = dmfe_nway_reset,</span><br><span class="line">    .get_rx_csum        = dmfe_get_rx_csum,</span><br><span class="line">    .set_rx_csum        = dmfe_set_rx_csum,</span><br><span class="line">    .get_tx_csum        = dmfe_get_tx_csum,</span><br><span class="line">    .set_tx_csum        = dmfe_set_tx_csum,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 简化一点, 不去考虑MODULE的设置. ===== for jz2440 =====</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 1  <span class="comment">// #ifdef MODULE</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">"Davicom DM9000/DM9010 ISA/uP Fast Ethernet Driver"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,5,0)</span></span><br><span class="line">MODULE_PARM(mode, <span class="string">"i"</span>);</span><br><span class="line">MODULE_PARM(irq, <span class="string">"i"</span>);</span><br><span class="line">MODULE_PARM(iobase, <span class="string">"i"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">module_param(mode, <span class="keyword">int</span>, <span class="number">0</span>);</span><br><span class="line">module_param(irq, <span class="keyword">int</span>, <span class="number">0</span>);</span><br><span class="line">module_param(iobase, <span class="keyword">int</span>, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">MODULE_PARM_DESC(mode,<span class="string">"Media Speed, 0:10MHD, 1:10MFD, 4:100MHD, 5:100MFD"</span>);</span><br><span class="line">MODULE_PARM_DESC(irq,<span class="string">"EtherLink IRQ number"</span>);</span><br><span class="line">MODULE_PARM_DESC(iobase, <span class="string">"EtherLink I/O base address"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Description:</span></span><br><span class="line"><span class="comment">   when user used insmod to add module, system invoked init_module()</span></span><br><span class="line"><span class="comment">   to initilize and register.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">int</span> __<span class="function">init <span class="title">init_module</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// ===== for jz2440 =====</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *bwscon;             <span class="comment">// 0x48000000</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *bankcon4;           <span class="comment">// 0x48000014</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> val;</span><br><span class="line"></span><br><span class="line">    iobase = (<span class="keyword">int</span>)ioremap(<span class="number">0x20000000</span>, <span class="number">1024</span>);    <span class="comment">// 设置映射地址. 这里多映射了一点范围.</span></span><br><span class="line">    irq    = IRQ_EINT7;                         <span class="comment">// 设置中断号</span></span><br><span class="line"><span class="comment">/*  */</span></span><br><span class="line">    bwscon   = ioremap(<span class="number">0x48000000</span>, <span class="number">4</span>);          <span class="comment">// 设置S3C2440的memory controller</span></span><br><span class="line">    bankcon4 = ioremap(<span class="number">0x48000014</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* DW4[17:16]: 01-16bit</span></span><br><span class="line"><span class="comment">     * WS4[18]   : 0-WAIT disable</span></span><br><span class="line"><span class="comment">     * ST4[19]   : 0 = Not using UB/LB (The pins are dedicated nWBE[3:0])</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    val = *bwscon;</span><br><span class="line">    val &amp;= ~(<span class="number">0xf</span>&lt;&lt;<span class="number">16</span>);</span><br><span class="line">    val |= (<span class="number">1</span>&lt;&lt;<span class="number">16</span>);</span><br><span class="line">    *bwscon = val;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Tacs[14:13]: 发出片选信号之前,多长时间内要先发出地址信号</span></span><br><span class="line"><span class="comment">     *              DM9000C的片选信号和CMD信号可以同时发出,</span></span><br><span class="line"><span class="comment">     *              所以它设为0</span></span><br><span class="line"><span class="comment">     * Tcos[12:11]: 发出片选信号之后,多长时间才能发出读信号nOE</span></span><br><span class="line"><span class="comment">     *              DM9000C的T1&gt;=0ns,</span></span><br><span class="line"><span class="comment">     *              所以它设为0</span></span><br><span class="line"><span class="comment">     * Tacc[10:8] : 读写信号的脉冲长度,</span></span><br><span class="line"><span class="comment">     *              DM9000C的T2&gt;=10ns,</span></span><br><span class="line"><span class="comment">     *              所以它设为1, 表示2个hclk周期,hclk=100MHz,就是20ns</span></span><br><span class="line"><span class="comment">     * Tcoh[7:6]  : 当读信号nOE变为高电平后,片选信号还要维持多长时间</span></span><br><span class="line"><span class="comment">     *              DM9000C进行写操作时, nWE变为高电平之后, 数据线上的数据还要维持最少3ns</span></span><br><span class="line"><span class="comment">     *              DM9000C进行读操作时, nOE变为高电平之后, 数据线上的数据在6ns之内会消失</span></span><br><span class="line"><span class="comment">     *              我们取一个宽松值: 让片选信号在nOE放为高电平后,再维持10ns,</span></span><br><span class="line"><span class="comment">     *              所以设为01</span></span><br><span class="line"><span class="comment">     * Tcah[5:4]  : 当片选信号变为高电平后, 地址信号还要维持多长时间</span></span><br><span class="line"><span class="comment">     *              DM9000C的片选信号和CMD信号可以同时出现,同时消失</span></span><br><span class="line"><span class="comment">     *              所以设为0</span></span><br><span class="line"><span class="comment">     * PMC[1:0]   : 00-正常模式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    *bankcon4 = (<span class="number">1</span>&lt;&lt;<span class="number">8</span>)|(<span class="number">1</span>&lt;&lt;<span class="number">6</span>);      <span class="comment">// 对于DM9000C可以设Tacc为1, 对于DM9000E,Tacc要设大一点,比如最大值7</span></span><br><span class="line">    <span class="comment">//*bankcon4 = (7&lt;&lt;8)|(1&lt;&lt;6);    // MINI2440使用DM9000E,Tacc要设大一点</span></span><br><span class="line"></span><br><span class="line">    iounmap(bwscon);</span><br><span class="line">    iounmap(bankcon4);</span><br><span class="line"><span class="comment">// ===== end =====</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(mode) &#123;</span><br><span class="line">        <span class="keyword">case</span> DM9KS_10MHD:</span><br><span class="line">        <span class="keyword">case</span> DM9KS_100MHD:</span><br><span class="line">        <span class="keyword">case</span> DM9KS_10MFD:</span><br><span class="line">        <span class="keyword">case</span> DM9KS_100MFD:</span><br><span class="line">            media_mode = mode;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            media_mode = DM9KS_AUTO;</span><br><span class="line">    &#125;</span><br><span class="line">    dmfe_dev = dmfe_probe();</span><br><span class="line">    <span class="keyword">if</span>(IS_ERR(dmfe_dev))</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(dmfe_dev);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Description:</span></span><br><span class="line"><span class="comment">   when user used rmmod to delete module, system invoked clean_module()</span></span><br><span class="line"><span class="comment">   to  un-register DEVICE.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">cleanup_module</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">dev</span> = <span class="title">dmfe_dev</span>;</span></span><br><span class="line">    DMFE_DBUG(<span class="number">0</span>, <span class="string">"clean_module()"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    unregister_netdev(dmfe_dev);</span><br><span class="line">    release_region(dev-&gt;base_addr, <span class="number">2</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,5,0)</span></span><br><span class="line">    kfree(dev);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    free_netdev(dev);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    iounmap((<span class="keyword">void</span> *)iobase);                    <span class="comment">// ===== for jz2440 =====</span></span><br><span class="line">    DMFE_DBUG(<span class="number">0</span>, <span class="string">"clean_module() exit"</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== for jz2440 =====</span></span><br><span class="line">module_init(init_module);                       <span class="comment">// 添加驱动的入口和出口函数</span></span><br><span class="line">module_exit(cleanup_module);</span><br><span class="line"><span class="comment">// ===== end =====</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h2 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu 主机端</span></span><br><span class="line"><span class="comment"># pwd = ./linux-2.6.22.6_custom  复制一个新的内核源码目录</span></span><br><span class="line">$ <span class="built_in">cd</span> ./drivers/net/</span><br><span class="line">$ cp ./dm9dev9000c.c ./dm9dev9000c.back         <span class="comment"># 将原有的驱动备份一下</span></span><br><span class="line"><span class="comment"># 然后将上面的 dm9dev9000c.c 覆盖掉内核里的这个文件.</span></span><br><span class="line"><span class="comment"># Makefile 不用改, 因为jz2440的patch包已经改好了.</span></span><br><span class="line"></span><br><span class="line">$ make clean                                    <span class="comment"># 没把握的话, clean一下</span></span><br><span class="line">$ make uImage</span><br><span class="line"><span class="comment"># 烧录新的uImage</span></span><br><span class="line"><span class="comment"># 重启开发板进入uboot烧录界面, 按k准备烧录内核. 略过不表</span></span><br><span class="line">$ sudo dnw ./arch/arm/boot/uImage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发板端, 开始测试</span></span><br><span class="line"><span class="comment"># 重启, 查看是否能正常启动, 能否进入nfs目录.</span></span><br><span class="line">$ ifcofig                                       <span class="comment"># 查看网卡信息</span></span><br><span class="line">$ ping 10.0.0.100                               <span class="comment"># ping Ubuntu 主机</span></span><br></pre></td></tr></table></figure>
<hr>
<p><strong><em>原创于 <a href="https://draapho.github.io/">DRA&amp;PHO</a></em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/01/26/1812-drv-nor/" itemprop="url">
                  驱动之NOR Flash
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2018-01-26T00:00:00+11:00" content="2018-01-26">
              2018-01-26
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><ul>
<li><a href="https://draapho.github.io/2017/11/23/1734-linux-content/">嵌入式linux学习目录</a></li>
<li><a href="https://draapho.github.io/2018/01/22/1809-drv-blk/">驱动之块设备-框架</a></li>
<li><a href="https://draapho.github.io/2018/01/24/1810-drv-nand1/">驱动之NAND Flash框架</a></li>
<li><a href="https://draapho.github.io/2018/01/25/1811-drv-nand2/">驱动之NAND Flash源码</a></li>
<li><a href="https://draapho.github.io/2018/01/26/1812-drv-nor/">驱动之NOR Flash</a></li>
<li><a href="https://draapho.github.io/2018/02/06/1813-drv-net/">驱动之网卡驱动</a></li>
</ul>
<p>本文使用 linux-2.6.22.6 内核, 使用jz2440开发板.</p>
<h1 id="NOR-Flash-基础知识"><a href="#NOR-Flash-基础知识" class="headerlink" title="NOR Flash 基础知识"></a>NOR Flash 基础知识</h1><h2 id="NAND-和-NOR-Flash的比较"><a href="#NAND-和-NOR-Flash的比较" class="headerlink" title="NAND 和 NOR Flash的比较"></a>NAND 和 NOR Flash的比较</h2><table>
<thead>
<tr>
<th>NOR FLASH</th>
<th>NAND FLASH</th>
</tr>
</thead>
<tbody>
<tr>
<td>接口时序同SRAM,易使用</td>
<td>地址/数据线复用，数据位较窄</td>
</tr>
<tr>
<td>读取速度较快</td>
<td>读取速度较慢</td>
</tr>
<tr>
<td>擦除速度慢，以64-128KB的块为单位</td>
<td>擦除速度快，以8－32KB的块为单位</td>
</tr>
<tr>
<td>写入速度慢</td>
<td>写入速度快</td>
</tr>
<tr>
<td>随机存取速度较快，支持XIP(eXecute In Place，芯片内执行)，适用于代码存储。在嵌入式系统中，常用于存放引导程序、根文件系统等。</td>
<td>顺序读取速度较快，随机存取速度慢，适用于数据存储(如大容量的多媒体应用)。在嵌入式系统中，常用于存放用户文件系统等。</td>
</tr>
<tr>
<td>单片容量较小，1-32MB</td>
<td>单片容量较大，8-128MB，提高了单元密度</td>
</tr>
<tr>
<td>最大擦写次数10万次</td>
<td>最大擦写次数100万次</td>
</tr>
</tbody>
</table>
<h2 id="硬件接口"><a href="#硬件接口" class="headerlink" title="硬件接口"></a>硬件接口</h2><p>看相关数据手册, 以jz2440v3开发板为例:</p>
<ul>
<li><code>MX29LV160DBTI-70G.pdf</code> NOR Flash 数据手册</li>
<li><code>S3C2440A_UserManual_Rev13.pdf</code> CPU 数据手册</li>
</ul>
<p><img src="https://draapho.github.io/images/1812/nor1.JPG" alt="nor1.png"></p>
<p>注意几点:</p>
<ul>
<li>NOR Flash 的特性和RAM一样, 可以直接用物理地址来操作.<ul>
<li>当开发板以NOR Flash启动时, 0开始的地址就是指向NOR Flash的.</li>
</ul>
</li>
<li>NOR Flash 数据位宽有两种接法, 16bit 和 8bit. jz2440用的16bit接法<ul>
<li>因此, 用uboot测试时, 需要使用 <code>mw.w</code> <code>md.w</code> 来操作内存地址</li>
<li><code>mw</code> Memory Write. uboot下的写内存指令</li>
<li><code>md</code> Memory Display. uboot下的读内存指令</li>
<li>使用16bit接法时, CPU的地址线0是不接的. 因而指令上有个错位.</li>
<li>譬如: jz2440发出 (555h&lt;&lt;1), NOR Flash才能收到555h这个地址.</li>
</ul>
</li>
<li>NOR Flash 有两种模式, jedec, cfi<ul>
<li>jedec, 无法直接从芯片内读取详细信息, 需要根据芯片ID软件查表.</li>
<li>cfi, Common Flash Interface, 可以直接查询芯片详细信息.</li>
<li>目前大多数 NOR Flash 都支持 cfi 规范.</li>
</ul>
</li>
</ul>
<h2 id="读写实验"><a href="#读写实验" class="headerlink" title="读写实验"></a>读写实验</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开发板 uboot 命令行, 确保是从 NOR Flash 启动的uboot!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取 ID. 2440的A1接到NOR的A0，所以2440发出的地址全部要左移一位</span></span><br><span class="line">mw.w aaa aa             <span class="comment"># Addr = 555&lt;&lt;1</span></span><br><span class="line">mw.w 554 55             <span class="comment"># Addr = 2AA&lt;&lt;1</span></span><br><span class="line">mw.w aaa 90             <span class="comment"># Addr = 555&lt;&lt;1</span></span><br><span class="line">md.w 0 1</span><br><span class="line"><span class="comment"># 显示 00c2, Manifacture ID</span></span><br><span class="line">md.w 2 1                <span class="comment"># Addr = 1&lt;&lt;1</span></span><br><span class="line"><span class="comment"># 显示 2249, 表示型号 MX29LV160DB</span></span><br><span class="line">mw.w 0 f0               <span class="comment"># Reset Mode, 退出读ID</span></span><br></pre></td></tr></table></figure>
<h1 id="NOR-Flash-系统框架"><a href="#NOR-Flash-系统框架" class="headerlink" title="NOR Flash 系统框架"></a>NOR Flash 系统框架</h1><h2 id="系统自带驱动"><a href="#系统自带驱动" class="headerlink" title="系统自带驱动"></a>系统自带驱动</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu 主机端</span></span><br><span class="line"><span class="comment"># pwd = ./linux-2.6.22.6</span></span><br><span class="line"></span><br><span class="line">$ make clean</span><br><span class="line">$ make menuconfig                                       <span class="comment"># 增加对NOR Flash的支持</span></span><br><span class="line"><span class="comment"># -&gt; Device Drivers</span></span><br><span class="line"><span class="comment">#   -&gt; Memory Technology Device (MTD) support</span></span><br><span class="line"><span class="comment">#     -&gt; Mapping drivers for chip access</span></span><br><span class="line"><span class="comment">#       &lt;M&gt; CFI Flash device in physical memory map     # CFI NOR Flash, 直接做物理映射就可以了</span></span><br><span class="line"><span class="comment">#       (0x0) Physical start address of flash mapping   # 物理基地址, 从0开始的</span></span><br><span class="line"><span class="comment">#       (0x2000000) Physical length of flash mapping    # 要映射的长度, 就是芯片的大小</span></span><br><span class="line"><span class="comment">#       (2)   Bank width in octets (NEW)                # 数据线位宽, 2就是2字节,  16bit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 比较 .config 会发现多了如下配置. 从而可以找到文件 "drivers/mtd/chips/phram.c"</span></span><br><span class="line"><span class="comment"># CONFIG_MTD_PHYSMAP=m</span></span><br><span class="line"><span class="comment"># CONFIG_MTD_PHYSMAP_START=0</span></span><br><span class="line"><span class="comment"># CONFIG_MTD_PHYSMAP_LEN=0x2000000</span></span><br><span class="line"><span class="comment"># CONFIG_MTD_PHYSMAP_BANKWIDTH=2</span></span><br><span class="line"></span><br><span class="line">$ make modules                                          <span class="comment"># 会生成 physmap.ko</span></span><br><span class="line">cp ./drivers/mtd/maps/physmap.ko ~/share/jz2440/drivers/nor/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发板端, 开始测试</span></span><br><span class="line"><span class="comment"># pwd = ~/share/jz2440/drivers/nor/                     # NOR flash驱动目录, nfs</span></span><br><span class="line">$ ls /dev/mtd*                                          <span class="comment"># 查看一下mtd现有设备</span></span><br><span class="line">$ insmod physmap.ko                                     <span class="comment"># 加载驱动</span></span><br><span class="line">$ ls /dev/mtd*                                          <span class="comment"># 增加了若干mtd设备</span></span><br><span class="line">$ cat /proc/mtd</span><br></pre></td></tr></table></figure>
<h2 id="框架分析"><a href="#框架分析" class="headerlink" title="框架分析"></a>框架分析</h2><p>其基本框架和 NAND Flash 是一样的</p>
<p><img src="https://draapho.github.io/images/1812/nor2.png" alt="nor2.png"></p>
<p>下面, 分析一下 CFI NOR Flash 的内核代码框架</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -----&gt; /drivers/mtd/maps/physmap.c</span></span><br><span class="line">module_init(physmap_init)</span><br><span class="line">    platform_driver_register(&amp;physmap_flash_driver);    <span class="comment">// 上来就是自己玩platform框架</span></span><br><span class="line">    platform_device_register(&amp;physmap_flash);</span><br><span class="line"></span><br><span class="line"># 匹配后, 自然是调用probe函数</span><br><span class="line">physmap_flash_probe</span><br><span class="line">    probe_type = rom_probe_types;                       <span class="comment">// "cfi_probe" "jedec_probe" 都是用于NOR Flash的</span></span><br><span class="line">    do_map_probe(*probe_type, &amp;info-&gt;<span class="built_in">map</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// -----&gt; /drivers/mtd/chips/chipreg.c</span></span><br><span class="line">    do_map_probe</span><br><span class="line">        drv = get_mtd_chip_driver(name);</span><br><span class="line">            list_entry(pos, typeof(*<span class="keyword">this</span>), <span class="built_in">list</span>)        <span class="comment">// this 是 mtd_chip_driver 类型</span></span><br><span class="line">        drv-&gt;probe(<span class="built_in">map</span>);</span><br><span class="line">        <span class="comment">// 搜索 mtd_chip_driver 查看来源. 可以猜出和文件 cfi_probe.c 有关.</span></span><br><span class="line">        <span class="comment">// 实际调用了 cfi_probe      // -----&gt; drivers/mtd/chips/cfi_probe.c</span></span><br><span class="line">    <span class="comment">// -----&gt; 结束, chipreg.c</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// add_mtd_partitions                               // 有分区则进行分区, 最终也会调用 add_mtd_device</span></span><br><span class="line">    add_mtd_device                                      <span class="comment">// 添加mtd设备</span></span><br><span class="line">    <span class="comment">// 然后就会跳到 mtdcore.c 后面和 NAND Flash 一样了. 或参考下面的一个例子</span></span><br><span class="line">    <span class="comment">// 最终会去注册 字符设备 和 块设备</span></span><br><span class="line"><span class="comment">// -----&gt; 结束, physmap.c</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// -----&gt; drivers/mtd/chips/cfi_probe.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">mtd_chip_driver</span> <span class="title">cfi_chipdrv</span>;</span>              <span class="comment">// .probe = cfi_probe</span></span><br><span class="line">cfi_probe</span><br><span class="line">    mtd_do_chip_probe(<span class="built_in">map</span>, &amp;cfi_chip_probe);            <span class="comment">// 识别cfi设备</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// -----&gt; drivers/mtd/chips/gen_probe.c</span></span><br><span class="line">    mtd_do_chip_probe</span><br><span class="line">        genprobe_ident_chips</span><br><span class="line">            cp-&gt;probe_chip                              <span class="comment">// 调用 cfi_chip_probe.probe_chip</span></span><br><span class="line">            <span class="comment">// 实际调用函数 cfi_probe_chip</span></span><br><span class="line">        check_cmd_set                                   <span class="comment">// 初始化 mtd_info 结构体</span></span><br><span class="line">    <span class="comment">// -----&gt; 结束, gen_probe.c</span></span><br><span class="line"></span><br><span class="line">cfi_probe_chip</span><br><span class="line">    cfi_send_gen_cmd                                    <span class="comment">// 发送CFI指令, 获取芯片信息</span></span><br><span class="line"><span class="comment">// -----&gt; 结束, cfi_probe.c</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// drivers/mtd/chips/jedec_probe.c 有 jedec_probe. 用于jedec设备</span></span><br><span class="line"><span class="comment">// drivers/mtd/chips/map_rom.c 有 map_rom_probe. 应该是用于CPU内置的ROM.</span></span><br></pre></td></tr></table></figure>
<p>这样就比较清楚了, 整个Linux代码尽可能的做到功能上的(代码上没有完全做到)分层分离.<br>大框架下有小框架. 譬如 NOR Flash 属于整个MTD大框架的一部分. 但其内部也有自己的一套小框架.</p>
<p>在 NOR Flash 这个例子里面,<br>将通用的底层驱动代码放在文件 <code>/drivers/mtd/maps/physmap.c</code><br>然后probe时, 具体的硬件操作被拆分三个部分 <code>cfi_probe.c</code> <code>jedec_probe.c</code> <code>map_rom.c</code><br>由于probe里面也有共性的东西, 又被提炼成 <code>gen_probe.c</code> 放在一起.</p>
<p>最后, 看一个最简单的例子, ram模拟mtd设备. 将底层硬件相关操作减到了最少.<br>这个RAM mtd设备和 NAND/NOR Flash 平级, 挂在 <code>mtdcore.c</code> 下.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -----&gt; /drivers/mtd/devices/phram.c</span></span><br><span class="line">module_param_call(phram, phram_setup, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">000</span>);         <span class="comment">// 由uboot传递参数进来</span></span><br><span class="line">phram_setup</span><br><span class="line">    register_device(name, start, len);</span><br><span class="line">        <span class="keyword">new</span>-&gt;mtd.XXX = XXX;                                     <span class="comment">// 初始化 mtd_info 结构体</span></span><br><span class="line">        add_mtd_device                                          <span class="comment">// 添加 mtd设备</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// -----&gt; /drivers/mtd/mtdcore.c                        // mtd 设备核心</span></span><br><span class="line">        add_mtd_device</span><br><span class="line">            <span class="keyword">not</span> = list_entry(<span class="keyword">this</span>, struct mtd_notifier, <span class="built_in">list</span>);  <span class="comment">// struct mtd_notifier 结构体是关键</span></span><br><span class="line">            <span class="keyword">not</span>-&gt;add(mtd);                                      <span class="comment">// 调用了add</span></span><br><span class="line">            <span class="comment">// 搜索 mtd_notifier 查看来源, 可知:</span></span><br><span class="line">            <span class="comment">// 实际调用了 mtd_notify_add         // -----&gt; drivers/mtd/mtdchar.c</span></span><br><span class="line">            <span class="comment">// 实际调用了 blktrans_notify_add    // -----&gt; drivers/mtd/mtd_blkdevs.c</span></span><br><span class="line">        <span class="comment">// -----&gt; 结束, mtdcore.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//可见, 核心内容就是 初始化mtd_info结构体, 然后 add_mtd_device</span></span><br><span class="line"><span class="comment">// -----&gt; 结束, phram.c</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// -----&gt; drivers/mtd/mtdchar.c                                 // 将mtd设备挂载成字符设备</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">mtd_notifier</span> <span class="title">notifier</span>;</span>                            <span class="comment">// .add = mtd_notify_add</span></span><br><span class="line">mtd_notify_add</span><br><span class="line">    class_device_create(<span class="string">"mtd%d"</span>)                                <span class="comment">// mtd字符设备, 可读写</span></span><br><span class="line">    class_device_create(<span class="string">"mtd%dro"</span>)                              <span class="comment">// mtd只读字符设备</span></span><br><span class="line">init_mtdchar                                                    <span class="comment">// mtdchar.c 的 module_init</span></span><br><span class="line">    register_chrdev(MTD_CHAR_MAJOR, <span class="string">"mtd"</span>, &amp;mtd_fops)           <span class="comment">// 注册为字符设备</span></span><br><span class="line"><span class="comment">// -----&gt; 结束, mtdchar.c 完成了字符设备的核心步骤.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// -----&gt; drivers/mtd/mtd_blkdevs.c                             // 将mtd设备挂载成块设备</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">mtd_notifier</span> <span class="title">blktrans_notifier</span>;</span>                   <span class="comment">// .add = blktrans_notify_add</span></span><br><span class="line">blktrans_notify_add</span><br><span class="line">    tr = list_entry(<span class="keyword">this</span>, struct mtd_blktrans_ops, <span class="built_in">list</span>);       <span class="comment">// 一样的, 搜索 mtd_blktrans_ops</span></span><br><span class="line">    tr-&gt;add_mtd(tr, mtd);</span><br><span class="line">    <span class="comment">// 可以找到两个文件有初始化, 很明显是块设备读写还是只读的区别. 选取 /drivers/mtd/mtdblock.c</span></span><br><span class="line">    <span class="comment">// 实际调用了 mtdblock_add_mtd</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// -----&gt; /drivers/mtd/mtdblock.c</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">mtd_blktrans_ops</span> <span class="title">mtdblock_tr</span>;</span>                 <span class="comment">// .add_mtd = mtdblock_add_mtd</span></span><br><span class="line">    mtdblock_add_mtd</span><br><span class="line">        add_mtd_blktrans_dev</span><br><span class="line">            alloc_disk                                          <span class="comment">// 分配 gendisk</span></span><br><span class="line">            add_disk                                            <span class="comment">// 注册为块设备</span></span><br><span class="line">    init_mtdblock                                               <span class="comment">// mtdblock.c 的 module_init</span></span><br><span class="line">        register_mtd_blktrans</span><br><span class="line">            register_blkdev                                     <span class="comment">// 获得主设备号</span></span><br><span class="line">            blk_init_queue                                      <span class="comment">// 设置缓冲队列</span></span><br><span class="line">    <span class="comment">// -----&gt; 结束, mtdblock.c 完成了块设备的核心步骤.</span></span><br><span class="line"><span class="comment">// -----&gt; 结束, mtd_blkdevs</span></span><br></pre></td></tr></table></figure></p>
<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><h2 id="s3c-nor-c"><a href="#s3c-nor-c" class="headerlink" title="s3c_nor.c"></a>s3c_nor.c</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 参考 drivers\mtd\maps\physmap.c</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mtd/mtd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mtd/map.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mtd/partitions.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"DRAAPHO"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">map_info</span> *<span class="title">s3c_nor_map</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">mtd_info</span> *<span class="title">s3c_nor_mtd</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">mtd_partition</span> <span class="title">s3c_nor_parts</span>[] = &#123;</span>             <span class="comment">// 复杂一点, 做一个分区信息</span></span><br><span class="line">    [<span class="number">0</span>] = &#123;</span><br><span class="line">        .name   = <span class="string">"bootloader_nor"</span>,</span><br><span class="line">        .size   = <span class="number">0x00040000</span>,</span><br><span class="line">        .offset = <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="number">1</span>] = &#123;</span><br><span class="line">        .name   = <span class="string">"root_nor"</span>,</span><br><span class="line">        .offset = MTDPART_OFS_APPEND,</span><br><span class="line">        .size   = MTDPART_SIZ_FULL,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s3c_nor_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 1. 分配map_info结构体 */</span></span><br><span class="line">    s3c_nor_map = kzalloc(<span class="keyword">sizeof</span>(struct map_info), GFP_KERNEL);;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2. 设置: 物理基地址(phys), 大小(size), 位宽(bankwidth), 虚拟基地址(virt) */</span></span><br><span class="line">    s3c_nor_map-&gt;name = <span class="string">"s3c_nor"</span>;</span><br><span class="line">    s3c_nor_map-&gt;phys = <span class="number">0</span>;                                              <span class="comment">// 对应的物理地址</span></span><br><span class="line">    s3c_nor_map-&gt;size = <span class="number">0x2000000</span>;                                      <span class="comment">// NOR的容量</span></span><br><span class="line">    s3c_nor_map-&gt;bankwidth = <span class="number">2</span>;                                         <span class="comment">// 数据线位宽, 单位字节</span></span><br><span class="line">    s3c_nor_map-&gt;virt = ioremap(s3c_nor_map-&gt;phys, s3c_nor_map-&gt;size);  <span class="comment">// 对应的虚拟地址</span></span><br><span class="line">    simple_map_init(s3c_nor_map);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3. 使用: 调用NOR FLASH协议层提供的函数来识别 */</span></span><br><span class="line">    printk(<span class="string">"use cfi_probe\n"</span>);</span><br><span class="line">    s3c_nor_mtd = do_map_probe(<span class="string">"cfi_probe"</span>, s3c_nor_map);               <span class="comment">// 直接去调用 .probe = cfi_probe</span></span><br><span class="line">    <span class="keyword">if</span> (!s3c_nor_mtd) &#123;</span><br><span class="line">        printk(<span class="string">"use jedec_probe\n"</span>);</span><br><span class="line">        s3c_nor_mtd = do_map_probe(<span class="string">"jedec_probe"</span>, s3c_nor_map);         <span class="comment">// 失败, 尝试 jedec 模式</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!s3c_nor_mtd) &#123;</span><br><span class="line">        iounmap(s3c_nor_map-&gt;virt);</span><br><span class="line">        kfree(s3c_nor_map);</span><br><span class="line">        <span class="keyword">return</span> -EIO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 4. add_mtd_partitions */</span></span><br><span class="line">    add_mtd_partitions(s3c_nor_mtd, s3c_nor_parts, <span class="number">2</span>);                  <span class="comment">// 里面调用 add_mtd_device</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">s3c_nor_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    del_mtd_partitions(s3c_nor_mtd);</span><br><span class="line">    iounmap(s3c_nor_map-&gt;virt);</span><br><span class="line">    kfree(s3c_nor_map);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(s3c_nor_init);</span><br><span class="line">module_exit(s3c_nor_exit);</span><br></pre></td></tr></table></figure>
<h2 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">obj-m       := s3c_nor.o</span><br><span class="line">KERN_SRC    := /home/draapho/share/jz2440/kernel/linux-2.6.22.6/</span><br><span class="line">PWD         := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line"></span><br><span class="line"><span class="section">modules:</span></span><br><span class="line">    make -C <span class="variable">$(KERN_SRC)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    make -C <span class="variable">$(KERN_SRC)</span> M=<span class="variable">$(PWD)</span> clean</span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu 主机端</span></span><br><span class="line"><span class="comment"># pwd = ~/share/jz2440/drivers/nor/         # NOR flash驱动目录</span></span><br><span class="line">$ make modules                              <span class="comment"># 生成s3c_nor.ko</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发板端, 开始测试</span></span><br><span class="line"><span class="comment"># pwd = ~/share/jz2440/drivers/nor/         # NOR flash驱动目录, nfs</span></span><br><span class="line">$ ls /dev/mtd*                              <span class="comment"># 查看现有的mtd设备</span></span><br><span class="line">$ insmod s3c_nor.ko                         <span class="comment"># 加载驱动</span></span><br><span class="line">$ ls /dev/mtd*                              <span class="comment"># 查看新增的mtd设备</span></span><br><span class="line">$ flash_eraseall -j /dev/mtd5               <span class="comment"># 格式化为 jffs2, 注意新增的不一定是mtd5</span></span><br><span class="line">$ mount -t jffs2 /dev/mtdblock5 /mnt        <span class="comment"># 挂载这个设备到 /mnt</span></span><br><span class="line"><span class="comment"># 在 /mnt 下进行文件的创建和操作, 测试该文件系统.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果没有 flash_eraseall 指令, 则需要编译mtd格式化工具 mtd-utils</span></span><br><span class="line"><span class="comment"># Ubuntu 主机端</span></span><br><span class="line">$ tar xjf mtd-utils-05.07.23.tar.bz2</span><br><span class="line">$ <span class="built_in">cd</span> mtd-utils-05.07.23/util</span><br><span class="line">$ vim Makefile</span><br><span class="line">    <span class="comment"># ===== 文件内容, 修改如下内容: =====</span></span><br><span class="line">    <span class="comment">#CROSS=arm-linux-   # 需要交叉编译, 取消注释</span></span><br><span class="line">    CROSS=arm-linux-</span><br><span class="line">    <span class="comment"># ===== 结束修改, 保存退出vim =====</span></span><br><span class="line">$ make</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发板端</span></span><br><span class="line"><span class="comment"># 通过nfs拷贝到bin目录下即可.</span></span><br><span class="line"><span class="comment"># pwd = ./mtd-utils-05.07.23/util           # nfs文件</span></span><br><span class="line">$ cp flash_erase flash_eraseall /bin</span><br></pre></td></tr></table></figure>
<hr>
<p><strong><em>原创于 <a href="https://draapho.github.io/">DRA&amp;PHO</a></em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/01/25/1811-drv-nand2/" itemprop="url">
                  驱动之NAND Flash源码
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2018-01-25T00:00:00+11:00" content="2018-01-25">
              2018-01-25
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><ul>
<li><a href="https://draapho.github.io/2017/11/23/1734-linux-content/">嵌入式linux学习目录</a></li>
<li><a href="https://draapho.github.io/2018/01/22/1809-drv-blk/">驱动之块设备-框架</a></li>
<li><a href="https://draapho.github.io/2018/01/24/1810-drv-nand1/">驱动之NAND Flash框架</a></li>
<li><a href="https://draapho.github.io/2018/01/25/1811-drv-nand2/">驱动之NAND Flash源码</a></li>
<li><a href="https://draapho.github.io/2018/01/26/1812-drv-nor/">驱动之NOR Flash</a></li>
<li><a href="https://draapho.github.io/2018/02/06/1813-drv-net/">驱动之网卡驱动</a></li>
</ul>
<p>本文使用 linux-2.6.22.6 内核, 使用jz2440开发板.</p>
<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>由 <strong>nand flash 系统框架</strong> 分析可知, Linux内核系统以及完成了Nand Flash设备的绝大部分的核心工作.<br>因此Nand Flash驱动真正要做的工作主要就是:</p>
<ul>
<li>分配并初始化 <code>nand_chip</code> 结构体</li>
<li>初始化硬件</li>
<li>调用 <code>nand_scan</code></li>
<li>调用 <code>add_mtd_partitions</code></li>
</ul>
<p>可以参考内核文件的相关源码, 学着写.</p>
<ul>
<li><code>drivers\mtd\nand\at91_nand.c</code></li>
<li><code>drivers\mtd\nand\s3c2410.c</code></li>
</ul>
<p>流程如下图:<br><img src="https://draapho.github.io/images/1810/nand3.jpg" alt="nand3"></p>
<h2 id="s3c-nand-c"><a href="#s3c-nand-c" class="headerlink" title="s3c_nand.c"></a>s3c_nand.c</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mtd/mtd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mtd/nand.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mtd/partitions.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/clk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/arch/regs-nand.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/arch/nand.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"DRAAPHO"</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">s3c_nand_regs</span> &#123;</span>                              <span class="comment">// 2440芯片NAND Flash相关寄存器</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nfconf  ;                         <span class="comment">// 物理地址 0x4E000000</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nfcont  ;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nfcmd   ;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nfaddr  ;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nfdata  ;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nfeccd0 ;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nfeccd1 ;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nfeccd  ;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nfstat  ;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nfestat0;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nfestat1;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nfmecc0 ;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nfmecc1 ;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nfsecc  ;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nfsblk  ;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nfeblk  ;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nand_chip</span> *<span class="title">s3c_nand</span>;</span>                  <span class="comment">// NAND Flash操作的核心结构体</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">mtd_info</span> *<span class="title">s3c_mtd</span>;</span>                    <span class="comment">// 给两个系统函数使用的结构体</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">s3c_nand_regs</span> *<span class="title">s3c_nand_regs</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">mtd_partition</span> <span class="title">s3c_nand_parts</span>[] = &#123;</span>    <span class="comment">// 分区信息</span></span><br><span class="line">    [<span class="number">0</span>] = &#123;</span><br><span class="line">        .name   = <span class="string">"bootloader"</span>,</span><br><span class="line">        .size   = <span class="number">0x00040000</span>,</span><br><span class="line">        .offset = <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="number">1</span>] = &#123;</span><br><span class="line">        .name   = <span class="string">"params"</span>,</span><br><span class="line">        .offset = MTDPART_OFS_APPEND,</span><br><span class="line">        .size   = <span class="number">0x00020000</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="number">2</span>] = &#123;</span><br><span class="line">        .name   = <span class="string">"kernel"</span>,</span><br><span class="line">        .offset = MTDPART_OFS_APPEND,</span><br><span class="line">        .size   = <span class="number">0x00200000</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="number">3</span>] = &#123;</span><br><span class="line">        .name   = <span class="string">"root"</span>,</span><br><span class="line">        .offset = MTDPART_OFS_APPEND,</span><br><span class="line">        .size   = MTDPART_SIZ_FULL,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不能用Linux默认的片选函数(nand_set_defaults), 自己根据数据手册写一下.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">s3c2440_select_chip</span><span class="params">(struct mtd_info *mtd, <span class="keyword">int</span> chipnr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (chipnr == <span class="number">-1</span>) &#123;</span><br><span class="line">        s3c_nand_regs-&gt;nfcont |= (<span class="number">1</span>&lt;&lt;<span class="number">1</span>);            <span class="comment">// NFCONT bit1=1, 取消片选</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        s3c_nand_regs-&gt;nfcont &amp;= ~(<span class="number">1</span>&lt;&lt;<span class="number">1</span>);           <span class="comment">// NFCONT bit1=0, 使能片选</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">s3c2440_cmd_ctrl</span><span class="params">(struct mtd_info *mtd, <span class="keyword">int</span> dat, <span class="keyword">unsigned</span> <span class="keyword">int</span> ctrl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ctrl &amp; NAND_CLE) &#123;</span><br><span class="line">        s3c_nand_regs-&gt;nfcmd = dat;                 <span class="comment">// NFCMMD=dat, 发送命令</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        s3c_nand_regs-&gt;nfaddr = dat;                <span class="comment">// NFADDR=dat, 发送地址</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s3c2440_dev_ready</span><span class="params">(struct mtd_info *mtd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (s3c_nand_regs-&gt;nfstat &amp; (<span class="number">1</span>&lt;&lt;<span class="number">0</span>));        <span class="comment">// NFSTAT bit0=0, Busy else Ready</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s3c_nand_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">clk</span> *<span class="title">clk</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. 分配nand_chip 和 mtd_info 结构体 */</span></span><br><span class="line">    s3c_nand = kzalloc(<span class="keyword">sizeof</span>(struct nand_chip), GFP_KERNEL);</span><br><span class="line">    s3c_mtd = kzalloc(<span class="keyword">sizeof</span>(struct mtd_info), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得寄存器的虚拟地址. 0x4E000000是这些寄存器的起始物理地址</span></span><br><span class="line">    s3c_nand_regs = ioremap(<span class="number">0x4E000000</span>, <span class="keyword">sizeof</span>(struct s3c_nand_regs));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2. 设置nand_chip */</span></span><br><span class="line">    <span class="comment">/* nand_chip 需要提供 NAND Flash 操作的基本函数. 通用的函数已经由 nand_set_defaults 设置好了.</span></span><br><span class="line"><span class="comment">     * 需要自己设置的函数主要有: 片选,发指令,发地址,发数据,读数据,判断状态的功能</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    s3c_nand-&gt;select_chip = s3c2440_select_chip;    <span class="comment">// 片选函数</span></span><br><span class="line">    s3c_nand-&gt;cmd_ctrl    = s3c2440_cmd_ctrl;       <span class="comment">// 发送指令/地址</span></span><br><span class="line">    s3c_nand-&gt;IO_ADDR_R   = &amp;s3c_nand_regs-&gt;nfdata; <span class="comment">// 读数据的虚拟地址</span></span><br><span class="line">    s3c_nand-&gt;IO_ADDR_W   = &amp;s3c_nand_regs-&gt;nfdata; <span class="comment">// 发数据的虚拟地址</span></span><br><span class="line">    s3c_nand-&gt;dev_ready   = s3c2440_dev_ready;      <span class="comment">// 芯片Busy/Ready的状态反馈</span></span><br><span class="line">    s3c_nand-&gt;ecc.mode    = NAND_ECC_SOFT;          <span class="comment">// ECC校验方式. 软件或硬件.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3. 硬件相关的设置: 根据NAND FLASH的手册设置时间参数 */</span></span><br><span class="line">    <span class="comment">// 使能NAND控制器的时钟</span></span><br><span class="line">    clk = clk_get(<span class="literal">NULL</span>, <span class="string">"nand"</span>);                    <span class="comment">// 由名称"nand"获得时钟</span></span><br><span class="line">    clk_enable(clk);                                <span class="comment">// 实际上就是 CLKCON bit[4]=1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置 NFCONF 寄存器. 由启动的打印信息可获得 HCLK=100MHz, 设置时序要求.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TACLS    0  <span class="comment">// 发出CLE/ALE之后多长时间才发出nWE信号, 从NAND手册可知CLE/ALE与nWE可以同时发出,所以TACLS=0</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TWRPH0   1  <span class="comment">// nWE的脉冲宽度, HCLK x ( TWRPH0 + 1 ), 从NAND手册可知它要&gt;=12ns, 所以TWRPH0&gt;=1</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TWRPH1   0  <span class="comment">// nWE变为高电平后多长时间CLE/ALE才能变为低电平, 从NAND手册可知它要&gt;=5ns, 所以TWRPH1&gt;=0</span></span></span><br><span class="line">    s3c_nand_regs-&gt;nfconf = (TACLS&lt;&lt;<span class="number">12</span>) | (TWRPH0&lt;&lt;<span class="number">8</span>) | (TWRPH1&lt;&lt;<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置 NFCONT 寄存器. BIT1=1, 取消片选. BIT0=1, 使能NAND控制器</span></span><br><span class="line">    s3c_nand_regs-&gt;nfcont = (<span class="number">1</span>&lt;&lt;<span class="number">1</span>) | (<span class="number">1</span>&lt;&lt;<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 4. 使用: nand_scan */</span></span><br><span class="line">    s3c_mtd-&gt;owner = THIS_MODULE;</span><br><span class="line">    s3c_mtd-&gt;priv  = s3c_nand;</span><br><span class="line">    nand_scan(s3c_mtd, <span class="number">1</span>);                          <span class="comment">// 识别NAND FLASH, 构造mtd_info. 硬件只有1块NAND Flash.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 5. add_mtd_partitions</span></span><br><span class="line"><span class="comment">     * 增加 add_mtd_partitions 函数后,</span></span><br><span class="line"><span class="comment">     * 内核必须去掉自带的NAND Flash驱动, 从NFS启动系统.</span></span><br><span class="line"><span class="comment">     * 确认要做这个实验的时候, 再取消下面的注释, 编译测试</span></span><br><span class="line"><span class="comment">     * 如果不需要分区, 只需调用 add_mtd_device(s3c_mtd);</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// add_mtd_partitions(s3c_mtd, s3c_nand_parts, 4);  // 告知分区要求, 调用 add_mtd_partitions</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">s3c_nand_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    del_mtd_partitions(s3c_mtd);</span><br><span class="line">    iounmap(s3c_nand_regs);</span><br><span class="line">    kfree(s3c_mtd);</span><br><span class="line">    kfree(s3c_nand);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(s3c_nand_init);</span><br><span class="line">module_exit(s3c_nand_exit);</span><br></pre></td></tr></table></figure>
<h2 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">obj-m       := s3c_nand.o</span><br><span class="line">KERN_SRC    := /home/draapho/share/jz2440/kernel/linux-2.6.22.6/</span><br><span class="line">PWD         := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line"></span><br><span class="line"><span class="section">modules:</span></span><br><span class="line">    make -C <span class="variable">$(KERN_SRC)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    make -C <span class="variable">$(KERN_SRC)</span> M=<span class="variable">$(PWD)</span> clean</span><br></pre></td></tr></table></figure>
<h2 id="测试1"><a href="#测试1" class="headerlink" title="测试1"></a>测试1</h2><p>源码没有调用 <code>add_mtd_partitions</code> 时, 简单测试一下NAND Flash是否正常工作了.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu 主机端</span></span><br><span class="line"><span class="comment"># pwd = ~/share/jz2440/drivers/nand/            # NAND flash驱动目录</span></span><br><span class="line">$ make modules                                  <span class="comment"># 生成s3c_nand.ko, 忽略 s3c_nand_parts 没有使用的警告信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发板端, 开始测试</span></span><br><span class="line"><span class="comment"># pwd = ~/share/jz2440/drivers/nand/            # NAND flash驱动目录, nfs</span></span><br><span class="line">$ insmod s3c_nand.ko                            <span class="comment"># 加载驱动</span></span><br><span class="line">NAND device: Manufacturer ID: 0xec, Chip ID: 0xda (Samsung NAND 256MiB 3,3V 8-bit)</span><br><span class="line">Scanning device <span class="keyword">for</span> bad blocks</span><br><span class="line">......</span><br><span class="line"><span class="comment"># 打印信息正确识别了 Nand Flash, 说明底层操作都成功了.</span></span><br></pre></td></tr></table></figure>
<h2 id="测试2"><a href="#测试2" class="headerlink" title="测试2"></a>测试2</h2><p>源码调用 <code>add_mtd_partitions</code> 时, 测试过程比较复杂.</p>
<ol>
<li>卸载内核自带的NAND Flash驱动</li>
<li>导致无法从本地Flash启动, 必须设置为从nfs启动</li>
<li>从nfs启动后, 加载 s3c_nand.ko 驱动.</li>
<li>使用工具 <code>mtd-utils</code> 格式化 NAND Flash</li>
<li>格式化后, 就能挂载测试了.</li>
<li>恢复原来的开发环境.</li>
</ol>
<p><strong>这个实验我没有实际去做, 设置和恢复都太麻烦. 而且正常的开发过程是不会这样去操作的.</strong><br>下面给出实验步骤:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 卸载内核自带的NAND Flash驱动</span></span><br><span class="line"><span class="comment"># Ubuntu 主机端</span></span><br><span class="line"><span class="comment"># pwd = ./linux-2.6.22.6_custom  复制一个新的内核源码目录</span></span><br><span class="line"></span><br><span class="line">$ make clean</span><br><span class="line">$ make menuconfig                               <span class="comment"># 去掉自带的HID USB驱动程序</span></span><br><span class="line"><span class="comment"># -&gt; Device Drivers</span></span><br><span class="line"><span class="comment">#   -&gt; Memory Technology Device (MTD) support</span></span><br><span class="line"><span class="comment">#     -&gt; NAND Device Support</span></span><br><span class="line"><span class="comment">#       &lt; &gt; NAND Flash support for S3C2410/S3C2440 SoC  # 取消内置的NAND Flash驱动</span></span><br><span class="line"></span><br><span class="line">$ make uImage</span><br><span class="line"><span class="comment"># 烧录新的uImage</span></span><br><span class="line"><span class="comment"># 重启开发板进入uboot烧录界面, 按k准备烧录内核. 略过不表</span></span><br><span class="line">$ sudo dnw ./arch/arm/boot/uImage</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2. 导致无法从本地Flash启动, 必须设置为从nfs启动.</span><br><span class="line"><span class="comment"># 可参考 "嵌入式linux环境搭建-jz2440开发板" 一文</span></span><br><span class="line"><span class="comment"># 开发板, uboot命令行下</span></span><br><span class="line"><span class="comment"># 要使用nfs功能, 必须正确设置uboot的ip地址, 并且Ubuntu端正确设置了nfs</span></span><br><span class="line"></span><br><span class="line">printenv                                        <span class="comment"># 看下现有的uboot环境, 记好bootargs, 恢复的时候要用的.</span></span><br><span class="line"><span class="comment"># bootargs=noinitrd root=/dev/mtdblock3 init=/linuxrc console=ttySAC0</span></span><br><span class="line"><span class="built_in">set</span> bootargs noinitrd root=/dev/nfs nfsroot=10.0.0.98:/fs ip=10.0.0.111:10.0.0.98:10.0.0.138:255.255.255.0::eth0:off init=/linuxrc console=ttySAC0</span><br><span class="line"><span class="comment"># (简化ip: 'set bootargs noinitrd root=/dev/nfs nfsroot=10.0.0.98:/fs ip=10.0.0.111 init=/linuxrc console=ttySAC0' 也可以工作)</span></span><br><span class="line">save        <span class="comment"># 保存修改</span></span><br><span class="line">reset       <span class="comment"># 重启.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数简要说明:</span></span><br><span class="line"><span class="comment"># 'root=/dev/nfs' 加载nfs文件系统</span></span><br><span class="line"><span class="comment"># 'nfsroot=10.0.0.98:/fs' nfs文件系统的来源, 此处是由Ubuntu当nfs服务器, 共享出/fs文件夹</span></span><br><span class="line"><span class="comment"># 'ip=10.0.0.111:10.0.0.98:10.0.0.138:255.255.255.0::eth0:off' 分别表示:</span></span><br><span class="line"><span class="comment">#  ip= 开发板ip : nfs服务器ip: 网关ip : 子网掩码 :: 开发板网口 : off</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3. 从nfs启动后, 加载 s3c_nand.ko 驱动.</span><br><span class="line"><span class="comment"># Ubuntu 主机端</span></span><br><span class="line"><span class="comment"># pwd = ~/share/jz2440/drivers/nand/            # NAND flash驱动目录</span></span><br><span class="line">$ make modules                                  <span class="comment"># 生成s3c_nand.ko</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发板端, 开始测试</span></span><br><span class="line"><span class="comment"># pwd = ~/share/jz2440/drivers/nand/            # NAND flash驱动目录, nfs</span></span><br><span class="line">$ insmod s3c_nand.ko                            <span class="comment"># 加载驱动</span></span><br><span class="line">NAND device: Manufacturer ID: 0xec, Chip ID: 0xda (Samsung NAND 256MiB 3,3V 8-bit)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4. 使用工具 mtd-utils 格式化 NAND Flash</span><br><span class="line"><span class="comment"># Ubuntu 主机端, 需要先编译mtd-utils</span></span><br><span class="line">$ tar xjf mtd-utils-05.07.23.tar.bz2</span><br><span class="line">$ <span class="built_in">cd</span> mtd-utils-05.07.23/util</span><br><span class="line">$ vim Makefile</span><br><span class="line">    <span class="comment"># ===== 文件内容, 修改如下内容: =====</span></span><br><span class="line">    <span class="comment">#CROSS=arm-linux-   # 需要交叉编译, 取消注释</span></span><br><span class="line">    CROSS=arm-linux-</span><br><span class="line">    <span class="comment"># ===== 结束修改, 保存退出vim =====</span></span><br><span class="line">$ make</span><br><span class="line"><span class="comment"># 拷贝可执行文件到挂载的nfs文件系统的bin目录下</span></span><br><span class="line">$ cp flash_erase flash_eraseall /home/draapho/share/jz2440/nfs/fs_mini_mdev/bin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5. 格式化后, 就能挂载测试了.</span><br><span class="line"><span class="comment"># 开发板端 bash</span></span><br><span class="line">$ ls -l /dev/mtd*                               <span class="comment"># 查看一下分区情况, 有0-3共四个分区</span></span><br><span class="line"><span class="comment"># 应该是用 "flash_eraseall /dev/mtd1" 格式化 "params" 分区, 恢复起来最方便.</span></span><br><span class="line">$ flash_eraseall /dev/mtd3                      <span class="comment"># 格式化 root分区 (用的字符设备), 文件格式为yaffs</span></span><br><span class="line">$ mount -t yaffs /dev/mtdblock3 /tmp            <span class="comment"># 以yaffs格式挂载 root分区</span></span><br><span class="line">$ ls /tmp                                       <span class="comment"># 应该只有一个 lost+found 文件.</span></span><br><span class="line"><span class="comment"># 然后可以对这个分区进行文件创建, 读写的操作了.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6. 恢复原来的开发环境</span><br><span class="line"><span class="comment"># 开发板 uboot:</span></span><br><span class="line"><span class="comment"># 破坏了root区的话, 就恢复root区, 重新烧写文件系统到flash就行了. 猜测使用 params 区做测试是没有影响的.</span></span><br><span class="line"><span class="comment"># 烧录原来的 uImage 到 kernel.</span></span><br><span class="line"><span class="comment"># 改回 uboot 的 bootargs 参数</span></span><br><span class="line"><span class="comment"># 重启, 从NAND Flash正常启动.</span></span><br></pre></td></tr></table></figure>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="http://www.cnblogs.com/TaigaCon/archive/2012/11/17/2775057.html" target="_blank" rel="noopener">Linux操作系统下 NAND FLASH驱动程序框架</a></p>
<hr>
<p><strong><em>原创于 <a href="https://draapho.github.io/">DRA&amp;PHO</a></em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="draapho" />
          <p class="site-author-name" itemprop="name">draapho</p>
          <p class="site-description motion-element" itemprop="description">Embedded System, IoT, M2M</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">118</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://au.linkedin.com/in/kim-huanqing-yu-67424638" target="_blank" title="Linkedin">
                  
                    <i class="fa fa-fw fa-linkedin-square"></i>
                  
                  Linkedin
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">draapho</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = false;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = decodeURIComponent(data.url);
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title >= 0 || index_content >= 0 ){
                                isMatch = true;
								if (i == 0) {
                                    first_occur = index_content;
                                }
                            } 
							
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  


</body>
</html>
