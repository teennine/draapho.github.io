<!doctype html>




<html class="theme-next mist">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="总览 嵌入式linux学习目录 kernel之编译体验 kernel之Makefile分析 kernel之内核启动分析  本文使用 linux-2.6.22.6 内核, 使用jz2440开发板. 内核引导阶段 head.S由 uboot之源码分析 可知, uboot最后调用的函数是  theKernel (0, bd-&amp;gt;bi_arch_number, bd-&amp;gt;bi_boot_param">
<meta property="og:type" content="article">
<meta property="og:title" content="kernel之内核启动分析">
<meta property="og:url" content="https://draapho.github.io/2017/09/15/1725-kernel-launch/index.html">
<meta property="og:site_name" content="DRA&amp;PHO">
<meta property="og:description" content="总览 嵌入式linux学习目录 kernel之编译体验 kernel之Makefile分析 kernel之内核启动分析  本文使用 linux-2.6.22.6 内核, 使用jz2440开发板. 内核引导阶段 head.S由 uboot之源码分析 可知, uboot最后调用的函数是  theKernel (0, bd-&amp;gt;bi_arch_number, bd-&amp;gt;bi_boot_param">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://draapho.github.io/images/1725/stage1.JPG">
<meta property="og:image" content="https://draapho.github.io/images/1725/stage2.JPG">
<meta property="og:updated_time" content="2017-11-27T03:06:16.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kernel之内核启动分析">
<meta name="twitter:description" content="总览 嵌入式linux学习目录 kernel之编译体验 kernel之Makefile分析 kernel之内核启动分析  本文使用 linux-2.6.22.6 内核, 使用jz2440开发板. 内核引导阶段 head.S由 uboot之源码分析 可知, uboot最后调用的函数是  theKernel (0, bd-&amp;gt;bi_arch_number, bd-&amp;gt;bi_boot_param">
<meta name="twitter:image" content="https://draapho.github.io/images/1725/stage1.JPG">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="https://draapho.github.io/2017/09/15/1725-kernel-launch/"/>


  <title> kernel之内核启动分析 | DRA&PHO </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">DRA&PHO</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">thinking & logging</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                kernel之内核启动分析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2017-09-15T00:00:00+10:00" content="2017-09-15">
              2017-09-15
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><ul>
<li><a href="https://draapho.github.io/2017/11/23/1734-linux-content/">嵌入式linux学习目录</a></li>
<li><a href="https://draapho.github.io/2017/09/01/1722-kernel-compile/">kernel之编译体验</a></li>
<li><a href="https://draapho.github.io/2017/09/14/1724-kernel-makefile/">kernel之Makefile分析</a></li>
<li><a href="https://draapho.github.io/2017/09/15/1725-kernel-launch/">kernel之内核启动分析</a></li>
</ul>
<p>本文使用 linux-2.6.22.6 内核, 使用jz2440开发板.</p>
<h1 id="内核引导阶段-head-S"><a href="#内核引导阶段-head-S" class="headerlink" title="内核引导阶段 head.S"></a>内核引导阶段 <code>head.S</code></h1><p>由 <a href="https://draapho.github.io/2017/08/25/1720-uboot-source/">uboot之源码分析</a> 可知, uboot最后调用的函数是</p>
<ul>
<li><code>theKernel (0, bd-&gt;bi_arch_number, bd-&gt;bi_boot_params)</code>, 会把一些板级参数传递给linux内核使用.</li>
</ul>
<p>由 <a href="https://draapho.github.io/2017/09/14/1724-kernel-makefile/">kernel之Makefile分析</a> 可知, 两个重要的文件如下:</p>
<ul>
<li>第1个文件: <code>arch/arm/kernel/head.S</code></li>
<li>链接脚本: <code>arch/arm/kernel/vmlinux.lds</code></li>
</ul>
<p><code>head.S</code> 主要完成了如下工作.</p>
<p><img src="https://draapho.github.io/images/1725/stage1.JPG" alt="内核引导阶段"></p>
<ul>
<li><code>__lookup_machine_type</code> 会将 theKernel 传入的单板类型与内核支持的单板类型逐一比较.</li>
<li><code>.arch.info.init</code> 这一个段存放的就是内核支持的单板类型.<ul>
<li>定义在 <code>./arch/arm/kernel/vmlinux.lds</code></li>
<li><code>__lookup_machine_type</code> 会对该段进行轮询</li>
<li>该段的数据结构为 <code>machine_desc</code>, 定义在 <code>./include/asm-arm/mach/arch.h</code></li>
<li><code>arch.h</code> 文件还宏定义了 <code>MACHINE_START</code> <code>MACHINE_END</code>,<br>  调用该宏定义, 就会将相关数据放在 <code>.arch.info.init</code> 段内</li>
</ul>
</li>
<li><code>./arch/arm/mach-s3c2440/mach-smdk2440.c:</code> 内调用了 <code>MACHINE_START(S3C2440, &quot;SMDK2440&quot;)</code><ul>
<li>kernel下 <code>grep -nr MACH_TYPE_S3C2440</code> 可知 MACH_TYPE_S3C2440 的值为 362</li>
<li>uboot下 <code>grep -nr bi_arch_number</code> 可知其值为 MACH_TYPE_S3C2440, 即 362</li>
<li>这样, kernel就能确定是支持当前的开发板的. (当前的开发板信息由uboot提供给kernel)</li>
</ul>
</li>
</ul>
<h1 id="内核启动第二阶段-init-main-c"><a href="#内核启动第二阶段-init-main-c" class="headerlink" title="内核启动第二阶段 init/main.c"></a>内核启动第二阶段 <code>init/main.c</code></h1><p><code>head-common.S</code> 调用 <code>start_kernel</code> 后, 代码会转到 <code>init/main.c</code>, 使用的是C语言.</p>
<p><img src="https://draapho.github.io/images/1725/stage2.JPG" alt="内核启动第二阶段"></p>
<p>从 <code>start_kernel</code> 开始, 函数的基本调用关系如下:</p>
<ul>
<li><code>setup_arch(&amp;command_line);</code> 读取uboot传过来的TAG参数<ul>
<li>位于 <code>./arch/arm/kernel/setup.c</code> 770 行</li>
<li>uboot 的 <code>setup_memory_tags</code> 存放内存大小</li>
<li>uboot 的 <code>setup_commandline_tag</code> 告知linux挂载文件系统的命令行</li>
<li>uboot 的 <code>/board/100ask24x0/100ask24x0.c</code> 中, <code>gd-&gt;bd-&gt;bi_boot_params = 0x30000100</code></li>
<li>使用了 <code>machine_desc</code> 结构体, <code>.boot_params = S3C2410_SDRAM_PA + 0x100</code>, 其值就是 <code>0x30000100</code></li>
<li>至此, uboot存放在内存中的TAG参数, 就能被内核读取出来了.</li>
<li>此函数还会把挂载文件系统的命令赋值给 <code>boot_command_line</code>, 后续会去处理.</li>
<li><code>parse_cmdline</code> 会去处理放在 <code>early_param.init</code> 段的指令.</li>
</ul>
</li>
<li><code>parse_early_param</code>, 此函数会把 <code>boot_command_line</code>传递给<code>do_early_param</code>让其执行挂载文件系统的指令.<ul>
<li><code>do_early_param</code><ul>
<li>搜索 <code>.init.setup</code> 段, 调用有early标记的函数 (大多只是设置一下参数)</li>
</ul>
</li>
</ul>
</li>
<li><code>unknown_bootoption</code> (使用 parse_args 先检查参数后再执行该函数)<ul>
<li><code>obsolete_checksetup</code><ul>
<li>搜索 <code>.init.setup</code> 段, 调用非early标记的函数 (大多只是设置一下参数)</li>
</ul>
</li>
</ul>
</li>
<li><code>rest_init</code>, 去做剩余的初始化工作<ul>
<li><code>kernel_thread(kernel_init, NULL, CLONE_FS | CLONE_SIGHAND);</code> 首先就是创建一个线程来做初始化工作<ul>
<li><code>kernel_init</code> 会调用 <code>prepare_namespace</code><ul>
<li>在 <code>do_mounts.c</code> 文件下 <code>prepare_namespace</code> 调用 <code>mount_root</code></li>
<li>目的就是挂载文件系统.</li>
</ul>
</li>
<li>挂载完文件系统后, 调用 <code>init_post</code>, 尝试执行第一个应用程序(下述应用程序不会再返回)<ul>
<li><code>run_init_process(execute_command);</code></li>
<li><code>run_init_process(&quot;/sbin/init&quot;);</code></li>
<li><code>run_init_process(&quot;/etc/init&quot;);</code></li>
<li><code>run_init_process(&quot;/bin/init&quot;);</code></li>
<li><code>run_init_process(&quot;/bin/sh&quot;);</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>以默认的启动指令为例 <code>&quot;root=/dev/hda1 ro init=/bin/bash console=ttySAC0&quot;</code><pre><code>- `__setup(&quot;root=&quot;, root_dev_setup);` 位于 `./init/do_mounts.c`
- `__setup(&quot;init=&quot;, init_setup);` 位于 `./init/main.c`
- `__setup(&quot;console=&quot;, console_setup);` 位于 `./kernel/printk.c`
- 以上命令对应的函数都会由 `obsolete_checksetup` 函数来调用. 主要是设置好相关参数.
</code></pre></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./init/main.c</span></span><br><span class="line"></span><br><span class="line"><span class="number">497</span> asmlinkage <span class="keyword">void</span> __<span class="function">init <span class="title">start_kernel</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"><span class="number">520</span>     tick_init();</span><br><span class="line"><span class="number">521</span>     boot_cpu_init();</span><br><span class="line"><span class="number">522</span>     page_address_init();</span><br><span class="line"><span class="number">524</span>     printk(linux_banner);                           <span class="comment">// 打印linux版本信息</span></span><br><span class="line"><span class="number">525</span>     setup_arch(&amp;command_line);                      <span class="comment">// 读取uboot传过来的TAG参数</span></span><br><span class="line">                                                        <span class="comment">// 搜索 "early_param.init" 段, 并调用相关函数</span></span><br><span class="line"><span class="number">526</span>     setup_command_line(command_line);               <span class="comment">// 复制一下 command_line.</span></span><br><span class="line"></span><br><span class="line"><span class="number">544</span>     printk(KERN_NOTICE <span class="string">"Kernel command line: %s\n"</span>, boot_command_line); <span class="comment">// 打印文件系统挂载命令</span></span><br><span class="line"><span class="number">545</span>     parse_early_param();                            <span class="comment">// 最终会搜索 ".init.setup" 段, 调用有early标记的函数</span></span><br><span class="line"><span class="number">546</span>     parse_args(<span class="string">"Booting kernel"</span>, static_command_line, __start___param,</span><br><span class="line"><span class="number">547</span>        __stop___param - __start___param,            <span class="comment">// 搜索 "__param" 段</span></span><br><span class="line"><span class="number">548</span>        &amp;unknown_bootoption);                        <span class="comment">// 最终会搜索 ".init.setup" 段, 调用非early标记的函数</span></span><br><span class="line"></span><br><span class="line"><span class="number">575</span>     console_init();                                 <span class="comment">// 控制终端初始化</span></span><br><span class="line"></span><br><span class="line"><span class="number">636</span>     rest_init();                                    <span class="comment">// 剩余部分的初始化</span></span><br><span class="line"><span class="number">637</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">466</span> <span class="keyword">void</span> __<span class="function">init <span class="title">parse_early_param</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"><span class="number">475</span>     strlcpy(tmp_cmdline, boot_command_line, COMMAND_LINE_SIZE);</span><br><span class="line">        <span class="comment">// parse_args 会先检查参数, 最后调用函数, 此处是do_early_param,</span></span><br><span class="line">        <span class="comment">// 参数为 boot_command_line 启动命令, 由uboot传递进来. 实际不会在此处执行.</span></span><br><span class="line"><span class="number">476</span>     parse_args(<span class="string">"early options"</span>, tmp_cmdline, <span class="literal">NULL</span>, <span class="number">0</span>, do_early_param);</span><br><span class="line"><span class="number">478</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">450</span> <span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">do_early_param</span><span class="params">(<span class="keyword">char</span> *param, <span class="keyword">char</span> *val)</span> </span>&#123;</span><br><span class="line"><span class="number">454</span>     <span class="keyword">for</span> (p = __setup_start; p &lt; __setup_end; p++)   <span class="comment">// 遍历 ".init.setup" 段</span></span><br><span class="line"><span class="number">455</span>         <span class="keyword">if</span> (p-&gt;early &amp;&amp; <span class="built_in">strcmp</span>(param, p-&gt;str) == <span class="number">0</span>) <span class="comment">// 在段内找了匹配boot_command_line的命令, 则执行</span></span><br><span class="line"><span class="number">456</span>             <span class="keyword">if</span> (p-&gt;setup_func(val) != <span class="number">0</span>)</span><br><span class="line"><span class="number">463</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">258</span> <span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">unknown_bootoption</span><span class="params">(<span class="keyword">char</span> *param, <span class="keyword">char</span> *val)</span> </span>&#123;</span><br><span class="line"><span class="number">274</span>     <span class="keyword">if</span> (obsolete_checksetup(param))                 <span class="comment">// 调用 obsolete_checksetup</span></span><br><span class="line"><span class="number">313</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">190</span> <span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">obsolete_checksetup</span><span class="params">(<span class="keyword">char</span> *line)</span> </span>&#123;</span><br><span class="line"><span class="number">195</span>     p = __setup_start;                              <span class="comment">// 遍历 ".init.setup" 段</span></span><br><span class="line"><span class="number">196</span>     <span class="keyword">do</span> &#123;</span><br><span class="line"><span class="number">199</span>         <span class="keyword">if</span> (p-&gt;early) &#123;                             <span class="comment">// 有early标记, 跳过.</span></span><br><span class="line"><span class="number">210</span>         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p-&gt;setup_func(line + n))         <span class="comment">// 执行指令对应的函数</span></span><br><span class="line"><span class="number">214</span>     &#125; <span class="keyword">while</span> (p &lt; __setup_end);<span class="number">24</span></span><br><span class="line"><span class="number">217</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">426</span> <span class="keyword">static</span> <span class="keyword">void</span> noinline __<span class="function">init_refok <span class="title">rest_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">        kernel_thread(kernel_init, <span class="literal">NULL</span>, CLONE_FS | CLONE_SIGHAND); <span class="comment">// 创建一个初始化用的线程</span></span><br><span class="line">        schedule();                                     <span class="comment">// 调度</span></span><br><span class="line"><span class="number">447</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">787</span> <span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">kernel_init</span><span class="params">(<span class="keyword">void</span> * unused)</span> </span>&#123;</span><br><span class="line"><span class="number">828</span>         prepare_namespace();                        <span class="comment">// 调用 mount_root, 加载文件系统</span></span><br><span class="line"><span class="number">836</span>     init_post();                                    <span class="comment">// 执行应用程序</span></span><br><span class="line"><span class="number">838</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">748</span> <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> noinline <span class="title">init_post</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;               <span class="comment">// 执行应用程序</span></span><br><span class="line"><span class="number">756</span>     <span class="keyword">if</span> (sys_open((<span class="keyword">const</span> <span class="keyword">char</span> __user *) <span class="string">"/dev/console"</span>, O_RDWR, <span class="number">0</span>) &lt; <span class="number">0</span>)      </span><br><span class="line">                                                        <span class="comment">// 尝试打开终端设备, 文件0-&gt;printf</span></span><br><span class="line"><span class="number">757</span>         printk(KERN_WARNING <span class="string">"Warning: unable to open an initial console.\n"</span>);</span><br><span class="line"><span class="number">759</span>	    (<span class="keyword">void</span>) sys_dup(<span class="number">0</span>);                              <span class="comment">// 赋值文件0, 生成文件1-&gt;scanf</span></span><br><span class="line"><span class="number">760</span>	    (<span class="keyword">void</span>) sys_dup(<span class="number">0</span>);                              <span class="comment">// 赋值文件0, 生成文件2-&gt;err</span></span><br><span class="line">        <span class="comment">// 以上四句作用为设置标准输入输出流, (printf, scanf, err)</span></span><br><span class="line">        </span><br><span class="line"><span class="number">744</span> 	<span class="keyword">if</span> (execute_command) &#123;</span><br><span class="line"><span class="number">745</span>	    	run_init_process(execute_command);</span><br><span class="line"><span class="number">746</span>		    printk(KERN_WARNING <span class="string">"Failed to execute %s.  Attempting "</span></span><br><span class="line"><span class="number">747</span>					<span class="string">"defaults...\n"</span>, execute_command);</span><br><span class="line"><span class="number">748</span>  	&#125;</span><br><span class="line">        <span class="comment">// 传入的启动参数内有 "init=" 启动程序, 则执行! 执行成功的话不会再返回这里!</span></span><br><span class="line"></span><br><span class="line"><span class="number">779</span>     run_init_process(<span class="string">"/sbin/init"</span>);</span><br><span class="line"><span class="number">780</span>     run_init_process(<span class="string">"/etc/init"</span>);</span><br><span class="line"><span class="number">781</span>     run_init_process(<span class="string">"/bin/init"</span>);</span><br><span class="line"><span class="number">782</span>     run_init_process(<span class="string">"/bin/sh"</span>);</span><br><span class="line">        <span class="comment">// 没有配置过启动指令, 依次尝试上述四个默认程序. 某一个执行成功后就不会再返回!</span></span><br><span class="line">        </span><br><span class="line"><span class="number">784</span>     panic(<span class="string">"No init found.  Try passing init= option to kernel."</span>);</span><br><span class="line">        <span class="comment">// 执行首个应用程序失败, 打印内核错误信息!</span></span><br><span class="line"><span class="number">785</span> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 我们擦除开发板文件系统后, 来看一下打印出来的启动信息</span></span><br><span class="line"></span><br><span class="line">OpenJTAG&gt; nand erase root           <span class="comment"># uboot 下, 擦除root块</span></span><br><span class="line">OpenJTAG&gt; reset                     <span class="comment"># uboot 下, 重启系统</span></span><br><span class="line"></span><br><span class="line">Booting Linux ...</span><br><span class="line">NAND <span class="built_in">read</span>: device 0 offset 0x60000, size 0x200000</span><br><span class="line"><span class="comment">## Booting image at 30007fc0 ...</span></span><br><span class="line">...</span><br><span class="line">Starting kernel ...</span><br><span class="line">...</span><br><span class="line">Kernel <span class="built_in">command</span> line: noinitrd root=/dev/mtdblock3 init=/linuxrc console=ttySAC0</span><br><span class="line">loop: module loaded</span><br><span class="line">...</span><br><span class="line">Creating 4 MTD partitions on <span class="string">"NAND 256MiB 3,3V 8-bit"</span>:</span><br><span class="line">0x00000000-0x00040000 : <span class="string">"bootloader"</span></span><br><span class="line">0x00040000-0x00060000 : <span class="string">"params"</span></span><br><span class="line">0x00060000-0x00260000 : <span class="string">"kernel"</span></span><br><span class="line">0x00260000-0x10000000 : <span class="string">"root"</span></span><br><span class="line">...</span><br><span class="line">VFS: Mounted root (yaffs filesystem).</span><br><span class="line">...</span><br><span class="line">Kernel panic - not syncing: No init found.  Try passing init= option to kernel.</span><br><span class="line"><span class="comment"># 此句就是由./init/main.c文件784行打印出来的. 因为没有文件系统, 第一个应用程序执行失败!</span></span><br></pre></td></tr></table></figure>
<p>如果正常启动, 会打印如下信息, 可知第一个应用程序名字是 <code>BusyBox</code>, 然后启动了 <code>/bin/sh</code>!!!<br><code>init started: BusyBox v1.7.0 (2008-01-22 10:04:09 EST)</code><br><code>starting pid 764, tty &#39;&#39;: &#39;/etc/init.d/rcS&#39;</code><br><code>Please press Enter to activate this console.</code><br><code>starting pid 770, tty &#39;/dev/s3c2410_serial0&#39;: &#39;/bin/sh&#39;</code></p>
<h1 id="初始化中用到的段-vmlinux-lds"><a href="#初始化中用到的段-vmlinux-lds" class="headerlink" title="初始化中用到的段 vmlinux.lds"></a>初始化中用到的段 <code>vmlinux.lds</code></h1><h2 id="init-setup-段分析"><a href="#init-setup-段分析" class="headerlink" title=".init.setup 段分析"></a><code>.init.setup</code> 段分析</h2><p>在 <code>./arch/arm/kernel/vmlinux.lds</code> 中有这么一个段<br><code>*(.init.setup)</code>, 其头尾为 <code>__setup_start</code> <code>__setup_end</code></p>
<p>这一个段存放着需要通过读取命令行来执行的初始化工作, 内核称之为 <code>unknow_xxx</code><br>定义在此段的变量通过两个宏定义实现 <code>__setup</code> 以及 <code>early_param</code><br>简单理解的话, <code>early_param</code> 是需要先执行的命令行, <code>__setup</code> 则稍后执行.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># ./include/linux/init.h</span><br><span class="line"></span><br><span class="line"><span class="number">148</span> <span class="class"><span class="keyword">struct</span> <span class="title">obs_kernel_param</span> &#123;</span></span><br><span class="line"><span class="number">149</span>     <span class="keyword">const</span> <span class="keyword">char</span> *str;</span><br><span class="line"><span class="number">150</span>     <span class="keyword">int</span> (*setup_func)(<span class="keyword">char</span> *);</span><br><span class="line"><span class="number">151</span>     <span class="keyword">int</span> early;</span><br><span class="line"><span class="number">152</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="number">160</span> <span class="meta">#<span class="meta-keyword">define</span> __setup_param(str, unique_id, fn, early)            \</span></span><br><span class="line"><span class="number">161</span>     <span class="keyword">static</span> <span class="keyword">char</span> __setup_str_##unique_id[] __initdata = str; \</span><br><span class="line"><span class="number">162</span>     <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">obs_kernel_param</span> __<span class="title">setup_</span>##<span class="title">unique_id</span>  \</span></span><br><span class="line"><span class="class">163         __<span class="title">attribute_used__</span>              \</span></span><br><span class="line"><span class="class">164         __<span class="title">attribute__</span>((__<span class="title">section__</span>(".<span class="title">init</span>.<span class="title">setup</span>"))) \</span></span><br><span class="line"><span class="class">165         __<span class="title">attribute__</span>((<span class="title">aligned</span>((<span class="title">sizeof</span>(<span class="title">long</span>)))))    \</span></span><br><span class="line"><span class="class">166         = &#123;</span> __setup_str_##unique_id, fn, early &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">171</span> <span class="meta">#<span class="meta-keyword">define</span> __setup(str, fn)                    \</span></span><br><span class="line"><span class="number">172</span>     __setup_param(str, fn, fn, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">179</span> <span class="meta">#<span class="meta-keyword">define</span> early_param(str, fn)                    \</span></span><br><span class="line"><span class="number">180</span>     __setup_param(str, fn, fn, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>先来分析 <code>__setup(str, fn)</code> 这么一个宏定义, 它设置的就是命令行队列, 将字符串关联到函数.</p>
<ul>
<li><code>unique_id</code> 就是fn的函数地址</li>
<li>存放在 <code>.init.setup</code> 段内.</li>
<li>与数据结构 <code>obs_kernel_param</code> 相关. 保存的就是 str, fn, 以及early三个变量.</li>
<li>通过这样一种结构, 可以很方便的使用字符串来调用指定的函数.</li>
<li><code>grep -nwr __setup ./arch/arm</code> 可找到 <code>__setup(&quot;tft=&quot;, qt2410_tft_setup);</code>, 很明显就是用来初始化屏幕的.</li>
<li>在 <code>./init/do_mounts.c</code>里, 还能找到 <code>__setup(&quot;root=&quot;, root_dev_setup)</code>, 是用来挂载文件系统的.</li>
</ul>
<p>然后看 <code>early_param(str, fn)</code> 宏定义.</p>
<ul>
<li><code>__setup</code> 是一样的.</li>
<li>只是将标记 <code>early</code> 赋值为1. 表示需要较早执行的初始化工作, 一般为更底层的驱动</li>
<li>arm 架构几乎没有用到 <code>early_param</code> 的地方, 搜索的话, 可以看到 pci 的初始化就用到了 <code>early_param</code></li>
</ul>
<h2 id="early-param-init-段"><a href="#early-param-init-段" class="headerlink" title="early_param.init 段"></a><code>early_param.init</code> 段</h2><p>和 <code>.init.setup</code> 段类似, 其定义在<br><code>./include/asm-arm/setup.h</code>, 220行.<br>关联的宏定义为 <code>__early_param</code>, 初始化如 <code>initrd=</code> <code>mem=</code> 之类的命令<br><code>grep -nwr __early_param</code> 进行查询, 结果不多的.<br>搜索 <code>grep -nwr __early_begin</code>, 可知, 其处理函数为 <code>parse_cmdline</code></p>
<h2 id="param-段"><a href="#param-段" class="headerlink" title="__param 段"></a><code>__param</code> 段</h2><p>该段主要用于给驱动模块的初始化. 设置参数使用.<br>定义在 <code>./include/linux/moduleparam.h</code>, 72 行<br>其调用位于 <code>./init/main.c</code> 的 <code>parse_args</code> (<code>grep -nwr __start___param</code>)<br>关联的宏定义为 <code>module_param_call</code> <code>module_param_named</code> <code>module_param</code> 以及 <code>module_param_string</code><br>查阅后, 可以发现全部是和驱动模块有关的.</p>
<h1 id="linux下的分区"><a href="#linux下的分区" class="headerlink" title="linux下的分区"></a>linux下的分区</h1><p>jz2440的启动参数为 <code>root= /dev/mtdblock3</code>,<br>linux下没有分区表的概念, 这里分区是在内核源码里写死的.<br>可见 <code>./arch/arm/plat-s3c24xx/common-smdk.c</code> 的118行, <code>smdk_default_nand_part</code><br>它分配了4个的分区:</p>
<table>
<thead>
<tr>
<th>分区</th>
<th>对应mtdblock</th>
<th>size</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>bootloader</code></td>
<td>mtdblock0</td>
<td>0x00040000</td>
</tr>
<tr>
<td><code>params</code></td>
<td>mtdblock1</td>
<td>0x00020000</td>
</tr>
<tr>
<td><code>kernel</code></td>
<td>mtdblock2</td>
<td>0x00200000</td>
</tr>
<tr>
<td><code>root</code></td>
<td>mtdblock3</td>
<td>MTDPART_SIZ_FULL</td>
</tr>
</tbody>
</table>
<h1 id="更多参考"><a href="#更多参考" class="headerlink" title="更多参考"></a>更多参考</h1><ul>
<li><a href="http://blog.csdn.net/skyflying2012/article/details/41142801" target="_blank" rel="noopener"> linux kernel的cmdline参数解析原理分析</a></li>
<li><a href="https://danielmaker.github.io/blog/linux/inside_start_kernel.html" target="_blank" rel="noopener">深入淺出 start_kernel</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_5d9051c00100ij93.html" target="_blank" rel="noopener">嵌入式Linux中基于MTD的文件系统的结构框架图</a></li>
<li><a href="http://blog.csdn.net/yusiguyuan/article/details/9471577" target="_blank" rel="noopener">u-boot中分区和内核MTD分区关系</a></li>
</ul>
<hr>
<p><strong><em>原创于 <a href="https://draapho.github.io/">DRA&amp;PHO</a></em></strong></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/09/14/1724-kernel-makefile/" rel="next" title="kernel之Makefile分析">
                <i class="fa fa-chevron-left"></i> kernel之Makefile分析
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/09/19/1726-soft-easyre/" rel="prev" title="人人都看得懂的正则表达式教程">
                人人都看得懂的正则表达式教程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="draapho" />
          <p class="site-author-name" itemprop="name">draapho</p>
          <p class="site-description motion-element" itemprop="description">Embedded System, IoT, M2M</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">118</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://au.linkedin.com/in/kim-huanqing-yu-67424638" target="_blank" title="Linkedin">
                  
                    <i class="fa fa-fw fa-linkedin-square"></i>
                  
                  Linkedin
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#总览"><span class="nav-number">1.</span> <span class="nav-text">总览</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#内核引导阶段-head-S"><span class="nav-number">2.</span> <span class="nav-text">内核引导阶段 head.S</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#内核启动第二阶段-init-main-c"><span class="nav-number">3.</span> <span class="nav-text">内核启动第二阶段 init/main.c</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#初始化中用到的段-vmlinux-lds"><span class="nav-number">4.</span> <span class="nav-text">初始化中用到的段 vmlinux.lds</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#init-setup-段分析"><span class="nav-number">4.1.</span> <span class="nav-text">.init.setup 段分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#early-param-init-段"><span class="nav-number">4.2.</span> <span class="nav-text">early_param.init 段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#param-段"><span class="nav-number">4.3.</span> <span class="nav-text">__param 段</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#linux下的分区"><span class="nav-number">5.</span> <span class="nav-text">linux下的分区</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#更多参考"><span class="nav-number">6.</span> <span class="nav-text">更多参考</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">draapho</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = false;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = decodeURIComponent(data.url);
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title >= 0 || index_content >= 0 ){
                                isMatch = true;
								if (i == 0) {
                                    first_occur = index_content;
                                }
                            } 
							
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  


</body>
</html>
